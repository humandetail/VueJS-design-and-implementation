# æŒ‚è½½ä¸æ›´æ–°

## æŒ‚è½½å­èŠ‚ç‚¹å’Œå…ƒç´ çš„å±æ€§

ä¹‹å‰æåˆ°ï¼Œå½“ `vnode.children` çš„å€¼æ˜¯å­—ç¬¦ä¸²ç±»å‹æ—¶ï¼Œä¼šæŠŠå®ƒè®¾ç½®ä¸ºå…ƒç´ çš„æ–‡æœ¬å†…å®¹ã€‚ä¸€ä¸ªå…ƒç´ é™¤äº†å…·æœ‰æ–‡æœ¬å­èŠ‚ç‚¹å¤–ï¼Œè¿˜å¯ä»¥åŒ…å«å…¶ä»–å…ƒç´ çš„å­èŠ‚ç‚¹ï¼Œå¹¶ä¸”å­èŠ‚ç‚¹å¯ä»¥æ˜¯å¾ˆå¤šä¸ªã€‚ä¸ºäº†æè¿°å…ƒç´ çš„å­èŠ‚ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å°†  `vnode.children` å®šä¹‰ä¸ºæ•°ç»„ï¼š

```js
const vnode = {
  type: 'div',
  children: [
    {
      type: 'p',
      children: 'hello'
    }
  ]
}
```

`vnode.children` æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå®ƒçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹ŸèŠ‚ç‚¹å¯¹è±¡ã€‚è¿™æ ·å°±å½¢æˆäº†æ ‘å½¢ç»“æ„ï¼Œå³è™šæ‹Ÿ DOM æ ‘ã€‚

ä¸ºäº†å®Œæˆå­èŠ‚ç‚¹çš„æ¸²æŸ“ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ `mountElement()` å‡½æ•°ï¼š

```js
function mountElement (vnode, container) {
  // åˆ›å»º DOM å…ƒç´ 
  const el = createElement(vnode.type)

  // å¤„ç†å­èŠ‚ç‚¹ï¼Œå¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
  if (typeof vnode.children === 'string') {
    setElementText(el, vnode.children)
  } else if (Array.isArray(vnode.children)) {
    // å¦‚æœ children æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåˆ™éå†æ¯ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨ patch å‡½æ•°æŒ‚è½½å®ƒä»¬
    vnode.children.forEach(child => {
      patch(null, child, el)
    })
  }

  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  insert(el, container)
}
```

å®Œæˆäº†å­èŠ‚ç‚¹çš„æŒ‚è½½åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å¦‚ä½•ç”¨ vnode æ¥æè¿°ä¸€ä¸ªæ ‡ç­¾çš„å±æ€§ï¼Œä»¥åŠå¦‚ä½•æ¸²æŸ“è¿™äº›å±æ€§ã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒHTML æ ‡ç­¾æœ‰å¾ˆå¤šå±æ€§ï¼Œå…¶ä¸­æœ‰äº›å±æ€§æ˜¯é€šç”¨çš„ï¼Œä¾‹å¦‚ idã€class ç­‰ï¼Œè€Œæœ‰äº›å±æ€§æ˜¯ç‰¹å®šå…ƒç´ éƒ½æœ‰çš„ï¼Œä¾‹å¦‚ form å…ƒç´ çš„ action å±æ€§ã€‚å®é™…ä¸Šï¼Œæ¸²æŸ“ä¸€ä¸ªå…ƒç´ çš„å±æ€§æ¯”æƒ³è±¡ä¸­è¦å¤æ‚ï¼Œä¸è¿‡æˆ‘ä»¬ä»ç„¶ç§‰æ‰¿ä¸€åˆ‡ä»ç®€çš„åŸåˆ™ï¼Œå…ˆæ¥çœ‹çœ‹æœ€åŸºæœ¬çš„å±æ€§å¤„ç†ã€‚

ä¸ºäº†æè¿°å…ƒç´ çš„å±æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºè™šæ‹Ÿ DOM å®šä¹‰æ–°çš„ `vnode.props` å­—æ®µï¼š

```js
const vnode = {
  type: 'div',
  // ä½¿ç”¨ props æè¿°ä¸€ä¸ªå…ƒç´ çš„å±æ€§
  props: {
    id: 'foo'
  },
  children: [
    {
      type: 'p',
      children: 'hello'
    }
  ]
}
```

`vnode.props` æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„é”®ä»£è¡¨å…ƒç´ çš„å±æ€§åç§°ï¼Œå®ƒçš„å€¼ä»£è¡¨å¯¹åº”å±æ€§çš„å€¼ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡éå† props å¯¹è±¡çš„æ–¹æ³•ï¼ŒæŠŠè¿™äº›å±æ€§æ¸²æŸ“åˆ°å¯¹åº”çš„å…ƒç´ ä¸Šï¼š

```js
function mountElement (vnode, container) {
    // åˆ›å»º DOM å…ƒç´ 
    const el = createElement(vnode.type)

    // å¤„ç†å­èŠ‚ç‚¹ï¼Œå¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
    if (typeof vnode.children === 'string') {
      setElementText(el, vnode.children)
    } else if (Array.isArray(vnode.children)) {
      // å¦‚æœ children æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåˆ™éå†æ¯ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨ patch å‡½æ•°æŒ‚è½½å®ƒä»¬
      vnode.children.forEach(child => {
        patch(null, child, el)
      })
    }

    // å¦‚æœ vnode.props å­˜åœ¨ï¼Œåˆ™å¤„ç†
    if (vnode.props) {
      // éå† vnode.propsï¼Œå¹¶å°†å±æ€§è®¾ç½®åˆ°å…ƒç´ ä¸Š
      for (const key in vnode.props) {
        // el.setAttribute(key, vnode.props[key])
        el[key] = vnode.props[key]
      }
    }

    // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
    insert(el, container)
  }
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç»™å‡ºäº†ä¸¤ç§ä¸ºå…ƒç´ è®¾ç½®å±æ€§æ–¹æ¡ˆï¼š`el.setAttribute(key, vnode.props[key])` å’Œ `el[key] = vnode.props[key]`ã€‚å®é™…ä¸Šï¼Œè¿™ä¸¤ç§æ–¹æ¡ˆéƒ½å­˜åœ¨ç¼ºé™·ã€‚å¦‚å‰æ–‡æ‰€è¿°ï¼Œä¸ºå…ƒç´ è®¾ç½®å±æ€§æ¯”æƒ³è±¡ä¸­è¦å¤æ‚å¾ˆå¤šã€‚åœ¨è®¨è®ºç¼ºé™·ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆææ¸…æ¥šä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š**HTML Attributes** å’Œ **DOM Properties**ã€‚

## HTML Attributes ä¸ DOM Properties

ç†è§£è¿™ä¸¤è€…çš„å·®å¼‚å’Œå…³è”éå¸¸é‡è¦ï¼Œè¿™èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬åˆç†åœ°è®¾è®¡è™šæ‹ŸèŠ‚ç‚¹çš„ç»“æ„ï¼Œæ›´æ˜¯æ­£ç¡®åœ°ä¸ºå…ƒç´ è®¾ç½®å±æ€§çš„å…³é”®ã€‚

æˆ‘ä»¬å…ˆä»æœ€åŸºæœ¬çš„ HTML è¯´èµ·ï¼š

```html
<input id="my-input" type="text" value="foo" />
```

HTML Attributes æŒ‡çš„å°±æ˜¯å®šä¹‰åœ¨ HTML æ ‡ç­¾ä¸Šçš„å±æ€§ï¼Œè¿™é‡ŒæŒ‡çš„å°±æ˜¯ `id="my-input"`ã€`type="text"` å’Œ `value="foo"`ã€‚å½“æµè§ˆå™¨è§£æè¿™æ®µ HTML ä»£ç åï¼Œä¼šåˆ›å»ºä¸€ä¸ªä¸ä¹‹ç›¸ç¬¦çš„ DOM å…ƒç´ å¯¹è±¡ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ JavaScript ä»£ç æ¥è¯»å–è¯¥ DOM å¯¹è±¡ï¼š

```js
const el = document.querySelector('#my-input')
```

è¿™ä¸ªå¯¹è±¡åŒ…å«å¾ˆå¤š**å±æ€§ï¼ˆpropertiesï¼‰**ï¼Œå¦‚å›¾ï¼š

![DOM properties](../imgs/DOM properties.png)

è¿™äº›å±æ€§å°±æ˜¯æ‰€è°“çš„ DOM Propertiesã€‚å¾ˆå¤š HTML Attributes åœ¨ DOM å¯¹è±¡ä¸Šæœ‰ä¸ä¹‹åŒåçš„ DOM Propertiesï¼Œä¾‹å¦‚ `id="my-input"` å¯¹åº” `el.id`ï¼Œ`type="text"` å¯¹åº” `el.type`ï¼Œ`value="foo"` å¯¹åº” `el.value` ç­‰ã€‚ä½† DOM Properties ä¸ HTML Attributes çš„åå­—å¹¶ä¸æ€»æ˜¯ä¸€æ ·çš„ï¼Œä¾‹å¦‚ï¼š

```html
<div class="foo"></div>
```

`class="foo"` å¯¹åº”çš„ DOM Properties åˆ™æ˜¯ `el.className`ã€‚å¦å¤–ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ HTML Attributes éƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„ DOM Propertiesï¼Œä¾‹å¦‚ï¼š

```html
<div aria-valuenow="75"></div>
```

`aria-*` ç±»çš„ HTML Attributes å°±æ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„ DOM Propertiesã€‚

ç±»ä¼¼åœ°ï¼Œä¹Ÿä¸æ˜¯æ‰€æœ‰çš„ DOM Properties éƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„ HTML Attributesï¼Œä¾‹å¦‚å¯ä»¥ç”¨ `el.textContent` æ¥è®¾ç½®å…ƒç´ çš„æ–‡æœ¬å†…å®¹ï¼Œä½†å¹¶æ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„ HTML Attributes æ¥å®ŒæˆåŒæ ·å·¥ä½œã€‚

HTML Attributes ä¸ DOM Properties çš„å€¼ä¹‹é—´æ˜¯æœ‰å…³è”çš„ï¼Œä¾‹å¦‚ä¸‹é¢çš„ HTML ç‰‡æ®µï¼š

```html
<div id="foo"></div>
```

è¿™ä¸ªç‰‡æ®µæè¿°äº†ä¸€ä¸ªå…·æœ‰ id å±æ€§çš„ div æ ‡ç­¾ã€‚å…¶ä¸­ï¼Œ`id="foo"` å¯¹åº”çš„ DOM Properties æ˜¯ `el.id`ï¼Œå¹¶ä¸”å€¼ä¸ºå­—ç¬¦ä¸² `'foo'`ã€‚æˆ‘ä»¬æŠŠè¿™ç§ HTML Attributes ä¸ DOM Properties å…·æœ‰ç›¸åŒåç§°ï¼ˆå³ idï¼‰çš„å±æ€§å€¼çœ‹ä½œ**ç›´æ¥æ˜ å°„**ã€‚ä½†å¹¶ä¸æ˜¯æ‰€æœ‰ HTML Attributes ä¸ DOM Properties ä¹‹é—´éƒ½æ˜¯ç›´æ¥æ˜ å°„å…³ç³»ï¼Œä¾‹å¦‚ï¼š

```html
<input value="foo" />
```

è¿™æ˜¯ä¸€ä¸ªå…·æœ‰ value å±æ€§çš„ input æ ‡ç­¾ã€‚å¦‚æœç”¨æˆ·æ²¡æœ‰ä¿®æ”¹æ–‡æœ¬æ¡†çš„å†…å®¹ï¼Œé‚£ä¹ˆé€šè¿‡ `el.value` è¯»å–å¯¹åº”çš„ DOM Properties çš„å€¼å°±æ˜¯ `'foo'`ã€‚è€Œå¦‚æœç”¨æˆ·ä¿®æ”¹äº†æ–‡æœ¬æ¡†çš„å€¼ï¼Œé‚£ä¹ˆ `el.value` å°±æ˜¯ä¿®æ”¹åçš„å€¼ã€‚

ä¾‹å¦‚ï¼Œç”¨æˆ·å°†æ–‡æœ¬æ¡†çš„å†…å®¹ä¿®æ”¹ä¸º `'bar'`ï¼Œé‚£ä¹ˆï¼š

```js
console.log(el.value) // 'bar'
```

ä½†å¦‚æœè¿è¡Œä¸‹é¢çš„ä»£ç ï¼Œä¼šå‘ç”Ÿâ€œå¥‡æ€ªâ€çš„ç°è±¡ï¼š

```js
console.log(el.getAttribute('value')) // 'foo'
console.log(el.value) // 'bar'
```

å¯ä»¥å‘ç°ï¼Œç”¨æˆ·å¯¹æ–‡æœ¬æ¡†çš„ä¿®æ”¹å¹¶ä¸ä¼šå½±å“ `el.getAttribute('value')` çš„è¿”å›å€¼ï¼Œè¿™ä¸ªç°è±¡è•´å«ç€ HTML Attributes æ‰€ä»£è¡¨çš„æ„ä¹‰ã€‚å®é™…ä¸Šï¼ŒHTML Attributes çš„ä½œç”¨æ˜¯è®¾ç½®ä¸ä¹‹å¯¹åº”çš„ DOM Properties çš„åˆå§‹å€¼ã€‚ä¸€æ—¦å€¼æ”¹å˜ï¼Œé‚£ä¹ˆ DOM Properties å§‹ç»ˆå­˜å‚¨ç€å½“å‰å€¼ï¼Œè€Œé€šè¿‡ `getAttribute()` å‡½æ•°å¾—åˆ°çš„ä»ç„¶æ˜¯åˆå§‹å€¼ã€‚

ä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡ `el.defaultValue` æ¥è®¿é—®åˆå§‹å€¼ï¼š

```js
console.log(el.getAttribute('value')) // 'foo'
console.log(el.value) // 'bar'
console.log(el.defaultValue) // 'foo'
```

è¿™è¯´æ˜ä¸€ä¸ª HTML Attributes å¯èƒ½å…³è”å¤šä¸ª DOM Propertiesã€‚ä¾‹å¦‚ï¼Œä¸Šä¾‹ä¸­ï¼Œ`value="foo"` å°±å…³è”ç€ `el.value` å’Œ `el.defaultValue`ã€‚

è™½ç„¶æˆ‘ä»¬å¯ä»¥è®¤ä¸º HTML Attributes æ˜¯ç”¨æ¥è®¾ç½®ä¸ä¹‹å¯¹åº”çš„ DOM Properties çš„åˆå§‹å€¼ï¼Œä½†æœ‰äº›å€¼æ˜¯å—é™åˆ¶çš„ï¼Œå°±å¥½åƒæµè§ˆå™¨å†…éƒ¨åšäº†é»˜è®¤å€¼æ ¡éªŒã€‚å¦‚æœä½ é€šè¿‡ HTML Attributes è®¾ç½®çš„é»˜è®¤å€¼ä¸åˆæ³•ï¼Œé‚£ä¹ˆæµè§ˆå™¨ä¼šä½¿ç”¨å†…å»ºçš„åˆæ³•å€¼ä½œä¸ºå¯¹åº” DOM Properties çš„é»˜è®¤å€¼ï¼Œä¾‹å¦‚ï¼š

```html
<input type="foo" />
```

æˆ‘ä»¬çŸ¥é“ï¼Œä¸º `<input />` æ ‡ç­¾çš„ type å±æ€§æŒ‡å®šå­—ç¬¦ä¸² `'foo'` æ˜¯ä¸åˆæ³•ï¼Œå› æ­¤æµè§ˆå™¨ä¼šçŸ«æ­£è¿™ä¸ªå€¼ï¼š

```js
console.log(el.type) // 'text'
```

ä»ä¸Šè¿°çš„åˆ†ææ¥çœ‹ï¼ŒHTML Attributes ä¸ DOM Properties ä¹‹é—´çš„å…³ç³»å¾ˆå¤æ‚ï¼Œä½†å…¶å®æˆ‘ä»¬åªè¦è®°ä½ä¸€ä¸ªæ ¸å¿ƒåŸåˆ™å³å¯ï¼š**HTML Attributes çš„ä½œç”¨æ˜¯è®¾ç½®ä¸ä¹‹å¯¹åº”çš„ DOM Properties çš„åˆå§‹å€¼ã€‚**

## æ­£ç¡®åœ°è®¾ç½®å…ƒç´ å±æ€§

å¯¹äºæ™®é€šçš„ HTML æ–‡ä»¶æ¥è¯´ï¼Œæµè§ˆå™¨è§£æ HTML ä»£ç åï¼Œä¼šè‡ªåŠ¨åˆ†æ HTML Attributes å¹¶è®¾ç½®åˆé€‚çš„ DOM Propertiesã€‚ä½†ç”¨æˆ·åœ¨ç¼–å†™ Vue.js çš„å•æ–‡ä»¶ç»„ä»¶çš„æ¨¡æ¿ä¸ä¼šè¢«æµè§ˆå™¨è§£æï¼Œè¿™æ„å‘³ç€ï¼ŒåŸæœ¬éœ€è¦æµè§ˆå™¨æ¥å®Œæˆçš„å·¥ä½œï¼Œç°åœ¨éœ€è¦æ¡†æ¶æ¥å®Œæˆã€‚

æˆ‘ä»¬ä»¥ç¦ç”¨çš„æŒ‰é’®ä¸ºä¾‹ï¼š

```html
<button disabled>Button</button>
```

æµè§ˆå™¨åœ¨è§£æè¿™æ®µ HTML ä»£ç æ—¶ï¼Œä¼šå°†è¯¥æŒ‰é’®è®¾ç½®ä¸ºç¦ç”¨çŠ¶æ€ï¼Œå¹¶å°†å®ƒçš„ `el.disabled` è¿™ä¸ª DOM Properties çš„å€¼è®¾ç½®ä¸º `true`ã€‚ä½†åŒæ ·çš„ä»£ç å¦‚æœå‡ºç°åœ¨ Vue.js çš„æ¨¡æ¿ä¸­ï¼Œåˆ™æƒ…å†µä¼šæœ‰æ‰€ä¸åŒã€‚é¦–å…ˆï¼Œè¿™ä¸ª HTML æ¨¡æ¿ä¼šè¢«ç¼–è¯‘æˆ vnodeï¼Œå®ƒç­‰ä»·äºï¼š

```js
const vnode = {
  type: 'button',
  props: {
    disabled: ''
  },
  children: 'Button'
}
```

æ³¨æ„ï¼Œè¿™é‡Œçš„ `props.disabled` çš„å€¼æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œå¦‚æœåœ¨æ¸²æŸ“å™¨ä¸­è°ƒç”¨ `setAttribute()` å‡½æ•°è®¾ç½®å±æ€§ï¼Œåˆ™ç›¸å½“äºï¼š

```js
el.setAttribute('disabled', '')
```

è¿™ä¹ˆåšçš„ç¡®æ²¡é—®é¢˜ï¼Œæµè§ˆå™¨ä¼šå°†æŒ‰é’®ç¦ç”¨ã€‚

ä½†è€ƒè™‘å¦‚ä¸‹æ¨¡æ¿ï¼š

```vue
<button :disabled="false">Button</button>
```

å®ƒå¯¹åº”çš„ vnode ä¸ºï¼š

```js
const vnode = {
  type: 'button',
  props: {
    disabled: false
  },
  children: 'Button'
}
```

ç”¨æˆ·çš„æœ¬æ„æ˜¯ â€œä¸ç¦ç”¨â€ æŒ‰é’®ï¼Œä½†å¦‚æœæ¸²æŸ“å™¨ä»ç„¶ä½¿ç”¨ `setAttribute()` å‡½æ•°è®¾ç½®å€¼ï¼Œåˆ™ä¼šäº§ç”Ÿæ„å¤–çš„æ•ˆæœï¼ŒæŒ‰é’®è¢«ç¦ç”¨äº†ï¼š

```js
el.setAttribute('disabled', false)
```

åœ¨æµè§ˆå™¨ä¸­è¿è¡Œè¿™æ®µä»£ç ï¼Œæˆ‘ä»¬å‘ç°æµè§ˆå™¨ä»ç„¶æŠŠæŒ‰é’®ç¦ç”¨äº†ã€‚è¿™æ˜¯å› ä¸º `setAttribute()` å‡½æ•°è®¾ç½®çš„å€¼æ€»æ˜¯ä¼šè¢«å­—ç¬¦ä¸²åŒ–ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä»£ç ç›¸å½“äºï¼š

```js
el.setAttribute('disabled', 'false')
```

å¯¹äºæŒ‰é’®æ¥è¯´ï¼Œå®ƒçš„ `el.disabled` å±æ€§å€¼æ˜¯å¸ƒå°”ç±»å‹çš„ï¼Œå¹¶ä¸”å®ƒä¸å…³å¿ƒå…·ä½“çš„ HTML Attributes çš„å€¼æ˜¯ä»€ä¹ˆï¼Œåªè¦ `disabled` å±æ€§å­˜åœ¨ï¼ŒæŒ‰é’®å°±ä¼šè¢«ç¦ç”¨ã€‚

æ‰€ä»¥æˆ‘ä»¬å‘ç°ï¼Œæ¸²æŸ“å™¨ä¸åº”è¯¥ç”¨ `setAttribute()` å‡½æ•°å°† `vnode.props` å¯¹è±¡ä¸­çš„å±æ€§è®¾ç½®åˆ°å…ƒç´ ä¸Šã€‚é‚£ä¹ˆåº”è¯¥æ€ä¹ˆåŠï¼Ÿä¸€ä¸ªå¾ˆè‡ªç„¶çš„æ€è·¯æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¼˜å…ˆè®¾ç½® DOM Propertiesï¼š

```js
el.disabled = false
```

è¿™æ ·æ˜¯å¯ä»¥æ­£ç¡®å·¥ä½œçš„ï¼Œä½†åˆå¸¦æ¥äº†æ–°çš„é—®é¢˜ã€‚è¿˜æ˜¯ä»¥ä¸Šé¢çš„æ¨¡æ¿ä¸ºä¾‹ï¼š

```html
<button disabled>Button</button>
```

å®ƒå¯¹åº”çš„ vnode æ˜¯ï¼š

```js
const vnode = {
  type: 'button',
  props: {
    disabled: ''
  },
  children: 'Button'
}
```

å¦‚æœç›´æ¥ç”¨å®ƒè®¾ç½®å…ƒç´ çš„ DOM Propertiesï¼Œé‚£ä¹ˆç›¸å½“äºï¼š

```js
el.disabled = ''
```

å› ä¸º `el.disabled` æ˜¯ä¸€ä¸ªå¸ƒå°”ç±»å‹çš„å€¼ï¼Œæ‰€ä»¥è¿™å¥ä»£ç ç›¸å½“äºï¼š

```js
el.disabled = false
```

è¿™è¿èƒŒäº†ç”¨æˆ·çš„æœ¬æ„ï¼Œå› ä¸ºç”¨æˆ·å¸Œæœ›ç¦ç”¨æŒ‰é’® ï¼Œè€Œ `el.disabled = false` åˆ™æ˜¯ä¸ç¦ç”¨ã€‚

è¿™ä¹ˆçœ‹æ¥ï¼Œæ— è®ºæ˜¯ä½¿ç”¨ `setAttribute()` å‡½æ•°ï¼Œè¿˜æ˜¯ç›´æ¥è®¾ç½® DOM Propertiesï¼Œéƒ½æœ‰ç¼ºé™·ã€‚è¦å½»åº•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åªèƒ½åšç‰¹æ®Šå¤„ç†ï¼Œå³ä¼˜å…ˆè®¾ç½®å…ƒç´ çš„ DOM Propertiesï¼Œä½†å½“å€¼ä¸ºç©ºå­—ç¬¦ä¸²æ—¶ï¼Œè¦æ‰‹åŠ¨å°†å€¼çŸ«æ­£ä¸º trueã€‚åªæœ‰è¿™æ ·ï¼Œæ‰èƒ½ä¿è¯ä»£ç çš„è¡Œä¸ºç¬¦åˆé¢„æœŸã€‚ä¸‹é¢ç»™å‡º `mountElement()` å‡½æ•°ç»™å‡ºäº†å…·ä½“çš„å®ç°ï¼š

```js
function mountElement (vnode, container) {
    // åˆ›å»º DOM å…ƒç´ 
    const el = createElement(vnode.type)

    // å¤„ç†å­èŠ‚ç‚¹ï¼Œå¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
    if (typeof vnode.children === 'string') {
      setElementText(el, vnode.children)
    } else if (Array.isArray(vnode.children)) {
      // å¦‚æœ children æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåˆ™éå†æ¯ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨ patch å‡½æ•°æŒ‚è½½å®ƒä»¬
      vnode.children.forEach(child => {
        patch(null, child, el)
      })
    }

    // å¦‚æœ vnode.props å­˜åœ¨ï¼Œåˆ™å¤„ç†
    if (vnode.props) {
      // éå† vnode.propsï¼Œå¹¶å°†å±æ€§è®¾ç½®åˆ°å…ƒç´ ä¸Š
      for (const key in vnode.props) {
        // ç”¨ in æ“ä½œç¬¦åˆ¤æ–­ key æ˜¯å¦åœ¨å¯¹åº”çš„ DOM Properties
        if (key in el) {
          // è·å–è¯¥ DOM Properties çš„ç±»å‹
          const type = typeof el[key]
          const value = vnode.props[key]

          // å¦‚æœæ˜¯å¸ƒå°”ç±»å‹ï¼Œå¹¶ä¸”å€¼æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œåˆ™å°†å€¼çŸ«æ­£ä¸º true
          if (type === 'boolean' && value === '') {
            el[key] = true
          } else {
            el[key] = value
          }
        } else {
          // å¦‚æœè¦è®¾ç½®çš„å±æ€§æ²¡æœ‰å¯¹åº”çš„ DOM Propertiesï¼Œåˆ™ä½¿ç”¨ setAttribute å‡½æ•°è®¾ç½®å±æ€§
          el.setAttribute(key, vnode.props[key])
        }
      }
    }

    // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
    insert(el, container)
  }
```

ä½†ä¸Šé¢ç»™å‡ºçš„å®ç°ä»ç„¶å­˜åœ¨é—®é¢˜ï¼Œå› æ­¤æœ‰ä¸€äº› DOM Properties æ˜¯åªè¯»çš„ï¼š

```html
<form id="form1"></form>
<input form="form1" />
```

`el.form` æ˜¯åªè¯»çš„ï¼Œå› æ­¤æˆ‘ä»¬åªèƒ½å¤Ÿé€šè¿‡ `setAttribute()` å‡½æ•°æ¥è®¾ç½®å®ƒï¼š

```js
function shouldSetAsProps (el, key, value) {
  // ç‰¹æ®Šå¤„ç†
  if (key === 'form' && el.tagName === 'INPUT') return false
  // å…œåº•
  return key in el
}

function mountElement (vnode, container) {
  // åˆ›å»º DOM å…ƒç´ 
  const el = createElement(vnode.type)

  // å¤„ç†å­èŠ‚ç‚¹ï¼Œå¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
  if (typeof vnode.children === 'string') {
    setElementText(el, vnode.children)
  } else if (Array.isArray(vnode.children)) {
    // å¦‚æœ children æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåˆ™éå†æ¯ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨ patch å‡½æ•°æŒ‚è½½å®ƒä»¬
    vnode.children.forEach(child => {
      patch(null, child, el)
    })
  }

  // å¦‚æœ vnode.props å­˜åœ¨ï¼Œåˆ™å¤„ç†
  if (vnode.props) {
    // éå† vnode.propsï¼Œå¹¶å°†å±æ€§è®¾ç½®åˆ°å…ƒç´ ä¸Š
    for (const key in vnode.props) {
      const value = vnode.props[key]
      // ä½¿ç”¨ shouldSetAsProps å‡½æ•°åˆ¤æ–­æ˜¯å¦åº”è¯¥ä½œä¸º DOM Properties è®¾ç½®
      if (shouldSetAsProps(el, key, value)) {
        // è·å–è¯¥ DOM Properties çš„ç±»å‹
        const type = typeof el[key]

        // å¦‚æœæ˜¯å¸ƒå°”ç±»å‹ï¼Œå¹¶ä¸”å€¼æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œåˆ™å°†å€¼çŸ«æ­£ä¸º true
        if (type === 'boolean' && value === '') {
          el[key] = true
        } else {
          el[key] = value
        }
      } else {
        // å¦‚æœè¦è®¾ç½®çš„å±æ€§æ²¡æœ‰å¯¹åº”çš„ DOM Propertiesï¼Œåˆ™ä½¿ç”¨ setAttribute å‡½æ•°è®¾ç½®å±æ€§
        el.setAttribute(key, vnode.props[key])
      }
    }
  }

  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  insert(el, container)
}
```

å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬æå–äº†ä¸€ä¸ª `shouldSetAsProps()` å‡½æ•°ï¼Œç”¨äºåˆ¤æ–­å±æ€§æ˜¯å¦åº”è¯¥ä½œä¸º DOM Properties æ¥è®¾ç½®ã€‚åœ¨è¯¥å‡½æ•°å†…ï¼Œæˆ‘ä»¬å¯¹ `<input form="xxx" />` è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚å®é™…ä¸Šï¼Œä¸ä»…ä»…æ˜¯ `<input />` æ ‡ç­¾ï¼Œæ‰€æœ‰è¡¨å•å…ƒç´ éƒ½å…·æœ‰ `form` å±æ€§ï¼Œå®ƒä»¬éƒ½åº”è¯¥ä½œä¸º HTML Attributes æ¥è®¾ç½®ã€‚

å½“ç„¶ï¼Œ`<input form="xxx" />` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ä¾‹å­ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–ç±»ä¼¼äºè¿™ç§éœ€è¦ç‰¹æ®Šå¤„ç†çš„æƒ…å†µã€‚æˆ‘ä»¬å°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ï¼Œå› ä¸ºæŒæ¡å¤„ç†é—®é¢˜çš„æ€è·¯æ›´åŠ é‡è¦ã€‚å¦å¤–ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¯èƒ½æŠŠæ‰€æœ‰éœ€è¦ç‰¹æ®Šå¤„ç†çš„åœ°æ–¹éƒ½è®°ä½ï¼Œæ›´ä½•å†µæˆ‘ä»¬æ ¹æœ¬ä¸çŸ¥é“åœ¨ä»€ä¹ˆæƒ…å†µä¸‹æ‰éœ€è¦ç‰¹æ®Šå¤„ç†ã€‚æ‰€ä»¥ï¼Œä¸Šè¿°çš„è§£å†³æ–¹æ¡ˆæœ¬è´¨æ˜¯ç»éªŒä¹‹è°ˆã€‚ä¸è¦æƒ§æ€•å†™å‡ºä¸å®Œç¾çš„ä»£ç ï¼Œåªè¦åœ¨åç»­è¿­ä»£ä¸­â€œè§æ‹›æ‹†æ‹›â€ï¼Œä»£ç å°±ä¼šå˜å¾—è¶Šæ¥è¶Šå®Œå–„ï¼Œæ¡†æ¶ä¹Ÿä¼šå˜å¾—è¶Šæ¥è¶Šå¥å£®ã€‚

æœ€åæˆ‘ä»¬éœ€è¦æŠŠå±æ€§çš„è®¾ç½®ä¹ŸæŠ½è±¡å‡ºæ¥ï¼š

```js
const renderer = createRenderer({
  // ç”¨äºåˆ›å»ºå…ƒç´ 
  createElement(tag) {
    return document.createElement(tag)
  },
  // ç”¨äºè®¾ç½®å…ƒç´ çš„æ–‡æœ¬èŠ‚ç‚¹
  setElementText (el, text) {
    el.textContent = text
  },
  // ç”¨äºåœ¨ç»™å®šçš„ parent ä¸‹æ·»åŠ æŒ‡å®šå…ƒç´ 
  insert (el, parent, anchor = null) {
    parent.insertBefore(el, anchor)
  },
  // å°†å±æ€§è®¾ç½®ç›¸å…³çš„æ“ä½œå°è£…åˆ° patchProps å‡½æ•°ä¸­ï¼Œå¹¶ä½œä¸ºæ¸²æŸ“å™¨é€‰é¡¹ä¼ é€’
  patchProps (el, key, prevValue, nextValue, shouldSetAsProps) {
    // ä½¿ç”¨ shouldSetAsProps å‡½æ•°åˆ¤æ–­æ˜¯å¦åº”è¯¥ä½œä¸º DOM Properties è®¾ç½®
    if (shouldSetAsProps(el, key, nextValue)) {
      // è·å–è¯¥ DOM Properties çš„ç±»å‹
      const type = typeof el[key]

      // å¦‚æœæ˜¯å¸ƒå°”ç±»å‹ï¼Œå¹¶ä¸”å€¼æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œåˆ™å°†å€¼çŸ«æ­£ä¸º true
      if (type === 'boolean' && nextValue === '') {
        el[key] = true
      } else {
        el[key] = nextValue
      }
    } else {
      // å¦‚æœè¦è®¾ç½®çš„å±æ€§æ²¡æœ‰å¯¹åº”çš„ DOM Propertiesï¼Œåˆ™ä½¿ç”¨ setAttribute å‡½æ•°è®¾ç½®å±æ€§
      el.setAttribute(key, nextValue)
    }
  }
})
```

è€Œåœ¨ `mountElement()` å‡½æ•°ä¸­ï¼Œåªéœ€è¦è°ƒç”¨ `patchProps()` å‡½æ•°å³å¯ï¼š

```js
function mountElement (vnode, container) {
    // åˆ›å»º DOM å…ƒç´ 
    const el = createElement(vnode.type)

    // å¤„ç†å­èŠ‚ç‚¹ï¼Œå¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
    if (typeof vnode.children === 'string') {
      setElementText(el, vnode.children)
    } else if (Array.isArray(vnode.children)) {
      // å¦‚æœ children æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåˆ™éå†æ¯ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨ patch å‡½æ•°æŒ‚è½½å®ƒä»¬
      vnode.children.forEach(child => {
        patch(null, child, el)
      })
    }

    // å¦‚æœ vnode.props å­˜åœ¨ï¼Œåˆ™å¤„ç†
    if (vnode.props) {
      // éå† vnode.propsï¼Œå¹¶å°†å±æ€§è®¾ç½®åˆ°å…ƒç´ ä¸Š
      for (const key in vnode.props) {
        // è°ƒç”¨ patchProps å³å¯
        patchProps(el, key, null, vnode.props[key], shouldSetAsProps)
      }
    }

    // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
    insert(el, container)
  }
```

## class çš„å¤„ç†

ä¸ºä»€ä¹ˆéœ€è¦å¯¹ class å±æ€§è¿›è¡Œç‰¹æ®Šå¤„ç†å‘¢ï¼Œè¿™æ˜¯å› ä¸º Vue.js å¯¹ class å±æ€§åšäº†å¢å¼ºã€‚åœ¨ Vue.js ä¸­ä¸ºå…ƒç´ è®¾ç½®ç±»åæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š

1. æŒ‡å®šä¸ºå­—ç¬¦ä¸²å€¼ï¼š`<p class="foo bar"></p>`ï¼›
2. æŒ‡å®šä¸ºä¸€ä¸ªå¯¹è±¡ï¼š`<p :class="{ foo: true, bar: false }"></p>`ï¼›
3. åŒ…å«ä¸Šè¿°ä¸¤ç§ç±»å‹çš„æ•°ç»„ï¼š`<p :class="['foo bar', { baz: true }]">`ã€‚

å¯ä»¥çœ‹åˆ° class çš„å€¼å¯ä»¥æ˜¯å¤šç§ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…ˆæŠŠå…ƒç´ çš„ class å€¼æ ¼å¼åŒ–ä¸ºç»Ÿä¸€çš„å­—ç¬¦ä¸²å½¢å¼ï¼Œå†æŠŠè¯¥å­—ç¬¦ä¸²ä½œä¸ºå…ƒç´ çš„ class å€¼å»è®¾ç½®ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª `normalizeClass()` å‡½æ•°ï¼š

```js
function normalizeClass(value) {
  let res = ''
  if (typeof value === 'string') {
    res = value
  } else if (Array.isArray(value)) {
    for (let i = 0; i < value.length; i++) {
      const normalized = normalizeClass(value[i])
      if (normalized) {
        res += normalized + ' '
      }
    }
  } else if (Object.prototype.toString.call(value) === '[object Object]') {
    for (const name in value) {
      if (value[name]) {
        res += name + ' '
      }
    }
  }
  return res.trim()
}
```

åœ¨æµè§ˆå™¨ä¸­ä¸ºä¸€ä¸ªå…ƒç´ è®¾ç½® class æœ‰ä¸‰ç§æ–¹å¼ï¼š

1. `el.setAttribute()`ï¼›
2. `el.className`ï¼›
3. `el.classList`ã€‚

è¿™ä¸‰ç§æ–¹å¼ä¸­å“ªä¸€ç§æ€§èƒ½æ›´å¥½å‘¢ï¼Ÿç”±äºæ—¶é—´å…³ç³»ï¼Œè¿™é‡Œç»™å‡ºäº†ç­”æ¡ˆï¼š`el.className` çš„æ–¹å¼çš„æ€§èƒ½æœ€ä¼˜ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦è°ƒæ•´ `patchProps()` å‡½æ•°çš„å®ç°ï¼š

```js
function patchProps (el, key, prevValue, nextValue, shouldSetAsProps) {
  if (key === 'class') {
    el.className = nextValue || ''
  } else if (shouldSetAsProps(el, key, nextValue)) {
    // è·å–è¯¥ DOM Properties çš„ç±»å‹
    const type = typeof el[key]

    // å¦‚æœæ˜¯å¸ƒå°”ç±»å‹ï¼Œå¹¶ä¸”å€¼æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œåˆ™å°†å€¼çŸ«æ­£ä¸º true
    if (type === 'boolean' && nextValue === '') {
      el[key] = true
    } else {
      el[key] = nextValue
    }
  } else {
    // å¦‚æœè¦è®¾ç½®çš„å±æ€§æ²¡æœ‰å¯¹åº”çš„ DOM Propertiesï¼Œåˆ™ä½¿ç”¨ setAttribute å‡½æ•°è®¾ç½®å±æ€§
    el.setAttribute(key, nextValue)
  }
}
```

## å¸è½½æ“ä½œ

é¦–æ¬¡æŒ‚è½½å®Œæˆåï¼Œåç»­æ¸²æŸ“æ—¶å¦‚æœä¼ é€’äº† null ä½œä¸ºæ–° vnodeï¼Œåˆ™æ„å‘³ç€ä»€ä¹ˆéƒ½ä¸æ¸²æŸ“ï¼Œæˆ‘ä»¬éœ€è¦å¸è½½ä¹‹å‰æ¸²æŸ“çš„å†…å®¹ã€‚

æˆ‘ä»¬ä¹‹å‰æ˜¯é€šè¿‡ `el.innerHTML = ''` æ¥æ¸…ç©ºå®¹å™¨ï¼Œä½†è¿™ä¹ˆåšæ˜¯ä¸ä¸¥è°¨çš„ï¼ŒåŸå› æœ‰ä¸‰ç‚¹ï¼š

1. å®¹å™¨çš„å†…å®¹å¯èƒ½æ˜¯ç”±æŸä¸ªæˆ–å¤šä¸ªç»„ä»¶æ¸²æŸ“çš„ï¼Œå½“å¸è½½æ“ä½œå‘æ—¶ï¼Œåº”è¯¥æ­£ç¡®åœ°è°ƒç”¨è¿™äº›ç»„ä»¶çš„ `beforeUnmount()`ã€`unmounted()` ç­‰ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼›
2. å³ä½¿å†…å®¹ä¸æ˜¯ç”±ç»„ä»¶æ¸²æŸ“çš„ï¼Œæœ‰çš„å…ƒç´ å­˜åœ¨è‡ªå®šä¹‰æŒ‡ä»¤ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨å¸è½½æ“ä½œå‘ç”Ÿæ—¶æ­£ç¡®æ‰§è¡Œå¯¹åº”çš„æŒ‡ä»¤é’©å­å‡½æ•°ï¼›
3. ä½¿ç”¨ `innerHTML` æ¸…ç©ºå®¹å™¨å…ƒç´ å†…å®¹ä¸ä¼šç§»é™¤ç»‘å®šåœ¨ DOM å…ƒç´ ä¸Šçš„äº‹ä»¶å¤„ç†å‡½æ•°

æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ ¹æ® vnode å¯¹è±¡è·å–ä¸å…¶ç›¸å…³è”çš„çœŸå® DOM å…ƒç´ ï¼Œç„¶åä½¿ç”¨åŸç”Ÿ DOM æ“ä½œæ–¹æ³•å°†è¯¥å…ƒç´ ç§»é™¤ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ vnode ä¸çœŸå® DOM å…ƒç´ ä¹‹å‰å»ºç«‹è”ç³»ï¼Œä¿®æ”¹ `mountElement()` å‡½æ•°ï¼š

```js
function mountElement (vnode, container) {
  // åˆ›å»º DOM å…ƒç´ ï¼Œå¹¶è®© vnode.el å¼•ç”¨çœŸå® DOM å…ƒç´ 
  const el = vnode.el = createElement(vnode.type)

  // å¤„ç†å­èŠ‚ç‚¹ï¼Œå¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
  if (typeof vnode.children === 'string') {
    setElementText(el, vnode.children)
  } else if (Array.isArray(vnode.children)) {
    // å¦‚æœ children æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œåˆ™éå†æ¯ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶è°ƒç”¨ patch å‡½æ•°æŒ‚è½½å®ƒä»¬
    vnode.children.forEach(child => {
      patch(null, child, el)
    })
  }

  // å¦‚æœ vnode.props å­˜åœ¨ï¼Œåˆ™å¤„ç†
  if (vnode.props) {
    // éå† vnode.propsï¼Œå¹¶å°†å±æ€§è®¾ç½®åˆ°å…ƒç´ ä¸Š
    for (const key in vnode.props) {
      // è°ƒç”¨ patchProps å³å¯
      patchProps(el, key, null, vnode.props[key], shouldSetAsProps)
    }
  }

  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  insert(el, container)
}
```

å¦‚æ­¤ä¸€æ¥ï¼Œå½“åœ¨å¸è½½æ“ä½œå‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦æ ¹æ®è™šæ‹ŸèŠ‚ç‚¹å¯¹è±¡ `vnode.el` å–å¾—çœŸå® DOM å…ƒç´ ï¼Œå†å°†å…¶ä»çˆ¶å…ƒç´ ä¸­ç§»é™¤å³å¯ï¼š

```js
function render (vnode, container) {
  if (vnode) {
    // æ–° vnode å­˜åœ¨ï¼Œå°†å…¶ä¸æ—§ vnode ä¸€èµ·ä¼ é€’ç»™ patch å‡½æ•°ï¼Œè¿›è¡Œæ›´æ–°
    patch(container._vnode, vnode, container)
  } else {
    if (container._vnode) {
      const el = container._vnode.el
      // è·å– el çš„çˆ¶å…ƒç´ 
      const parent = el.parentNode
      // è°ƒç”¨çˆ¶å…ƒç´ çš„ removeChild ç§»é™¤å…ƒç´ 
      if (parent) {
        parent.removeChild(el)
      }
    }
  }

  // æŠŠ vnode å­˜å‚¨åˆ° container._vnode ä¸‹ï¼Œå³åç»­æ¸²æŸ“ä¸­çš„æ—§ vnode
  container._vnode = vnode
}
```

ç”±äºå¸è½½æ“ä½œæ˜¯æ¯”è¾ƒå¸¸è§ä¸”åŸºæœ¬çš„æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°†å®ƒå°è£…åˆ° `unmount()` å‡½æ•°ä¸­ï¼Œä»¥ä¾¿åç»­ä»£ç å¯ä»¥å¤ç”¨å®ƒï¼š

```js
function render (vnode, container) {
  if (vnode) {
    // æ–° vnode å­˜åœ¨ï¼Œå°†å…¶ä¸æ—§ vnode ä¸€èµ·ä¼ é€’ç»™ patch å‡½æ•°ï¼Œè¿›è¡Œæ›´æ–°
    patch(container._vnode, vnode, container)
  } else {
    if (container._vnode) {
      unmount(container._vnode)
    }
  }

  // æŠŠ vnode å­˜å‚¨åˆ° container._vnode ä¸‹ï¼Œå³åç»­æ¸²æŸ“ä¸­çš„æ—§ vnode
  container._vnode = vnode
}

function unmount (vnode) {
  // è·å– el çš„çˆ¶å…ƒç´ 
  const parent = vnode.el.parentNode
  // è°ƒç”¨çˆ¶å…ƒç´ çš„ removeChild ç§»é™¤å…ƒç´ 
  if (parent) {
    parent.removeChild(vnode.el)
  }
}
```

å°†å¸è½½æ“ä½œå°è£…åˆ° `unmount()` ä¸­ï¼Œè¿˜èƒ½å¸¦æ¥ä¸¤ç‚¹é¢å¤–çš„å¥½å¤„ï¼š

1. åœ¨ `unmount()` å‡½æ•°å†…ï¼Œæˆ‘ä»¬æœ‰æœºä¼šè°ƒç”¨ç»‘å®šåœ¨ DOM å…ƒç´ ä¸Šçš„æŒ‡ä»¤é’©å­å‡½æ•°ï¼›
2. å½“ `unmount()` å‡½æ•°æ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬æœ‰æœºä¼šæ£€æµ‹è™šæ‹ŸèŠ‚ç‚¹ vnode çš„ç±»å‹ã€‚å¦‚æœè¯¥è™šæ‹ŸèŠ‚ç‚¹æè¿°çš„æ˜¯ç»„ä»¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹Ÿæœ‰æœºä¼šè°ƒç”¨ç»„ä»¶ç›¸å…³çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€‚

## åŒºåˆ† vnode çš„ç±»å‹

æ­¤å‰ï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼Œå½“åç»­è°ƒç”¨ `render()` å‡½æ•°æ¸²æŸ“ç©ºå†…å®¹ï¼ˆå³ nullï¼‰æ—¶ï¼Œä¼šæ‰§è¡Œå¸è½½æ“ä½œï¼Œå¦‚æœä¼ é€’äº†æ–°çš„ vnodeï¼Œåˆ™ä¸ä¼šè¿›è¡Œå¸è½½æ“ä½œï¼Œè€Œæ˜¯æŠŠæ–°æ—§ vnode éƒ½ä¼ é€’ç»™  `patch()` å‡½æ•°è¿›è¡Œæ›´æ–°æ“ä½œã€‚å›é¡¾ä¹‹å‰å®ç°çš„ `patch()` å‡½æ•°ï¼š

```js
function patch (n1, n2, container) {
  // å¦‚æœ n1 ä¸å­˜åœ¨ï¼Œæ„å‘³ç€æŒ‚è½½ï¼Œåˆ™è°ƒç”¨ mountElement å‡½æ•°å®ŒæˆæŒ‚è½½
  if (!n1) {
    mountElement(n2, container)
  } else {
    // n1 å­˜åœ¨ï¼Œæ„å‘³ç€æ›´æ–°ï¼Œæš‚æ—¶çœç•¥
  }
}
```

å…¶ä¸­ï¼Œn1 å’Œ n2 åˆ†åˆ«ä»£è¡¨æ—§ vnode ä¸æ–° vnodeã€‚å¦‚æœæ—§ vnode å­˜åœ¨ï¼Œåœ¨éœ€è¦åœ¨æ–°æ—§ vnode ä¹‹é—´æ‰“è¡¥ä¸ã€‚ä½†åœ¨å…·ä½“æ‰§è¡Œæ‰“è¡¥ä¸æ“ä½œä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯æ–°æ—§ vnode æ‰€æè¿°çš„å†…å®¹ç›¸åŒã€‚è¿™æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾åˆæ¬¡æ¸²æŸ“çš„ vnode æ˜¯ä¸€ä¸ª p å…ƒç´ ï¼š

```js
const vnode = {
  type: 'p'
}
renderer.render(vnode, document.querySelector('#app'))
```

åç»­åˆæ¸²æŸ“äº†ä¸€ä¸ª input å…ƒç´ ï¼š

```js
const vnode = {
  type: 'input'
}
renderer.render(vnode, document.querySelector('#app'))
```

è¿™å°±ä¼šé€ æˆæ–°æ—§ vnode æ‰€æè¿°çš„å†…å®¹ä¸åŒï¼Œå³ `vnode.type` å±æ€§çš„å€¼ä¸åŒã€‚å¯¹äºä¸Šä¾‹æ¥è¯´ï¼Œp å…ƒç´ å’Œ input å…ƒç´ ä¹‹é—´ä¸å­˜åœ¨æ‰“è¡¥ä¸çš„æ„ä¹‰ï¼Œå› ä¸ºå¯¹äºä¸åŒçš„å…ƒç´ æ¥è¯´ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æœ‰ç‰¹æœ‰çš„å±æ€§ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ­£ç¡®çš„æ›´æ–°æ“ä½œæ˜¯ï¼šå…ˆå°† p å…ƒç´ å¸è½½ï¼Œå†å°† input å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è°ƒæ•´ `patch()` å‡½æ•°çš„ä»£ç ï¼š

```js
function patch (n1, n2, container) {
  // n1 å­˜åœ¨ï¼Œåˆ™å¯¹æ¯” n1 å’Œ n2 çš„ç±»å‹
  if (n1 && n1.type !== n2.type) {
    // å¦‚æœä¸¤è€…ç±»å‹ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥å°†æ—§ vnode å¸è½½
    unmount(n1)
    n1 = null
  }

  if (!n1) {
    mountElement(n2, container)
  } else {
    // æ›´æ–°
  }
}
```

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¸è½½å®Œæˆä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥æŠŠ n1 çš„å€¼é‡ç½®ä¸º nullï¼Œè¿™æ ·æ‰èƒ½ä¿è¯åç»­æŒ‚è½½æ“ä½œæ­£ç¡®æ‰§è¡Œã€‚

å³ä½¿æ–°æ—§ vnode æè¿°çš„å†…å®¹ç›¸åŒï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦è¿›ä¸€æ­¥ç¡®è®¤å®ƒä»¬çš„ç±»å‹æ˜¯å¦ç›¸åŒã€‚æˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ª vnode å¯ä»¥ç”¨æ¥æè¿°æ™®é€šæ ‡ç­¾ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æè¿°ç»„ä»¶ï¼Œè¿˜å¯ä»¥ç”¨æ¥æè¿° Frament ç­‰ã€‚å¯¹äºä¸åŒç±»å‹çš„ vnodeï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä¸åŒçš„æŒ‚è½½æˆ–æ›´æ–°çš„å¤„ç†æ–¹å¼ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»§ç»­ä¿®æ”¹ `patch()` å‡½æ•°ä»£ç ä»¥æ»¡è¶³éœ€æ±‚ï¼š

```js
function patch (n1, n2, container) {
  // n1 å­˜åœ¨ï¼Œåˆ™å¯¹æ¯” n1 å’Œ n2 çš„ç±»å‹
  if (n1 && n1.type !== n2.type) {
    // å¦‚æœä¸¤è€…ç±»å‹ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥å°†æ—§ vnode å¸è½½
    unmount(n1)
    n1 = null
  }

  // ä»£ç è¿è¡Œåˆ°è¿™é‡Œï¼Œè¯æ˜ n1 å’Œ n2 æ‰€æè¿°çš„å†…å®¹ç›¸åŒ
  const { type } = n2
  // å¦‚æœ n2.type æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œåˆ™å®ƒæè¿°çš„æ˜¯æ™®é€šæ ‡ç­¾å…ƒç´ 
  if (typeof type === 'string') {
    if (!n1) {
      mountElement(n2, container)
    } else {
      // æ›´æ–°
      // patchElement(n1, n2)
    }
  } else if (typeof type === 'object') {
    // å¦‚æœ n2.type æ˜¯å¯¹è±¡ï¼Œåˆ™å®ƒæè¿°çš„æ˜¯ç»„ä»¶
  } else if (type === 'xxx') {
    // å¤„ç†å…¶ä»–ç±»å‹çš„ vnode
  }
}
```

## äº‹ä»¶çš„å¤„ç†

å¦‚ä½•åœ¨è™šæ‹ŸèŠ‚ç‚¹ä¸­æè¿°äº‹ä»¶ï¼Ÿäº‹ä»¶å¯ä»¥è§†ä½œä¸ºä¸€ç§ç‰¹æ®Šçš„å±æ€§ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥çº¦å®šï¼Œåœ¨ `vnode.props` å¯¹è±¡ä¸­ï¼Œå‡¡æ˜¯ä»¥å­—ç¬¦ä¸² **on** å¼€å¤´çš„å±æ€§éƒ½è§†ä½œäº‹ä»¶ã€‚ä¾‹å¦‚ï¼š

```js
const vnode = {
	type: 'p',
  props: {
    // ä½¿ç”¨ onXxx æè¿°äº‹ä»¶
    onClick: () => {
      alert('clicked.')
    }
  },
  children: 'text'
}
```

æˆ‘ä»¬å†æ¥çœ‹çœ‹å¦‚ä½•å°†äº‹ä»¶æ·»åŠ åˆ° DOM å…ƒç´ ä¸Šã€‚è¿™éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨ `patchProps()` è°ƒç”¨ `addEventListener()` å‡½æ•°ç»‘å®šäº‹ä»¶å³å¯ï¼š

```js
patchProps (el, key, prevValue, nextValue, shouldSetAsProps) {
  // åŒ¹é…ä»¥ on å¼€å¤´çš„å±æ€§ï¼Œè§†å…¶ä¸ºäº‹ä»¶
  if (/^on/.test(key)) {
    // æ ¹æ®å±æ€§åç§°å¾—åˆ°å¯¹åº”çš„äº‹ä»¶åç§°ï¼Œå¦‚ onClick -> click
    const name = key.slice(2).toLowerCase()
    // ç»‘å®šäº‹ä»¶å¤„ç†å‡½æ•°
    el.addEventListener(name, nextValue)
  } else if (key === 'class') {
    // ...
  } else if (shouldSetAsProps(el, key, nextValue)) {
    // ...
  } else {
    // ...
  }
}
```

é‚£ä¹ˆï¼Œæ›´æ–°äº‹ä»¶å¦‚ä½•å¤„ç†å‘¢ï¼ŸæŒ‰ç…§ä¸€èˆ¬çš„æ€è·¯ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç§»é™¤ä¹‹å‰æ·»åŠ çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œå†å°†æ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°ç»‘å®šåˆ° DOM å…ƒç´ ä¸Šï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼š

```js
patchProps (el, key, prevValue, nextValue, shouldSetAsProps) {
  // åŒ¹é…ä»¥ on å¼€å¤´çš„å±æ€§ï¼Œè§†å…¶ä¸ºäº‹ä»¶
  if (/^on/.test(key)) {
    // æ ¹æ®å±æ€§åç§°å¾—åˆ°å¯¹åº”çš„äº‹ä»¶åç§°ï¼Œå¦‚ onClick -> click
    const name = key.slice(2).toLowerCase()
    // ç§»é™¤ä¸Šä¸€æ¬¡ç»‘å®šçš„äº‹ä»¶å¤„ç†å‡½æ•°
    prevValue && el.removeEventListener(name, prevValue)
    // ç»‘å®šäº‹ä»¶å¤„ç†å‡½æ•°
    el.addEventListener(name, nextValue)
  } else if (key === 'class') {
    // ...
  } else if (shouldSetAsProps(el, key, nextValue)) {
    // ...
  } else {
    // ...
  }
}
```

è¿™æ ·åšä»£ç èƒ½å¤ŸæŒ‰ç…§é¢„æœŸå·¥ä½œï¼Œä½†å…¶å®è¿˜æœ‰ä¸€ç§æ€§èƒ½æ›´ä¼˜çš„æ–¹å¼æ¥å®Œæˆäº‹ä»¶æ›´æ–°ã€‚

åœ¨ç»‘å®šäº‹ä»¶æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç»‘å®šä¸€ä¸ªä¼ªé€ çš„äº‹ä»¶å¤„ç†å‡½æ•° `invoker`ï¼Œç„¶åæŠŠçœŸæ­£çš„äº‹ä»¶å¤„ç†å‡½æ•°è®¾ç½®ä¸º `invoker.value` å±æ€§çš„å€¼ã€‚è¿™æ ·å½“æ›´æ–°äº‹ä»¶æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦æ›´æ–° `invoker.value` çš„å€¼å³å¯ï¼š

```js
patchProps (el, key, prevValue, nextValue, shouldSetAsProps) {
  // åŒ¹é…ä»¥ on å¼€å¤´çš„å±æ€§ï¼Œè§†å…¶ä¸ºäº‹ä»¶
  if (/^on/.test(key)) {
    // è·å–è¯¥å…ƒç´ çš„ä¼ªé€ äº‹ä»¶å¤„ç†å‡½æ•° invoker
    let invoker = el._vei
    // æ ¹æ®å±æ€§åç§°å¾—åˆ°å¯¹åº”çš„äº‹ä»¶åç§°ï¼Œå¦‚ onClick -> click
    const name = key.slice(2).toLowerCase()

    if (nextValue) {
      // å¦‚æœæ²¡æœ‰ invokerï¼Œåˆ™å°†ä¸€ä¸ªä¼ªé€ çš„ invoker ç¼“å­˜åˆ° el._vei ä¸­
      // vei æ˜¯ vue event invoker çš„é¦–å­—æ¯ç¼©å†™
      if (!invoker) {
        // å½“ä¼ªé€ çš„äº‹ä»¶å¤„ç†å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šæ‰§è¡ŒçœŸæ­£çš„äº‹ä»¶å¤„ç†å‡½æ•°
        invoker = el._vei = (e) => {
          invoker.value(e)
        }
        // å°†çœŸæ­£çš„äº‹ä»¶å¤„ç†å‡½æ•°èµ‹å€¼ç»™ invoker.value
        invoker.value = nextValue
        // ç»‘å®š invoker ä½œä¸ºäº‹ä»¶å¤„ç†å‡½æ•°
        el.addEventListener(name, invoker)
      } else {
        // å¦‚æœ invoker å­˜åœ¨ï¼Œæ„å‘³ç€æ›´æ–°ï¼Œåªéœ€è¦æ›´æ–° invoker.value çš„å€¼å³å¯
        invoker.value = nextValue
      }
    } else if (invoker) {
      // æ–°çš„äº‹ä»¶ç»‘å®šå‡½æ•°ä¸å­˜åœ¨ï¼Œä¸”ä¹‹å‰ç»‘å®šçš„ invoker å­˜åœ¨ï¼Œåˆ™ç§»é™¤ç»‘å®š
      el.removeEventListener(name, invoker)
    }
  } else if (key === 'class') {
    // ...
  } else if (shouldSetAsProps(el, key, nextValue)) {
    // ...
  } else {
    // ...
  }
}
```

å®é™…ä¸Šï¼Œä¼ªé€ çš„äº‹ä»¶å¤„ç†å‡½æ•°çš„ä½œç”¨ä¸æ­¢äºæ­¤ï¼Œå®ƒè¿˜èƒ½è§£å†³äº‹ä»¶å†’æ³¡ä¸æ›´æ–°ä¹‹é—´ç›¸äº’å½±å“çš„é—®é¢˜ï¼Œä¸‹æ–‡ä¼šè¯¦ç»†è®²è§£ã€‚

ä½†ç›®å‰çš„å®ç°ä»ç„¶å­˜åœ¨é—®é¢˜ã€‚ç°åœ¨æˆ‘ä»¬å°†äº‹ä»¶å¤„ç†å‡½æ•°ç¼“å­˜åœ¨ `el._vei` å±æ€§ä¸­ï¼Œé—®é¢˜æ˜¯ï¼Œåœ¨åŒä¸€æ—¶åˆ»åªèƒ½ç¼“å­˜ä¸€ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä¸€ä¸ªå…ƒç´ åŒæ—¶ç»‘å®šäº†å¤šç§äº‹ä»¶ï¼Œå°†ä¼šå‡ºç°äº‹ä»¶è¦†ç›–çš„æƒ…å†µã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°è®¾è®¡ `el._vei` çš„æ•°æ®ç»“æ„ã€‚æˆ‘ä»¬åº”è¯¥å°† `el._vei` è®¾è®¡ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒçš„é”®æ˜¯äº‹ä»¶åç§°ï¼Œå€¼åˆ™æ—¶å¯¹åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œè¿™æ ·å°±ä¸ä¼šå‘ç”Ÿäº‹ä»¶è¦†ç›–çš„ç°è±¡äº†ï¼š

```js
patchProps (el, key, prevValue, nextValue, shouldSetAsProps) {
    // åŒ¹é…ä»¥ on å¼€å¤´çš„å±æ€§ï¼Œè§†å…¶ä¸ºäº‹ä»¶
    if (/^on/.test(key)) {
      // å®šä¹‰ el._vei ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œå­˜å‚¨äº‹ä»¶åç§°åˆ°äº‹ä»¶å¤„ç†å‡½æ•°çš„æ˜ å°„
      const invokers = el._vei || (el._vei = {})
      // æ ¹æ®äº‹ä»¶åè·å– invoker
      let invoker = invokers[key]
      // æ ¹æ®å±æ€§åç§°å¾—åˆ°å¯¹åº”çš„äº‹ä»¶åç§°ï¼Œå¦‚ onClick -> click
      const name = key.slice(2).toLowerCase()

      if (nextValue) {
        if (!invoker) {
          // å°†äº‹ä»¶å¤„ç†å‡½æ•°ç¼“å­˜åˆ° `el._vei[key]` ä¸‹ï¼Œé¿å…è¦†ç›–
          invoker = el._vei[key] = (e) => {
            invoker.value(e)
          }
          // å°†çœŸæ­£çš„äº‹ä»¶å¤„ç†å‡½æ•°èµ‹å€¼ç»™ invoker.value
          invoker.value = nextValue
          // ç»‘å®š invoker ä½œä¸ºäº‹ä»¶å¤„ç†å‡½æ•°
          el.addEventListener(name, invoker)
        } else {
          // å¦‚æœ invoker å­˜åœ¨ï¼Œæ„å‘³ç€æ›´æ–°ï¼Œåªéœ€è¦æ›´æ–° invoker.value çš„å€¼å³å¯
          invoker.value = nextValue
        }
      } else if (invoker) {
        // æ–°çš„äº‹ä»¶ç»‘å®šå‡½æ•°ä¸å­˜åœ¨ï¼Œä¸”ä¹‹å‰ç»‘å®šçš„ invoker å­˜åœ¨ï¼Œåˆ™ç§»é™¤ç»‘å®š
        el.removeEventListener(name, invoker)
      }
    } else if (key === 'class') {
      // ...
    } else if (shouldSetAsProps(el, key, nextValue)) {
      // ...
    } else {
      // ...
    }
  }
```

å¦å¤–ï¼Œä¸€ä¸ªå…ƒç´ ä¸ä»…å¯ä»¥ç»‘å®šå¤šç§ç±»å‹çš„äº‹ä»¶ï¼Œå¯¹äºåŒä¸€ç±»å‹çš„äº‹ä»¶è€Œè¨€ï¼Œè¿˜å¯ä»¥ç»‘å®šå¤šä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è°ƒæ•´ `vnode.props` å¯¹è±¡ä¸­äº‹ä»¶çš„æ•°æ®ç»“æ„ï¼š

```js
const vnode = {
  type: 'p',
  props: {
    onClick: [
      () => {},
      () => {}
    ]
  }
}
```

ä¸ºäº†å®ç°æ­¤åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ `patchProps()` å‡½æ•°ä¸­äº‹ä»¶å¤„ç†ç›¸å…³çš„ä»£ç ï¼š

```js
patchProps (el, key, prevValue, nextValue, shouldSetAsProps) {
    if (/^on/.test(key)) {
      const invokers = el._vei || (el._vei = {})
      let invoker = invokers[key]
      const name = key.slice(2).toLowerCase()

      if (nextValue) {
        if (!invoker) {
          // å°†äº‹ä»¶å¤„ç†å‡½æ•°ç¼“å­˜åˆ° `el._vei[key]` ä¸‹ï¼Œé¿å…è¦†ç›–
          invoker = el._vei[key] = (e) => {
            // å¦‚æœ invoker.value æ˜¯ä¸€ä¸ªæ•°æ®ï¼Œåˆ™éå†å®ƒå¹¶é€ä¸ªè°ƒç”¨äº‹ä»¶å¤„ç†å‡½æ•°
            if (Array.isArray(invoker.value)) {
              invoker.value.forEach(fn => fn(e))
            } else {
              // å¦åˆ™ç›´æ¥ä½œç”¨å‡½æ•°è°ƒç”¨
              invoker.value(e)
            }
          }
          // å°†çœŸæ­£çš„äº‹ä»¶å¤„ç†å‡½æ•°èµ‹å€¼ç»™ invoker.value
          invoker.value = nextValue
          // ç»‘å®š invoker ä½œä¸ºäº‹ä»¶å¤„ç†å‡½æ•°
          el.addEventListener(name, invoker)
        } else {
          // å¦‚æœ invoker å­˜åœ¨ï¼Œæ„å‘³ç€æ›´æ–°ï¼Œåªéœ€è¦æ›´æ–° invoker.value çš„å€¼å³å¯
          invoker.value = nextValue
        }
      } else if (invoker) {
        // æ–°çš„äº‹ä»¶ç»‘å®šå‡½æ•°ä¸å­˜åœ¨ï¼Œä¸”ä¹‹å‰ç»‘å®šçš„ invoker å­˜åœ¨ï¼Œåˆ™ç§»é™¤ç»‘å®š
        el.removeEventListener(name, invoker)
      }
    } else if (key === 'class') {
      // ...
    } else if (shouldSetAsProps(el, key, nextValue)) {
      // ...
    } else {
      // ...
    }
  }
```

## æ›´æ–°å­èŠ‚ç‚¹

æˆ‘ä»¬å…ˆè®²ä¸€ä¸‹å¦‚ä½•æ›´æ–°å­èŠ‚ç‚¹ï¼Œä¹‹åå†è®²äº‹ä»¶å†’æ³¡ä¸æ›´æ–°æ—¶æœºçš„é—®é¢˜ã€‚æˆ‘ä»¬åœ¨æŒ‚è½½å­èŠ‚ç‚¹æ—¶ï¼Œé¦–å…ˆè¦åŒºåˆ†å…¶ç±»å‹ï¼š

1. å¦‚æœ `vnode.children` æ˜¯å­—ç¬¦ä¸²ï¼Œè¯´æ˜å…ƒç´ å…·æœ‰æ–‡æœ¬å­èŠ‚ç‚¹ï¼›
2. å¦‚æœ `vnode.children` æ˜¯æ•°ç»„ï¼Œè¯´æ˜å…ƒç´ å…·æœ‰å¤šä¸ªå­èŠ‚ç‚¹ã€‚

ä¸ºä»€ä¹ˆè¦åŒºåˆ†å…¶ç±»å‹å‘¢ï¼Ÿå…¶å®è¿™æ˜¯ä¸€ä¸ªè§„èŒƒæ€§çš„é—®é¢˜ï¼Œå› ä¸ºåªæœ‰å­èŠ‚ç‚¹è§„èŒƒåŒ–ï¼Œæ‰æœ‰åˆ©äºæˆ‘ä»¬ç¼–å†™æ›´æ–°é€»è¾‘ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè®¾å®šå¥½å­èŠ‚ç‚¹çš„è§„èŒƒã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹åœ¨ HTML é¡µé¢ä¸­ï¼Œå…ƒç´ çš„å­èŠ‚ç‚¹éƒ½æœ‰å“ªäº›æƒ…å†µï¼š

```html
<!-- æ²¡æœ‰å­èŠ‚ç‚¹ -->
<div></div>
<!-- æ–‡æœ¬å­èŠ‚ç‚¹ -->
<div>Some text</div>
<!-- å¤šä¸ªå­èŠ‚ç‚¹ -->
<div>
  <p></p>
  <p></p>
</div>
```

å¯¹äºä¸€ä¸ªå…ƒç´ æ¥è¯´ï¼Œå®ƒçš„å­èŠ‚ç‚¹æ— éå°±ä¸‰ç§æƒ…å†µï¼š

1. æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œæ­¤æ—¶ `vnode.children` çš„å€¼ä¸º nullï¼›
2. å…·æœ‰æ–‡æœ¬å­èŠ‚ç‚¹ï¼Œæ­¤æ—¶ `vnode.children` çš„å€¼ä¸ºå­—ç¬¦ä¸²ï¼Œä»£è¡¨æ–‡æœ¬å†…å®¹ï¼›
3. å…¶ä»–æƒ…å†µï¼Œæ— è®ºæ˜¯å•ä¸ªå…ƒç´ å­èŠ‚ç‚¹ï¼Œè¿˜æ˜¯å¤šä¸ªå­èŠ‚ç‚¹ï¼ˆå¯èƒ½æ˜¯æ–‡æœ¬å’Œå…ƒç´ çš„æ··åˆï¼‰ï¼Œéƒ½å¯ä»¥ç”¨æ•°æ®æ¥è¡¨ç¤ºã€‚

å¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š

```js
// æ²¡æœ‰å­èŠ‚ç‚¹
vnode = {
  type: 'div',
  children: null
}
// å…·æœ‰æ–‡æœ¬å­èŠ‚ç‚¹
vnode = {
  type: 'div',
  children: 'Some text'
}
// å¤šä¸ªå­èŠ‚ç‚¹
vnode = {
  type: 'div',
  children: [
    {
      type: 'p'
    },
    'Text'
  ]
}
```

ç°åœ¨æˆ‘ä»¬å·²ç»è§„èŒƒåŒ–äº† `vnode.children` çš„ç±»å‹ã€‚æ—¢ç„¶ä¸€ä¸ª vnode çš„å­èŠ‚ç‚¹å¯èƒ½æœ‰ä¸‰ç§æƒ…å†µï¼Œé‚£ä¹ˆå½“æ¸²æŸ“å™¨æ‰§è¡Œæ›´æ–°æ—¶ï¼Œæ–°æ—§å­èŠ‚ç‚¹éƒ½åˆ†åˆ«æ˜¯ 3 ç§æƒ…å†µä¹‹ä¸€ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºæ›´æ–°å­èŠ‚ç‚¹æ—¶çš„å…¨éƒ¨ 9 ç§å¯èƒ½ï¼š

![patchElement](../imgs/patchElement.png)

ä½†è½å®åˆ°ä»£ç ï¼Œæˆ‘ä»¬ä¼šå‘ç°å…¶å®å¹¶ä¸éœ€è¦å®Œå…¨è¦†ç›–è¿™ 9 ç§å¯èƒ½ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¼€å§‹ç€æ‰‹å®ç°ï¼š

```js
function patchElement (n1, n2) {
  const el = n2.el = n1.el
  const oldProps = n1.props
  const newProps = n2.props

  // ç¬¬ä¸€æ­¥ï¼šæ›´æ–° props
  for (const key in newProps) {
    if (newProps[key] !== oldProps[key]) {
      patchProps(el, key, oldProps[key], newProps[key])
    }
  }
  for (const key in oldProps) {
    if (!key in newProps) {
      patchProps(el, key, oldProps[key], null)
    }
  }

  // ç¬¬äºŒæ­¥ï¼šæ›´æ–° children
  patchChildren(n1, n2, el)
}
```

å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œæ›´æ–°å­èŠ‚ç‚¹æ˜¯å¯¹ä¸€ä¸ªå…ƒç´ è¿›è¡Œæ‰“è¡¥ä¸çš„æœ€åä¸€æ­¥æ“ä½œã€‚æˆ‘ä»¬å°†å®ƒå°è£…åˆ° `patchChildren()` å‡½æ•°ä¸­ï¼Œå¹¶å°†æ–°æ—§èŠ‚ç‚¹ä»¥åŠå½“å‰æ­£åœ¨è¢«æ‰“è¡¥ä¸çš„ DOM å…ƒç´  el ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ƒã€‚

`patchChildren()` å‡½æ•°çš„å®ç°å¦‚ä¸‹ï¼š

```js
function patchChildren (n1, n2, container) {
  // åˆ¤æ–­æ–°å­èŠ‚ç‚¹çš„ç±»å‹æ˜¯å¦æ˜¯æ–‡æœ¬èŠ‚ç‚¹
  if (typeof n2.children === 'string') {
    // æ—§å­èŠ‚ç‚¹çš„ç±»å‹æœ‰ä¸‰ç§å¯èƒ½
    // åªæœ‰å½“æ—§å­èŠ‚ç‚¹ä¸ºä¸€ç»„å­èŠ‚ç‚¹æ—¶ï¼Œæ‰éœ€è¦é€ä¸ªå¸è½½ï¼Œå…¶ä»–æƒ…å†µä»€ä¹ˆéƒ½ä¸éœ€è¦åš
    if (Array.isArray(n1.children)) {
      n1.children.forEach(c => unmount(c))
    }
    // æœ€åå°†æ–°çš„æ–‡æœ¬èŠ‚ç‚¹å†…å®¹è®¾ç½®ç»™å®¹å™¨å…ƒç´ 
    setElementText(container, n2.children)
  } else if (Array.isArray(n2.children)) {
    // å¦‚æœæ–°å­èŠ‚ç‚¹çš„ç±»å‹æ˜¯ä¸€ç»„å­èŠ‚ç‚¹
    // åˆ¤æ–­æ—§å­èŠ‚ç‚¹æ˜¯å¦ä¹Ÿæ˜¯ä¸€ç»„å­èŠ‚ç‚¹
    if (Array.isArray(n1.children)) {
      // **è¿™é‡Œæ¶‰åŠåˆ°æ ¸å¿ƒçš„ diff ç®—æ³•**

      // æˆ‘ä»¬å¯ä»¥å…ˆç”¨ä¸€ç§å‚»æ–¹å¼æ¥å¤„ç†
      // å°±æ˜¯å°†æ—§èŠ‚ç‚¹å…¨å¸è½½ï¼Œé‡æ–°æŒ‚è½½æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹
      n1.children.forEach(c => unmount(c))
      n2.children.forEach(c => patch(null, c, container))
    } else {
      // æ­¤æ—¶ï¼š
      // æ—§å­èŠ‚ç‚¹è¦ä¹ˆæ˜¯æ–‡æœ¬å­èŠ‚ï¼Œè¦ä¹ˆä¸å­˜åœ¨
      // æ— è®ºå“ªç§æƒ…å†µï¼Œæˆ‘ä»¬éƒ½åªéœ€è¦å°†å®¹å™¨æ¸…ç©ºï¼Œç„¶åå°†æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹é€ä¸ªæŒ‚è½½å³å¯
      setElementText(container, '')
      n2.children.forEach(c => patch(null, c, container))
    }
  } else {
    // ä»£ç è¿è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜æ–°çš„å­èŠ‚ç‚¹ä¸å­˜åœ¨
    // å¦‚æœæ—§çš„å­èŠ‚ç‚¹æ˜¯ä¸€ç»„å­èŠ‚ç‚¹ï¼Œåªéœ€è¦é€ä¸ªå¸è½½å³å¯
    if (Array.isArray(n1.children)) {
      n1.children.forEach(c => unmount(c))
    } else if (typeof n1.children === 'string') {
      // æ—§å­èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œæ¸…ç©ºå†…å®¹å³å¯
      setElementText(container, '')
    }
    // å¦‚æœä¹Ÿæ²¡æœ‰æ—§å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä»€ä¹ˆéƒ½ä¸éœ€è¦åš
  }
}
```

## äº‹ä»¶å†’æ³¡ä¸æ›´æ–°æ—¶æœºé—®é¢˜

åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†åŸºæœ¬çš„äº‹ä»¶å¤„ç†ã€‚æœ¬èŠ‚æˆ‘ä»¬å°†è®¨è®ºäº‹ä»¶å†’æ³¡ä¸æ›´æ–°æ—¶æœºç›¸ç»“åˆæ‰€å¯¼è‡´çš„é—®é¢˜ã€‚ä¸ºäº†æ›´æ¸…æ™°åœ°æè¿°é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ ä¸€ä¸ªå°ä¾‹å­ï¼š

```js
const { effect, ref } = VueReactivity

const bol = ref(false)

effect(() => {
  const vnode = {
    type: 'div',
    props: bol.value ? {
      onClick: () => {
        alert('çˆ¶å…ƒç´  clicked')
      }
    } : {},
    children: [
      {
        type: 'p',
        props: {
          onClick: () => {
            bol.value = true
          }
        },
        children: 'text'
      }
    ]
  }
  // æ¸²æŸ“ vnode
  renderer.render(vnode, document.querySelector('#app'))
})
```

å½“é¦–æ¬¡æ¸²æŸ“å®Œæˆåï¼Œç”¨é¼ æ ‡ç‚¹å‡» p å…ƒç´ ï¼Œä¼šè§¦å‘ div å…ƒç´ çš„ click äº‹ä»¶å¤„ç†å‡½æ•°æ‰§è¡Œå—ï¼Ÿ

ç­”æ¡ˆå…¶å®å¾ˆæ˜æ˜¾ï¼Œåœ¨é¦–æ¬¡æ¸²æŸ“å®Œæˆåï¼Œç”±äº `bol.value` çš„å€¼ä¸º falseï¼Œæ‰€ä»¥æ¸²æŸ“å™¨å¹¶ä¸ä¼šä¸º div å…ƒç´ ç»‘å®šç‚¹å‡»äº‹ä»¶ã€‚å½“ç”¨é¼ æ ‡ç‚¹å‡» p å…ƒç´ æ—¶ï¼Œå³ä½¿ click äº‹ä»¶å¯ä»¥ä» p å…ƒç´ å†’æ³¡åˆ°çˆ¶çº§å…ƒç´ ï¼Œä½†ç”±äº div å…ƒç´ å¹¶æ²¡æœ‰ç»‘å®š click äº‹ä»¶çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œæ‰€ä»¥ä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿã€‚

ä½†æ‰“è„¸æ¥å¾—çœŸå¿«ï¼Œå½“æˆ‘ä»¬å°è¯•è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œå¹¶ç‚¹å‡» p å…ƒç´ æ—¶ï¼Œä¸€ä¸ª alert å¼¹çª—äº®çäº†æˆ‘çš„ç‹—çœ¼ã€‚

ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ

å½“ p ç‚¹å‡»è¢«ç‚¹å‡»æ—¶ï¼Œ`bol.value` å˜æˆ trueï¼Œä»è€Œè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œæ‰€ä»¥åœ¨æ›´æ–°é˜¶æ®µï¼Œdiv ä¼šè¢«ç»‘å®š click äº‹ä»¶çš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚å½“æ›´æ–°å®Œåï¼Œp å…ƒç´ çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ°çˆ¶çº§ï¼Œä»è€Œè§¦å‘äº† div çš„ click äº‹ä»¶çš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚ä¸‹å›¾ç»™å‡ºäº†æ›´æ–°å’Œäº‹ä»¶è§¦å‘çš„æµç¨‹ï¼š

![äº‹ä»¶å†’æ³¡-1](../imgs/äº‹ä»¶å†’æ³¡-1.png)

ä»å›¾ä¸Šæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œä¹‹æ‰€ä»¥ä¼šå‡ºç°ä¸Šè¿°å¥‡æ€ªçš„ç°è±¡ï¼Œæ˜¯å› ä¸ºæ›´æ–°æ“ä½œå‘ç”Ÿåœ¨äº‹ä»¶å†’æ³¡ä¹‹å‰ï¼Œå³**ä¸º div å…ƒç´ ç»‘å®šäº‹ä»¶å¤„ç†å‡½æ•°å‘ç”Ÿåœ¨äº‹ä»¶å†’æ³¡ä¹‹å‰ã€‚**

é‚£å¦‚ä½•é¿å…è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬ä»”ç»†çœ‹ä¸Šå›¾å°±ä¼šå‘ç°ï¼Œè§¦å‘äº‹ä»¶çš„æ—¶é—´ä¸ç»‘å®šäº‹ä»¶çš„æ—¶é—´ä¹‹é—´æ˜¯æœ‰è”ç³»çš„ï¼š

![äº‹ä»¶å†’æ³¡-2](../imgs/äº‹ä»¶å†’æ³¡-2.png)

å¯ä»¥å‘ç°ï¼Œäº‹ä»¶è§¦å‘çš„æ—¶é—´è¦æ—©äºäº‹ä»¶å¤„ç†å‡½æ•°è¢«ç»‘å®šçš„æ—¶é—´ã€‚è¿™æ„å‘³ç€å½“ä¸€ä¸ªäº‹ä»¶è§¦å‘æ—¶ï¼Œç›®æ ‡å…ƒç´ ä¸Šè¿˜æ²¡æœ‰ç»‘å®šç›¸å…³çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸ªç‰¹ç‚¹æ¥è§£å†³é—®é¢˜ï¼š**å±è”½æ‰€æœ‰ç»‘å®šæ—¶é—´æ™šäºäº‹ä»¶è§¦å‘æ—¶é—´çš„äº‹ä»¶å¤„ç†å‡½æ•°çš„æ‰§è¡Œã€‚**åŸºäºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒæ•´ `patchProps()` å‡½æ•°ä¸­å…³äºäº‹ä»¶çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š

```js
patchProps (el, key, prevValue, nextValue, shouldSetAsProps) {
    if (/^on/.test(key)) {
      const invokers = el._vei || (el._vei = {})
      let invoker = invokers[key]
      const name = key.slice(2).toLowerCase()

      if (nextValue) {
        if (!invoker) {
          invoker = el._vei[key] = (e) => {
            // å¦‚æœäº‹ä»¶å‘ç”Ÿçš„æ—¶é—´ æ—©äº äº‹ä»¶å¤„ç†å‡½æ•°è¢«ç»‘å®šçš„æ—¶é—´
            // åˆ™ä¸æ‰§è¡Œäº‹ä»¶å¤„ç†å‡½æ•°
            if (e.timeStamp < invoker.attached) return

            if (Array.isArray(invoker.value)) {
              invoker.value.forEach(fn => fn(e))
            } else {
              invoker.value(e)
            }
          }
          invoker.value = nextValue
          // æ·»åŠ  invoker.attached å±æ€§ï¼Œå­˜å‚¨äº‹ä»¶å¤„ç†å‡½æ•°è¢«ç»‘å®šçš„æ—¶é—´
          invoker.attached = performance.now()
          el.addEventListener(name, invoker)
        } else {
          invoker.value = nextValue
        }
      } else if (invoker) {
        el.removeEventListener(name, invoker)
      }
    } else if (key === 'class') {
      // ...
    } else if (shouldSetAsProps(el, key, nextValue)) {
      // ...
    } else {
      // ...
    }
  }
```

è¿™é‡Œæœ‰å¿…è¦æŒ‡å‡ºï¼Œåœ¨å…³äºæ—¶é—´å­˜å‚¨å’Œæ¯”è¾ƒæ–¹é¢ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é«˜ç²¾ç¡®åº¦çš„ `performance.now()`ã€‚ä½†æ ¹æ®æµè§ˆå™¨çš„ä¸åŒï¼Œ`e.timeStamp`(äº‹ä»¶è§¦å‘çš„æ—¶é—´) çš„å€¼ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚å®ƒå³å¯èƒ½æ˜¯é«˜ç²¾ç¡®åº¦çš„æ—¶é—´ï¼Œä¹Ÿå¯èƒ½æ˜¯éé«˜ç²¾ç¡®åº¦çš„æ—¶é—´ã€‚å› æ­¤ï¼Œä¸¥æ ¼æ¥è®²ï¼Œè¿™é‡Œéœ€è¦åšå…¼å®¹å¤„ç†ã€‚ä¸è¿‡åœ¨ Chrome 49ã€Firefox 54ã€Opera 36 ä»¥åŠä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œ`e.timeStamp` çš„å€¼éƒ½æ˜¯é«˜ç²¾ç¡®åº¦çš„æ—¶é—´ã€‚

## æ–‡æœ¬èŠ‚ç‚¹å’Œæ³¨é‡ŠèŠ‚ç‚¹

åœ¨ä¹‹å‰ï¼Œæˆ‘ä»¬åªåˆ†æäº†ä¸€ç§ç±»å‹çš„ vnodeï¼Œå³ç”¨äºæè¿°æ™®é€šæ ‡ç­¾çš„ vnodeã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®¨è®ºå¦‚ä½•ç”¨è™šæ‹Ÿ DOM æè¿°æ›´å¤šç±»å‹çš„çœŸå® DOMã€‚å…¶ä¸­æœ€å¸¸è§çš„ä¸¤ç§èŠ‚ç‚¹ç±»å‹æ˜¯æ–‡æœ¬èŠ‚ç‚¹å’Œæ³¨é‡Šï¼š

```html
<div><!-- æ³¨é‡ŠèŠ‚ç‚¹-->æˆ‘æ˜¯æ–‡æœ¬èŠ‚ç‚¹</div>
```

é‚£ä¹ˆï¼Œå¦‚ä½•ä½¿ç”¨ vnode æ¥æè¿°æ³¨é‡ŠèŠ‚ç‚¹å’Œæ–‡æœ¬èŠ‚ç‚¹å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœ `vnode.type` å±æ€§èƒ½å¤Ÿä»£è¡¨ä¸€ä¸ª vnode çš„ç±»å‹ã€‚å¦‚æœ `vnode.type` çš„å€¼æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œåˆ™ä»£è¡¨å®ƒæè¿°çš„æ˜¯ä¸€ä¸ªæ™®é€šæ ‡ç­¾ï¼Œå¹¶ä¸”è¯¥å€¼å°±ä»£è¡¨æ ‡ç­¾çš„åç§°ã€‚ä½†æ³¨é‡ŠèŠ‚ç‚¹å’Œæ–‡æœ¬èŠ‚ç‚¹ä¸åŒäºæ™®é€šæ ‡ç­¾èŠ‚ç‚¹ï¼Œå®ƒä»¬ä¸å…·æœ‰æ ‡ç­¾åç§°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦äººä¸ºåˆ›é€ ä¸€äº›å”¯ä¸€çš„æ ‡è¯†ï¼Œå¹¶å°†å…¶ä½œä¸ºæ³¨é‡ŠèŠ‚ç‚¹å’Œæ–‡æœ¬èŠ‚ç‚¹çš„ type å±æ€§å€¼ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š

```js
const VNODE_TYPES = {
  Text: Symbol(),
  Comment: Symbol()
}

const newVnode = {
  type: VNODE_TYPES.Text,
  children: 'æˆ‘æ˜¯æ–‡æœ¬å†…å®¹'
}

const newVnode = {
  type: VNODE_TYPES.Comment,
  children: 'æˆ‘æ˜¯æ³¨é‡Šå†…å®¹'
}
```

æœ‰äº†æè¿°æ³¨é‡ŠèŠ‚ç‚¹å’Œæ–‡æœ¬èŠ‚ç‚¹çš„ vnode å¯¹è±¡åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨æ¸²æŸ“å™¨æ¥æ¸²æŸ“å®ƒä»¬äº†ï¼š

```js
function patch (n1, n2, container) {
  if (n1 && n1.type !== n2.type) {
    unmount(n1)
    n1 = null
  }

  const { type } = n2
  if (typeof type === 'string') {
    if (!n1) {
      mountElement(n2, container)
    } else {
      patchElement(n1, n2)
    }
  } else if (typeof type === 'object') {
    // å¦‚æœ n2.type æ˜¯å¯¹è±¡ï¼Œåˆ™å®ƒæè¿°çš„æ˜¯ç»„ä»¶
  } else if (type === VNODE_TYPES.Text) {
    // å¤„ç†æ–‡æœ¬èŠ‚ç‚¹
    if (!n1) {
      // å¦‚æœæ²¡æœ‰æ—§èŠ‚ç‚¹ï¼Œåˆ™è¿›è¡ŒæŒ‚è½½
      const el = n2.el = createText(n2.children)
      // å°†æ–‡æœ¬èŠ‚ç‚¹æ’å…¥åˆ°å®¹å™¨ä¸­
      insert(el, container)
    } else {
      // å¦‚æœæ—§ vnode å­˜åœ¨ï¼Œåªéœ€è¦ä½¿ç”¨æ–°æ–‡æœ¬èŠ‚ç‚¹çš„å†…å®¹æ›¿æ¢æ›´æ–°æ—§æ–‡æœ¬èŠ‚ç‚¹å³å¯
      const el = n2.el = n1.el
      if (n2.children !== n1.children) {
        setText(el, n2.children)
      }
    } else if (type === VNODE_TYPES.Comment) {
      if (!n1) {
        const el = n2.el = createComment(n2.children)
        insert(el, container)
      } else {
        const el = n2.el = n1.el
        if (n2.children !== n1.children) {
          setComment(el, n2.children)
        }
      }
    }
  }
}
```

æˆ‘ä»¬è¿˜éœ€è¦æŠŠæŠ½è±¡å‡ºæ¥çš„ `createText()` å’Œ `setText()` ç­‰æ–¹æ³•ç»™å°è£…åˆ°æ¸²æŸ“å™¨é€‰é¡¹ä¸­ï¼š

```js
const renderer = createRenderer({
  createElement(tag) {},
  setElementText (el, text) {},
  insert (el, parent, anchor = null) {},
  patchProps (el, key, prevValue, nextValue, shouldSetAsProps) {},
  // åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹
  createText (text) {
    return document.createTextNode(text)
  },
  // è®¾ç½®æ–‡æœ¬èŠ‚ç‚¹çš„å†…å®¹
  setText(el, text) {
    el.nodeValue = text
  },
  // åˆ›å»ºæ³¨é‡ŠèŠ‚ç‚¹
  createComment (comment) {
    return document.createComment(comment)
  },
  // è®¾ç½®æ³¨é‡ŠèŠ‚ç‚¹çš„å†…å®¹
  setComment (el, text) {
    el.nodeValue = text
  }
})
```

## Fragment

ä¸æ³¨é‡ŠèŠ‚ç‚¹å’Œæ–‡æœ¬èŠ‚ç‚¹ç±»ä¼¼ï¼Œç‰‡æ®µï¼ˆFragmentï¼‰ä¹Ÿæ²¡æœ‰æ‰€è°“çš„æ ‡ç­¾åç§°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸ºç‰‡æ®µåˆ›å»ºå”¯ä¸€æ ‡è¯†ï¼Œå³ Fragmentã€‚å¯¹äº Fragment ç±»å‹çš„ vnode æ¥è¯´ï¼Œå®ƒçš„ children å­˜å‚¨çš„å†…å®¹å°±æ˜¯æ¨¡æ¿ä¸­æ‰€æœ‰æ ¹èŠ‚ç‚¹ï¼š

```vue
<!-- Items.vue -->
<template>
	<li>1</li>
	<li>2</li>
	<li>3</li>
</template>
```

å¯¹åº”çš„ vnode å°±æ˜¯ï¼š

```js
const vnode = {
  type: VNODE_TYPE.Fragment,
  children: [
    { type: 'li', children: '1' },
    { type: 'li', children: '2' },
    { type: 'li', children: '3' }
  ]
}
```

å½“æ¸²æŸ“å™¨æ¸²æŸ“ Fragment ç±»å‹çš„è™šæ‹ŸèŠ‚ç‚¹æ—¶ï¼Œç”±äº Fragment æœ¬èº«å¹¶ä¸ä¼šæ¸²æŸ“ä»»ä½•å†…å®¹ï¼Œæ‰€ä»¥åªéœ€è¦å¤„ç† Fragment çš„å­èŠ‚ç‚¹å³å¯ï¼š

```js
function patch (n1, n2, container) {
    if (n1 && n1.type !== n2.type) {
      unmount(n1)
      n1 = null
    }

    const { type } = n2

    if (typeof type === 'string') {
      // ...
    } else if (typeof type === 'object') {
      // ...
    } else if (type === VNODE_TYPES.Text) {
      // ...
    } else if (type === VNODE_TYPES.Comment) {
      // ...
    } else if (type === VNODE_TYPES.Fragment) {
      // å¤„ç† Fragment ç±»å‹çš„ vnode
      if (!n1) {
        n2.children.forEach(child => patch(null, child, container))
      } else {
        // å¦‚æœæ—§ vnode å­˜åœ¨ï¼Œåˆ™åªéœ€è¦æ›´æ–° Fragment çš„ children å³å¯
        patchChildren(n1, n2, container)
      }
    }
  }
```

æœ¬è´¨ä¸Šæ¥è¯´ï¼Œæ¸²æŸ“ Fragment ä¸æ¸²æŸ“æ™®é€šå…ƒç´ çš„åŒºåˆ«åœ¨äº Fragment æœ¬èº«å¹¶ä¸æ¸²æŸ“ä»»ä½•å†…å®¹ï¼Œæ‰€ä»¥åªéœ€è¦å¤„ç†å®ƒçš„å­èŠ‚ç‚¹å³å¯ã€‚

ä½†ä»éœ€æ³¨æ„ä¸€ç‚¹ï¼Œ`unmount()` å‡½æ•°ä¹Ÿéœ€è¦æ”¯æŒ Fragment ç±»å‹çš„è™šæ‹ŸèŠ‚ç‚¹çš„å¸è½½ï¼š

```js
function unmount (vnode) {
  if (vnode.type === VNODE_TYPES.Fragment) {
    vnode.children.forEach(c => unmount(c))
    return
  }

  // è·å– el çš„çˆ¶å…ƒç´ 
  const parent = vnode.el.parentNode
  // è°ƒç”¨çˆ¶å…ƒç´ çš„ removeChild ç§»é™¤å…ƒç´ 
  if (parent) {
    parent.removeChild(vnode.el)
  }
}
```

åŒæ ·åªéœ€è¦å¸è½½å…¶ children å³å¯ã€‚

## ğŸš€ ç« èŠ‚é“¾æ¥

- ä¸Šä¸€ç« ï¼š[æ¸²æŸ“å™¨çš„è®¾è®¡](https://github.com/humandetail/VueJS-design-and-implementation/blob/master/notes/6.%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1.md)

- ä¸‹ä¸€ç« : [ç®€å•çš„ Diff ç®—æ³•](https://github.com/humandetail/VueJS-design-and-implementation/blob/master/notes/8.%E7%AE%80%E5%8D%95%E7%9A%84%20Diff%20%E7%AE%97%E6%B3%95.md)