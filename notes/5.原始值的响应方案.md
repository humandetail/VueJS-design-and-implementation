# åŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ

æˆ‘ä»¬çŸ¥é“ï¼ŒProxy åªèƒ½ä»£ç†éåŸå§‹å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬æ²¡åŠæ³•æ‹¦æˆªåŸå§‹å€¼çš„æ“ä½œï¼Œä¾‹å¦‚ï¼š

```js
let a = 1
a = 2 // æ— æ³•æ‹¦æˆª
```

## å¼•å…¥ ref çš„æ¦‚å¿µ

å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæƒ³åˆ°çš„å”¯ä¸€åŠæ³•å°±æ˜¯ï¼ŒæŠŠåŸå§‹å€¼åŒ…è£¹èµ·æ¥ï¼š

```js
const wrapper = {
  value: 'vue'
}
// å¯ä»¥ä½¿ç”¨ Proxy ä»£ç† wrapperï¼Œé—´æ¥å®ç°å¯¹åŸå§‹å€¼çš„æ‹¦æˆª
const name = reactive(wrapper)

console.log(wrapper.value) // vue
// ä¿®æ”¹å€¼å¯ä»¥è§¦å‘å“åº”
name.value = 'vue3'
```

ä½†è¿™æ ·åšä¼šå¯¼è‡´ä¸¤ä¸ªé—®é¢˜ï¼š

1. ç”¨æˆ·ä¸ºäº†åˆ›å»ºä¸€ä¸ªå“åº”å¼çš„åŸå§‹å€¼ï¼Œä¸å¾—ä¸é¡ºå¸¦åˆ›å»ºä¸€ä¸ªåŒ…è£¹å¯¹è±¡ï¼›
2. åŒ…è£¹å¯¹è±¡ç”±ç”¨æˆ·å®šä¹‰ï¼Œæ„å‘³ç€ä¸è§„èŒƒã€‚ç”¨æˆ·å¯ä»¥éšä¾¿å‘½åï¼Œä¾‹å¦‚ï¼šwrapper.value æˆ– wrapper.val éƒ½æ˜¯å¯ä»¥çš„ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å°è£…ä¸€ä¸ªå‡½æ•°ï¼Œå°†åŒ…è£¹å¯¹è±¡çš„åˆ›å»ºå·¥ä½œéƒ½å°è£…åˆ°è¯¥å‡½æ•°ä¸­ï¼š

```js
// å°è£…ä¸€ä¸ª ref å‡½æ•°
function ref (val) {
  // åœ¨ ref å‡½æ•°å†…éƒ¨åˆ›å»ºåŒ…è£¹å¯¹è±¡
  const wrapper = {
    value: val
  }

  // å°†åŒ…è£¹å¯¹è±¡å˜æˆå“åº”å¼æ•°æ®
  return reactive(wrapper)
}
```

è¿™æ ·æˆ‘ä»¬å°±è§£å†³äº†ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜ã€‚è¿è¡Œå¦‚ä¸‹æµ‹è¯•ä»£ç ï¼š

```js
const refVal = ref(1)
effect(() => {
  console.log(refVal.value)
})

refVal.value = 2
```

ä¸Šé¢è¿™æ®µä»£ç èƒ½å¤Ÿé¢„æœŸå·¥ä½œï¼Œç°åœ¨æ˜¯å¦ä¸€åˆ‡éƒ½å®Œç¾äº†å‘¢ï¼Ÿ

å¹¶ä¸æ˜¯ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•åŒºåˆ† refVal åˆ°åº•æ˜¯ä¸€ä¸ªåŸå§‹å€¼çš„åŒ…è£¹å¯¹è±¡ï¼Œè¿˜æ˜¯ä¸€ä¸ªéåŸå§‹å€¼çš„å“åº”å¼æ•°æ®ï¼Ÿå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š

```js
const refVal1 = ref(1)
const refVal2 = reactive({ value: 1 })
```

ä»æˆ‘ä»¬çš„å®ç°æ¥çœ‹ï¼Œä¸Šé¢çš„ refVal1 å’Œ refVal2 å¹¶æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬æœ‰å¿…è¦åŒºåˆ†ä¸€ä¸ªæ•°æ®åˆ°åº•æ˜¯ä¸æ˜¯ refï¼Œå› ä¸ºè¿™æ¶‰åŠåˆ°åé¢è®²è§£çš„è‡ªåŠ¨è„± ref èƒ½åŠ›ã€‚

æˆ‘ä»¬é€šè¿‡ç»™ ref å¢åŠ ä¸€ä¸ªä¸å¯æšä¸¾ä¹Ÿä¸å¯å†™çš„å±æ€§ `__v_isRef`ï¼Œæ¥è¡¨ç¤ºä¸€ä¸ªæ•°æ®æ˜¯å¦ä¸º refï¼š

```js
// å°è£…ä¸€ä¸ª ref å‡½æ•°
function ref (val) {
  // åœ¨ ref å‡½æ•°å†…éƒ¨åˆ›å»ºåŒ…è£¹å¯¹è±¡
  const wrapper = {
    value: val
  }

  // ä½¿ç”¨ Object.defineProperty ç»™ wrapper åŠ ä¸Šä¸€ä¸ªä¸å¯å†™ã€ä¸å¯æšä¸¾çš„å±æ€§
  Object.defineProperty(wrapper, '__v_isRef', {
    value: true
  })

  // å°†åŒ…è£¹å¯¹è±¡å˜æˆå“åº”å¼æ•°æ®
  return reactive(wrapper)
}
```

## å“åº”å¼ä¸¢å¤±é—®é¢˜

ref é™¤äº†èƒ½å¤Ÿç”¨äºåŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆä¹‹å¤–ï¼Œè¿˜èƒ½ç”¨æ¥è§£å†³å“åº”ä¸¢å¤±é—®é¢˜ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯å“åº”ä¸¢å¤±é—®é¢˜ï¼Œåœ¨ç¼–å†™ Vue.js ç»„ä»¶æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸è¦æŠŠæ•°æ®æš´éœ²åˆ°æ¨¡æ¿ä¸­ä½¿ç”¨ï¼š

```vue
<template>
	<div>{{ foo }} / {{ bar }} </div>
</template>

<script>
export default {
  setup () {
    const obj = reactive({ foo: 1, bar: 2 })
    
    setTimeout(() => {
      obj.foo = 10
    }, 1000)
    
    return {
      ...obj
    }
  }
}
</script>
```

è¿™æ ·åšä¼šå¯¼è‡´å“åº”ä¸¢å¤±ã€‚å…¶è¡¨ç°æ˜¯ï¼Œå½“æˆ‘ä»¬ä¿®æ”¹å“åº”å¼æ•°æ®çš„å€¼æ—¶ï¼Œä¸ä¼šè§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚

é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå¯¼è‡´å“åº”å¼ä¸¢å¤±å‘¢ï¼Ÿè¿™æ˜¯ç”±å±•å¼€è¿ç®—ç¬¦å¯¼è‡´çš„ï¼š

```js
return {
  ...obj
}
// ç­‰ä»·äº
return {
	foo: 1,
  bar: 2
}
```

å¯ä»¥çœ‹åˆ°ï¼Œè¿™å…¶å®å°±æ˜¯è¿”å›äº†ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œå®ƒä¸å…·æœ‰ä»»ä½•å“åº”å¼èƒ½åŠ›ã€‚

æˆ‘ä»¬å¯ä»¥ç”¨å¦ä¸€ä¸ªæ–¹å¼æ¥æè¿°å“åº”ä¸¢å¤±é—®é¢˜ï¼š

```js
const obj = reactive({ foo: 1, bar: 2 })

const newObj = {
  ...obj
}

effect(() => {
  console.log(newObj.foo)
})

obj.foo = 10
```

å¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬åœ¨ä¿®æ”¹ obj.foo çš„å€¼æ—¶ï¼Œä¸ä¼šè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚

å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæ¢å¥è¯è¯´ï¼Œæœ‰æ²¡æœ‰åŠæ³•èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å®ç°ï¼šåœ¨å‰¯ä½œç”¨å‡½æ•°å†…ï¼Œå³ä½¿é€šè¿‡æ™®é€šå¯¹è±¡ newObj æ¥è®¿é—®å±æ€§å€¼ï¼Œä¹Ÿèƒ½å¤Ÿå»ºç«‹å“åº”è”ç³»ï¼Ÿå…¶å®æ˜¯å¯ä»¥çš„ï¼š

```js
const obj = reactive({ foo: 1, bar: 2 })

const newObj = {
  foo: {
    get value () {
      return obj.foo
    }
  },

  var: {
    get value () {
      return obj.bar
    }
  }
}

effect(() => {
  console.log(newObj.foo)
})

obj.foo = 10
```

å¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘ä»¬è®¿é—® newObj.foo æ—¶é—´æ¥è®¿é—®äº† obj.foo çš„å€¼ï¼Œä»è€Œå®ç°äº†ä¿®æ”¹ obj.foo æ—¶ä¼šè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œã€‚

è§‚å¯Ÿä¸€ä¸‹ newObj å¯¹è±¡ï¼Œå¯ä»¥å‘ç°å®ƒçš„ç»“æ„å­˜åœ¨ç›¸ä¼¼ä¹‹å¤„ï¼šfoo å’Œ bar è¿™ä¸¤ä¸ªå±æ€§çš„ç»“æ„éå¸¸ç›¸ä¼¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠè¿™ç§ç»“æ„æŠ½è±¡å‡ºæ¥å¹¶å°è£…æˆé€šç”¨å‡½æ•°ï¼š

```js
function toRef (obj, key) {
  const wrapper = {
    get value () {
      return obj[key]
    }
  }

  return wrapper
}
```

è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥é‡æ–°å®ç° newObj å¯¹è±¡äº†ï¼š

```js
const newObj = {
  foo: toRef(obj, 'foo'),
  bar: toRef(obj, 'bar')
}
```

å¯ä»¥çœ‹åˆ°ï¼Œä»£ç å˜å¾—éå¸¸ç®€æ´ã€‚ä½†å¦‚æœå“åº”å¼æ•°æ® obj çš„é”®éå¸¸å¤šï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦èŠ±è´¹å¾ˆå¤§åŠ›æ°”æ¥åšè¿™ä¸€å±‚è½¬æ¢ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°è£…ä¸€ä¸ª toRefs å‡½æ•°ï¼Œæ¥æ‰¹é‡åœ°å®Œæˆè½¬æ¢ï¼š

```js
function toRefs (obj) {
  const wrapper = {}

  for (const key in obj) {
    wrapper[key] = toRef(obj, key)
  }

  return wrapper
}
```

ç°åœ¨ï¼Œå“åº”ä¸¢å¤±é—®é¢˜å°±è¢«æˆ‘ä»¬å½»åº•è§£å†³äº†ã€‚ä½†ä¸ºäº†æ¦‚å¿µä¸Šçš„ç»Ÿä¸€ï¼Œæˆ‘ä»¬å°†é€šè¿‡ toRef æˆ– toRefs è½¬æ¢åå¾—åˆ°çš„ç»“æœè§†ä¸ºç›´æ¥çš„ ref æ•°æ®ï¼Œä¸ºæ­¤æˆ‘ä»¬è¿˜éœ€è¦ä¸º toRef å‡½æ•°å¢åŠ ä¸€æ®µä»£ç ï¼š

```js
function toRef (obj, key) {
  const wrapper = {
    get value () {
      return obj[key]
    }
  }

  // ä½¿ç”¨ Object.defineProperty ç»™ wrapper åŠ ä¸Šä¸€ä¸ªä¸å¯å†™ã€ä¸å¯æšä¸¾çš„å±æ€§
  Object.defineProperty(wrapper, '__v_isRef', {
    value: true
  })

  return wrapper
}
```

ä½†ä¸Šé¢çš„ toRef å‡½æ•°è¿˜æ˜¯æœ‰ç¼ºé™·çš„ï¼Œå®ƒåˆ›å»ºçš„ ref æ˜¯åªè¯»çš„ï¼Œæ— æ³•ä¿®æ”¹å€¼ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä¸ºå®ƒåŠ ä¸Š setter å‡½æ•°ï¼š

```js
function toRef (obj, key) {
  const wrapper = {
    get value () {
      return obj[key]
    },

    set value (val) {
      obj[key] = val
    }
  }

  // ä½¿ç”¨ Object.defineProperty ç»™ wrapper åŠ ä¸Šä¸€ä¸ªä¸å¯å†™ã€ä¸å¯æšä¸¾çš„å±æ€§
  Object.defineProperty(wrapper, '__v_isRef', {
    value: true
  })

  return wrapper
}
```

## è‡ªåŠ¨è„± ref

toRefs å‡½æ•°çš„ç¡®è§£å†³äº†å“åº”ä¸¢å¤±é—®é¢˜ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†æ–°çš„é—®é¢˜ï¼Œå› ä¸º ref å¿…é¡»é€šè¿‡ value å±æ€§æ¥è®¿é—®å€¼ã€‚è¿™ä¼šå¢åŠ ç”¨æˆ·çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œå› ä¸ºé€šå¸¸ç”¨æˆ·æ˜¯åœ¨æ¨¡æ¿ä¸­è®¿é—®æ•°æ®çš„ï¼š

```vue
<template>
	<div>{{ foo }} / {{ bar }}</div>
</template>
```

ç”¨æˆ·è‚¯å®šä¸å¸Œæœ›ç¼–å†™ä¸‹é¢è¿™æ ·çš„ä»£ç ï¼š

```vue
<template>
	<div>{{ foo.value }} / {{ bar.value }}</div>
</template>
```

æ‰€ä»¥æˆ‘ä»¬éœ€è¦è‡ªåŠ¨è„± ref çš„èƒ½åŠ›ã€‚æ‰€è°“è‡ªåŠ¨è„± refï¼ŒæŒ‡çš„æ˜¯å±æ€§çš„è®¿é—®è¡Œä¸ºï¼Œå³å¦‚æœè¯»å–çš„å±æ€§æ˜¯ä¸€ä¸ª refï¼Œåˆ™ç›´æ¥å°†è¯¥ ref å¯¹åº”çš„ value å±æ€§è¿”å›ï¼Œä¾‹å¦‚ï¼š

```js
newObj.foo // 1
```

å¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿ newObj.foo æ˜¯ä¸€ä¸ª refï¼Œä¹Ÿæ— é¡»é€šè¿‡ newObj.foo.value æ¥è®¿é—®å®ƒçš„å€¼ã€‚è¦å®ç°æ­¤åŠŸèƒ½ï¼Œéœ€è¦ä½¿ç”¨ Proxy ä¸º newObj åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œé€šè¿‡ä»£ç†æ¥å®ç°æœ€ç»ˆç›®æ ‡ï¼Œè¿™æ—¶å°±ç”¨åˆ°äº†ä¹‹å‰ä»‹ç»çš„ __v_isRef å±æ€§ï¼š

```js
function proxyRefs (target) {
  return new Proxy(target, {
    get (target, key, receiver) {
      const value = Reflect.get(target, key, receiver)

      return value.__v_isRef ? value.value : value
    }
  })
}

// é€šè¿‡ proxyRefs å‡½æ•°åˆ›å»ºä»£ç 
const newObj = proxyRefs({ ...toRefs(obj) })
```

è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†è‡ªåŠ¨è„± ref èƒ½åŠ›ã€‚å®é™…ä¸Šï¼Œåœ¨ Vue.js ç»„ä»¶ä¸­çš„ setup å‡½æ•°è¿”å›çš„æ•°æ®éƒ½ä¼šä¼ é€’ç»™ proxyRefs å‡½æ•°è¿›è¡Œå¤„ç†ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨æ¨¡æ¿ç›´æ¥è®¿é—®ä¸€ä¸ª ref çš„å€¼ï¼Œè€Œä¸éœ€è¦é€šè¿‡ value å±æ€§æ¥è®¿é—®ã€‚

æ—¢ç„¶è¯»å–å±æ€§çš„å€¼æœ‰è‡ªåŠ¨è„± ref çš„èƒ½åŠ›ï¼Œå¯¹åº”åœ°ï¼Œè®¾ç½®å±æ€§çš„å€¼ä¹Ÿåº”è¯¥æœ‰è‡ªåŠ¨ä¸º ref è®¾ç½®çš„èƒ½åŠ›ï¼Œä¾‹å¦‚ï¼š

```js
newObj.foo = 10 // åº”è¯¥ç”Ÿæ•ˆ
```

å®ç°æ­¤åŠŸèƒ½å¾ˆç®€å•ï¼Œåªéœ€è¦æ·»åŠ å¯¹åº”çš„ `set()` æ‹¦æˆªå‡½æ•°å³å¯ï¼š

```js
function proxyRefs (target) {
  return new Proxy(target, {
    get (target, key, receiver) {
      const value = Reflect.get(target, key, receiver)

      return value.__v_isRef ? value.value : value
    },

    set (target, key, newValue, receiver) {
      const value = target[key]

      if (value.__v_isRef) {
        value.value = newValue
        return true
      }

      return Reflect.set(target, key, newValue, receiver)
    }
  })
}
```

å®é™…ä¸Šï¼Œè‡ªåŠ¨è„± ref ä¸ä»…å­˜åœ¨äºä¸Šè¿°åœºæ™¯ã€‚åœ¨ Vue.js ä¸­ï¼Œ`reactive()` å‡½æ•°ä¹Ÿæœ‰è‡ªåŠ¨è„± ref çš„èƒ½åŠ›ï¼š

```js
const count = ref(0)
const obj = reactive(count)

obj.count = 0
```

è¿™æ ·è®¾è®¡æ—¨åœ¨å‡è½»ç”¨æˆ·çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œå› ä¸ºåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¹¶ä¸çŸ¥é“ä¸€ä¸ªå€¼åˆ°åº•æ˜¯ä¸æ˜¯ refã€‚æœ‰äº†è‡ªåŠ¨è„± ref çš„èƒ½åŠ›åï¼Œç”¨æˆ·åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨å“åº”å¼æ•°æ®æ—¶å°†ä¸å†éœ€è¦å…³å¿ƒå“ªäº›æ˜¯ refï¼Œå“ªäº›ä¸æ˜¯ refã€‚

## ğŸš€ ç« èŠ‚é“¾æ¥

- ä¸Šä¸€ç« ï¼š[éåŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ](https://github.com/humandetail/VueJS-design-and-implementation/blob/master/notes/4.%E9%9D%9E%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%96%B9%E6%A1%88.md)

- ä¸‹ä¸€ç« : [æ¸²æŸ“å™¨çš„è®¾è®¡](https://github.com/humandetail/VueJS-design-and-implementation/blob/master/notes/6.%E6%B8%B2%E6%9F%93%E5%99%A8%E7%9A%84%E8%AE%BE%E8%AE%A1.md)