# æ¡†æ¶è®¾è®¡çš„æ ¸å¿ƒè¦ç´ 

## æå‡ç”¨æˆ·çš„å¼€å‘ä½“éªŒ

1. å¿…è¦çš„è­¦å‘Šä¿¡æ¯

   åˆç†çš„è­¦å‘Šä¿¡æ¯ï¼Œèƒ½è®©ç”¨æˆ·æ›´æ¸…æ™°ä¸”å¿«é€Ÿåœ°å®šä½é—®é¢˜ã€‚

   ```js
   const mount = function (el) {
     document.querySelector(el).appendChild(document.createTextNode('Hello world.'))
   }
   
   mount('#not-exists') // Uncaught TypeError: Cannot read properties of null (reading 'appendChild')
   ```

   æ ¹æ®æ­¤ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯èƒ½å¾ˆéš¾å»å®šä½é—®é¢˜å‡ºåœ¨å“ªé‡Œã€‚æ‰€ä»¥åœ¨è®¾è®¡æ¡†æ¶æ—¶ï¼Œéœ€è¦æä¾›æ›´ä¸ºæœ‰ç”¨çš„ä¿¡æ¯æ¥å¸®åŠ©ç”¨æˆ·å®šä½é—®é¢˜ã€‚

   ```js
   const mount = function (el) {
     const container = document.querySelector(el)
   
     if (!container) {
       throw new Error(
         `Target selector "${el}" returned null.`
       )
     }
     container.appendChild(document.createTextNode('Hello world.'))
   }
   
   mount('#not-exists')
   ```

2. ç›´è§‚çš„è¾“å‡ºå†…å®¹

   åœ¨ Vue.js 3 ä¸­ï¼Œå½“æˆ‘ä»¬åœ¨æ§åˆ¶å°æ‰“å°ä¸€ä¸ª Ref æ•°æ®æ—¶ï¼š

   ```js
   const count = Vue.ref(0)
       console.log(count) // RefImplÂ {__v_isShallow: false, dep: undefined, __v_isRef: true, _rawValue: 0, _value: 0}
   ```

   è¿™æ ·çš„æ•°æ®é˜…è¯»èµ·æ¥æ˜¯ä¸å‹å¥½çš„ã€‚

   æ‰€ä»¥åœ¨ Vue.js 3 çš„æºç ä¸­æä¾›äº† `initCustomFormatter` çš„å‡½æ•°ç”¨äºåœ¨å¼€å‘ç¯å¢ƒåˆå§‹åŒ–è‡ªå®šä¹‰çš„ formatterã€‚

   åœ¨ Chrome æµè§ˆå™¨ä¸­å¯ä»¥é€šè¿‡ `è®¾ç½® -> æ§åˆ¶å° -> å¯ç”¨è‡ªå®šä¹‰æ ¼å¼è®¾ç½®å·¥å…·` æ¥å¼€å¯ã€‚

   ```js
   const count = Vue.ref(0)
       console.log(count) // Ref<0>
   ```

## æ§åˆ¶æ¡†æ¶ä»£ç çš„ä½“ç§¯

åœ¨ Vue.js 3 çš„æºç ä¸­ï¼Œé€šè¿‡ä¸€äº›ç¯å¢ƒå¸¸é‡æ¥å†³å®šæŸäº›ä»£ç åªä¼šåœ¨ç‰¹å®šçš„ç¯å¢ƒä¸­ç”Ÿæ•ˆï¼š

```js
if (__DEV__ && !res) {
  warn(
  	`Failed to mount app: mount target selector "${container}" returned null.`
  )
}
```

è¿™é‡Œçš„ `__DEV__` å¸¸é‡å®é™…ä¸Šæ˜¯é€šè¿‡ rollup.js çš„æ’ä»¶é…ç½®æ¥é¢„å®šä¹‰çš„ã€‚

åœ¨å¼€å‘ç¯å¢ƒçš„ç‰ˆæœ¬ä¸­ `__DEV__` ä¼šè¢«è®¾ç½®ä¸º trueï¼Œä¸Šé¢çš„ä»£ç å°±ç›¸å½“äºï¼š

```js
if (true && !res) {
  warn(
  	`Failed to mount app: mount target selector "${container}" returned null.`
  )
}
```

è€Œåœ¨ç”Ÿäº§ç‰ˆæœ¬ä¸­ `__DEV__` ä¼šè¢«è®¾ç½®ä¸º falseï¼Œä¸Šé¢çš„ä»£ç ç­‰ä»·äºï¼š

```js
if (false && !res) {
  warn(
  	`Failed to mount app: mount target selector "${container}" returned null.`
  )
}
```

æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œè¿™æ®µä»£ç å®ƒçš„åˆ¤æ–­æ¡ä»¶å‡ï¼Œæ‰€ä»¥å®ƒæ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œï¼Œè¿™ç§ä»£ç ç§°ä¸º dead codeï¼Œåœ¨æ„å»ºèµ„æºçš„æ—¶å€™ä¼šè¢«ç§»é™¤ã€‚

## è‰¯å¥½çš„ Tree-Shaking

ä»…ä»…é€šè¿‡ç¯å¢ƒå¸¸é‡çš„å½¢å¼æ¥æ’é™¤ dead code æ˜¯ä¸å¤Ÿçš„ã€‚

```js
// utils.js
export function foo (obj) {
  obj && obj.foo
}

export function bar () {
  obj && obj.bar
}

// input.js
import { foo } from 'utils'
foo()
```

åƒä¸Šé¢çš„è¿™ç§æƒ…å†µï¼Œbar() å¹¶æœªè¢«ä½¿ç”¨åˆ°ï¼Œé‚£ä¹ˆå®ƒå°±ä¸åº”è¯¥å‡ºç°åœ¨æ‰“åŒ…åçš„ä»£ç ä¸­ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°±éœ€è¦ Tree-Shakingã€‚

ç®€å•åœ°è¯´ï¼ŒTree-Shaking æŒ‡çš„å°±æ˜¯æ¶ˆé™¤é‚£äº›æ°¸è¿œä¸ä¼šè¢«æ‰§è¡Œçš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯ dead codeã€‚

æƒ³è¦å®ç° Tree-Shakingï¼Œå¿…é¡»è¦æ»¡è¶³ä¸€ä¸ªæ¡ä»¶ï¼šæ¨¡å—å¿…é¡»æ˜¯ ESM(ES Module)ã€‚å› ä¸º Tree-Shaking ä¾èµ– ESM çš„é™æ€ç»“æ„ã€‚æˆ‘ä»¬ä»¥ rollup.js ä¸ºä¾‹çœ‹çœ‹ Tree-Shaking å¦‚ä½•å·¥ä½œï¼š

è¿˜æ˜¯ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬é€šè¿‡ rollup.js è¿›è¡Œæ„å»º

```shell
npx rollup input.js -f esm -o bundle.js
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ° bundle.js ä¸­å¹¶æœªåŒ…å« `bar()` å‡½æ•°çš„å†…å®¹ï¼š

```js
// bundle.js
function foo (obj) {
  obj && obj.foo;
}

foo();
```

è¿™å°±è¯´æ˜ Tree-Shaking èµ·äº†ä½œç”¨ã€‚ç”±äºæˆ‘ä»¬å¹¶æœªä½¿ç”¨åˆ° `bar()` å‡½æ•°çš„å†…å®¹ï¼Œå› æ­¤å®ƒè¢«ä½œä¸º dead code åˆ é™¤äº†ã€‚ä½†æ˜¯æˆ‘ä»¬é€šè¿‡ä»£ç å¯ä»¥å‘ç°ï¼Œ`foo()` å‡½æ•°ä¼¼ä¹æ²¡ä»€ä¹ˆä½œç”¨ï¼šå®ƒä»…ä»…æ˜¯è¯»å–äº†å¯¹è±¡ä¸­çš„å€¼ã€‚æŠŠè¿™æ®µä»£ç åˆ äº†ä¹Ÿä¸ä¼šå¯¹æˆ‘ä»¬çš„ç¨‹åºäº§ç”Ÿå½±å“ï¼Œé‚£ä¹ˆ rollup.js ä¸ºä»€ä¹ˆä¸æŠŠè¿™æ®µä»£ç ä¹Ÿä½œä¸º dead code åˆ é™¤æ‰å‘¢ï¼Ÿ

æˆ‘ä»¬æŠŠ input.js ä¸­çš„ä»£ç æ”¹é€ ä¸€ä¸‹ï¼š

```js
import { foo } from './utils'

const log = {
  count: 0
}

const obj = Proxy({}, {
  get (target, prop) {
    log.count++
    return target[prop]
  }
})

foo(obj)
```

åœ¨æˆ‘ä»¬è¯»å– obj ä¸­çš„æŸä¸ªå±æ€§æ—¶ï¼Œä¼šè®°å½•å®ƒçš„è¯»å–æ¬¡æ•°ã€‚

è¿™ä¹Ÿå°±æ˜¯ Tree-Shaking ä¸­çš„ç¬¬äºŒä¸ªå…³é”®ç‚¹â€”â€”å‰¯ä½œç”¨ã€‚`foo()` å‡½æ•°çš„è°ƒç”¨ï¼Œä¼šäº§ç”Ÿå‰¯ä½œç”¨ï¼Œé‚£ä¹ˆå°±ä¸èƒ½å°†å…¶ç§»é™¤ã€‚

ä¼šä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨ï¼Œæˆ‘ä»¬åªæœ‰åœ¨ä»£ç è¿è¡Œçš„æ—¶å€™æ‰ä¼šçŸ¥é“ï¼ŒJavaScript æœ¬èº«æ˜¯åŠ¨æ€è¯­è¨€ï¼Œå› æ­¤æƒ³è¦é™æ€åœ°åˆ†æå“ªäº›ä»£ç æ˜¯ dead code æ˜¯éå¸¸å›°éš¾çš„ã€‚

å› æ­¤ï¼Œåƒ rollup.js è¿™ç±»å·¥å…·æä¾›äº†ä¸€ä¸ªæœºåˆ¶ï¼Œè®©æˆ‘ä»¬å¼€å‘æ˜ç¡®åœ°å‘Šè¯‰æ„å»ºå·¥å…·æŸäº›ä»£ç æ˜¯ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨ï¼Œä½ å¯ä»¥æ”¾å¿ƒåœ°ç§»é™¤å®ƒã€‚æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ input.jsï¼š

```js
import { foo } from './utils'

/*#__PURE__*/ foo()

```

é€šè¿‡ `/*#__PURE__*/` æ³¨é‡Šå‘Šè¯‰æ„å»ºå·¥å…·ï¼Œæˆ‘è¿™æ®µä»£ç æ˜¯çº¯çš„ï¼Œä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨ã€‚æ­¤æ—¶æˆ‘ä»¬å†æ‰§è¡Œæ„å»ºå‘½ä»¤ï¼Œä¼šå‘ç° `bundle.js` é‡Œé¢æ˜¯ç©ºçš„ï¼Œè¿™è¯´æ˜ Tree-Shaking ç”Ÿæ•ˆäº†ã€‚

## æ¡†æ¶åº”è¾“å‡ºä»€ä¹ˆæ ·çš„æ„å»ºäº§ç‰©

æˆ‘ä»¬éœ€è¦é’ˆå¯¹ä¸åŒçš„è¿è¡Œç¯å¢ƒæä¾›ä¸åŒçš„æ„å»ºäº§ç‰©ã€‚é€šè¿‡åœ¨ rollup.config.js ä¸­é…ç½®

1. `iife`ï¼šscript æ ‡ç­¾ç›´æ¥å¼•ç”¨
2. `esm`ï¼š`<script type="module">`
3. `cjs`ï¼šCommonJS

```js
export default {
  input: 'input.js',
  output: {
    file: 'output.js',
    format: 'iife' // æŒ‡å®šæ¨¡å—å½¢å¼
  }
}
```

## ç‰¹æ€§å¼€å…³

ä¸€ä¸ªç‰¹æ€§å¯¹åº”ä¸€ä¸ªå¼€å…³ï¼Œé€šè¿‡å¼€å…³çš„å½¢å¼æ¥å†³å®šæ˜¯å¦éœ€è¦æŸäº›ä»£ç ï¼Œä»è€Œå‡å°èµ„æºçš„ä½“ç§¯ã€‚

## é”™è¯¯å¤„ç†

æä¾›ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¥å£ï¼Œå¹¶ä¸”è®©ç”¨æˆ·å¯ä»¥è‡ªè¡Œçš„æ³¨å†Œé”™è¯¯å¤„ç†å‡½æ•°æ¥å¤„ç†é”™è¯¯ï¼š

```js
// utils.js
let handleError = null

export default {
  foo (fn) {
    callWithErrorHandling(fn)
  },
  
  registerErrorHandler (fn) {
    handleError = fn
  }
}

function callWithErrorHandling (fn) {
  try {
    fn && fn()
  } catch (e) {
    handleError(e)
  }
}
```

## è‰¯å¥½çš„ TypeScript æ”¯æŒ

- ç•¥

## ğŸš€ ç« èŠ‚é“¾æ¥

- ä¸‹ä¸€ç« : [Vue.js 3 çš„è®¾è®¡æ€è·¯](https://github.com/humandetail/VueJS-design-and-implementation/blob/master/notes/2.Vue.js%203%20%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF.md)