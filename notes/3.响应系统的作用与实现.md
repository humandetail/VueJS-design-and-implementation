# å“åº”ç³»ç»Ÿçš„ä½œç”¨ä¸å®ç°

## å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°

ä¸€åˆ‡éçº¯å‡½æ•°ï¼ˆåŒæ ·çš„è¾“å…¥å¯¹åº”åŒæ ·çš„è¾“å‡ºï¼‰éƒ½æ˜¯æœ‰å‰¯ä½œç”¨çš„å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´å‰¯ä½œç”¨å‡½æ•°å†…éƒ¨ä¼šç›´æ¥æˆ–é—´æ¥åœ°å½±å“åˆ°å¤–éƒ¨å˜é‡æˆ–å‡½æ•°ã€‚å‰¯ä½œç”¨å‡½æ•°å¾ˆå®¹æ˜“äº§ç”Ÿï¼š

```js
function effect () {
  document.body.textContent = 'Hello world.'
}
```

å½“ `effect()` å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šæ”¹å˜ document.body çš„æ–‡æœ¬å†…å®¹ï¼Œä½†æ˜¯ document.body ä¹Ÿå¯ä»¥è¢« `effect()` å‡½æ•°ä¹‹å¤–çš„ä»»æ„å‡½æ•°è¯»å–æˆ–è®¾ç½®ã€‚

ä¸€ä¸ªå‡½æ•°ä¿®æ”¹äº†å…¨å±€å˜é‡ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå‰¯ä½œç”¨ï¼š

```js
let a = 1

function effect () {
  a = 2
}
```

ä»€ä¹ˆæ˜¯å“åº”å¼æ•°æ®ï¼Ÿ

```js
const obj = { text: 'Hello world.' }

function effect () {
  document.body.textContent = obj.text
}
```

å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼š`effect()` å‡½æ•°çš„æ‰§è¡Œï¼Œä¼šè®¾ç½® document.body çš„ textContent å±æ€§ï¼Œå…¶å€¼ä¸º obj.textï¼ŒåŒæ—¶æˆ‘ä»¬å¸Œæœ›åœ¨ obj.text çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šé‡æ–°æ‰§è¡Œ `effect()` å‡½æ•°ã€‚

å¦‚æœæˆ‘ä»¬èƒ½å®ç°è¿™ä¸ªç›®æ ‡ï¼Œé‚£ä¹ˆ obj å°±å¯ä»¥ç§°ä¸ºå“åº”å¼æ•°æ®ã€‚

æ˜¾ç„¶ï¼Œä¸Šé¢çš„ä»£ç æ— æ³•å®ç°è¿™ä¸€ç‚¹ï¼Œå› ä¸º obj åªæ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ã€‚

## å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°

é€šè¿‡ä¸Šé¢çš„è§‚å¯Ÿï¼Œæˆ‘ä»¬å‘ç°ï¼š

1. å½“ `effect()` å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šè§¦å‘ obj.text çš„**è¯»å–æ“ä½œ**ï¼›
2. å½“ä¿®æ”¹ obj.text çš„å€¼æ—¶ï¼Œä¼šè§¦å‘ obj.text çš„**è®¾ç½®æ“ä½œ**ã€‚

å¦‚æœæˆ‘ä»¬èƒ½åœ¨ obj.text çš„è¯»å–å’Œè®¾ç½®æ—¶åšä¸€ä¸ªæ‹¦æˆªï¼Œäº‹æƒ…å°±å˜å¾—ç®€å•äº†ï¼šå½“ obj.text è¢«è¯»å–æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå‰¯ä½œç”¨å‡½æ•° `effect()` å­˜å‚¨åˆ°ä¸€ä¸ªâ€œæ¡¶â€ï¼ˆbucketï¼‰ä¸­ï¼›

å½“è®¾ç½® obj.text çš„å€¼æ—¶ï¼Œå†ä» bucket ä¸­å–å‡ºå‰¯ä½œç”¨å‡½æ•° `effect()` æ‰§è¡Œå³å¯ã€‚

æˆ‘ä»¬é‡‡ç”¨ Proxy æ¥å®ç°è¿™ä¸€åŠŸèƒ½ï¼š

```js
// å­˜å‚¨å‰¯ä½œç”¨çš„â€œæ¡¶â€
const bucket = new Set()

// åŸå§‹æ•°æ®
const data = { text: 'Hello world.' }
// å¯¹åŸå§‹æ•°æ®è¿›è¡Œä»£ç†
const obj = new Proxy(data, {
  // æ‹¦æˆªè¯»å–æ“ä½œ
  get (target, key) {
    // å°†å‰¯ä½œç”¨å‡½æ•°åŠ å…¥ bucket ä¸­
    bucket.add(effect)
    // è¿”å›å±æ€§å€¼
    return target[key]
  },

  // æ‹¦æˆªè®¾ç½®æ“ä½œ
  set (target, key, value) {
    // è®¾ç½®å±æ€§å€¼
    target[key] = value
    // æŠŠå‰¯ä½œç”¨å‡½æ•°ä» bucket ä¸­å–å‡ºå¹¶æ‰§è¡Œ
    bucket.forEach(fn => fn())
    // è¿”å› true è¡¨ç¤ºè®¾ç½®æ“ä½œæˆåŠŸ
    return true
  }
})
```

æˆ‘ä»¬ç”¨ä¸‹é¢çš„ä»£ç æ¥æµ‹è¯•ä¸€ä¸‹ï¼š

```js
function effect () {
  document.querySelector('#root').textContent = obj.text
}

effect()

setTimeout(() => {
  obj.text = 'Hello vue.'
}, 1000)
```

åœ¨æµè§ˆå™¨ä¸­è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œä¼šå¾—åˆ°æœŸæœ›çš„ç»“æœã€‚

## è®¾è®¡ä¸€ä¸ªå®Œå–„çš„å“åº”ç³»ç»Ÿ

æ­¤å‰ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªå¾®å‹çš„å“åº”ç³»ç»Ÿï¼Œå®ƒè¿˜ä¸å®Œå–„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥æ¥å®Œå–„å®ƒã€‚

åœ¨ä¸Šé¢çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬åœ¨ä»£ç ä¸­å†™æ­»äº†äº†å‰¯ä½œç”¨å‡½æ•°çš„åç§°ï¼ˆeffectï¼‰ï¼Œå¦‚æœæˆ‘ä»¬çš„å‰¯ä½œç”¨å‡½æ•°åç§°ä¸å« effectï¼Œé‚£ä¹ˆæˆ‘ä»¬æ•´å“åº”å¼ç³»ç»Ÿå°±ä¼šå¤±æ•ˆã€‚

æ‰€ä»¥æˆ‘ä»¬å¸Œæœ›ï¼Œå“ªæ€•å‰¯ä½œç”¨å‡½æ•°æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œä¹Ÿèƒ½è¢«æ­£ç¡®åœ°æ”¶é›†åˆ° bucket ä¸­ã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ªç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°çš„æœºåˆ¶ï¼š

```js
// ç”¨ä¸€ä¸ªå…¨å±€å˜é‡æ¥å­˜å‚¨è¢«æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°
let activeEffect

// effect å‡½æ•°ç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
function effect (fn) {
  // å½“è°ƒç”¨ effect() å‡½æ•°æ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•° fn() èµ‹å€¼ç»™ activeEffect
  activeEffect = fn
  // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
  fn()
}
```

é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ `effect()` å‡½æ•°æ¥æ³¨å†Œä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°ï¼š

```js
effect(
  // ä¸€ä¸ªåŒ¿åçš„å‰¯ä½œç”¨å‡½æ•°
  () => {
    document.querySelector('#root').textContent = obj.text
  }
)
```

æˆ‘ä»¬çš„å“åº”å¼ç³»ç»Ÿä¹Ÿéœ€è¦è¿›è¡Œä¸€äº›ä¿®æ”¹ï¼š

```js
const obj = new Proxy(data, {
  // æ‹¦æˆªè¯»å–æ“ä½œ
  get (target, key) {
    // å°† activeEffect ä¸­å­˜å‚¨çš„å‰¯ä½œç”¨å‡½æ•°åŠ å…¥ bucket ä¸­
    if (activeEffect) {
      bucket.add(activeEffect)
    }
    // è¿”å›å±æ€§å€¼
    return target[key]
  },

  // æ‹¦æˆªè®¾ç½®æ“ä½œ
  set (target, key, value) {
    // è®¾ç½®å±æ€§å€¼
    target[key] = value
    // æŠŠå‰¯ä½œç”¨å‡½æ•°ä» bucket ä¸­å–å‡ºå¹¶æ‰§è¡Œ
    bucket.forEach(fn => fn())
    // è¿”å› true è¡¨ç¤ºè®¾ç½®æ“ä½œæˆåŠŸ
    return true
  }
})
```

è¿™æ ·å­ï¼Œå“åº”å¼ç³»ç»Ÿå°±ä¸å†ä¾èµ–å‰¯ä½œç”¨å‡½æ•°çš„åç§°äº†ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ obj ä¸Šè®¾ç½®ä¸€ä¸ªä¸å­˜åœ¨çš„å±æ€§æ—¶ï¼š

```js
effect(
  // å‰¯ä½œç”¨å‡½æ•°
  () => {
    console.log('effect run.') // ä¼šæ‰§è¡Œä¸¤æ¬¡
    document.querySelector('#root').textContent = obj.text
  }
)

setTimeout(() => {
  obj.notExist = 'Hello vue.'
}, 1000)
```

åœ¨1ç§’åï¼Œæˆ‘ä»¬ç»™ obj å¢åŠ äº†ä¸€ä¸ªæ–°çš„å±æ€§ï¼Œå‰¯ä½œç”¨å‡½æ•°ä¹Ÿä¼šæ‰§è¡Œï¼Œè¿™æ˜¯ä¸æ­£ç¡®çš„ã€‚

å¯¼è‡´è¯¥é—®é¢˜çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬**æ²¡æœ‰åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸è¢«æ“ä½œçš„ç›®æ ‡å±æ€§ä¹‹é—´å»ºç«‹æ˜ç¡®çš„å…³ç³»**ã€‚æ— è®ºæˆ‘ä»¬è®¾ç½®çš„æ˜¯ä»€ä¹ˆå±æ€§ï¼Œå‰¯ä½œç”¨å‡½æ•°éƒ½ä¼šè¢«æ”¶é›†åˆ° bucket ä¸­ã€‚

è€Œè§£å†³çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠå‰¯ä½œç”¨å‡½æ•°ä¸è¢«æ“ä½œçš„ç›®å½•å±æ€§å…³è”èµ·æ¥å³å¯ã€‚åœ¨å®ç°è¿™ä¸€ç‚¹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ä»¥ä¸‹çš„ä»£ç ï¼š

```js
effect(function effectFn () {
  document.querySelector('#root').textContent = obj.text
})
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œå­˜åœ¨ä¸‰ä¸ªè§’è‰²ï¼š

1. è¢«æ“ä½œçš„å¯¹è±¡ï¼šobjï¼›
2. è¢«æ“ä½œçš„å±æ€§ï¼štextï¼›
3. ä½¿ç”¨ effect æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•° effectFnã€‚

å¦‚æœç”¨ target è¡¨ç¤ºè¢«æ“ä½œçš„å¯¹è±¡ï¼Œkey è¡¨ç¤ºè¢«æ“ä½œçš„å±æ€§ï¼ŒeffectFn è¡¨ç¤ºå‰¯ä½œç”¨å‡½æ•°ï¼Œé‚£ä¹ˆå¯ä»¥ä¸ºè¿™ä¸‰ä¸ªè§’è‰²å»ºç«‹å¦‚ä¸‹å…³ç³»ï¼š

```
target
  â””-- key
  		 â””-- effectFn
```

ä¸€ä¸ª target å¯ä»¥æœ‰å¤šä¸ª keyï¼›ä¸€ä¸ª key å¯ä»¥æœ‰å¤šä¸ª effectFnï¼›ä¸€ä¸ª effectFn å¯ä»¥å¯¹åº”å¤šä¸ª keyã€‚

ä¸‹é¢ä¸¾å‡ ä¸ªç²Ÿå­ä¹Ÿè¯´æ˜ä¸€ä¸‹å„ç§æƒ…å†µï¼š

```js
effect(function effectFn1 () {
  obj.text
})
effect(function effectFn2 () {
  obj.text
})
```

å…³ç³»å¦‚ä¸‹ï¼š

```
target
  â””-- key
  		 â””-- effectFn1
  		 â””-- effectFn2
```

----

```js
effect(function effectFn () {
  obj.foo
  obj.bar
})
```

å…³ç³»å¦‚ä¸‹ï¼š

```
target
  â””-- foo
  		 â””-- effectFn
  â””-- bar
  		 â””-- effectFn
```

----

```js
effect(function effectFn1 () {
  obj1.foo
})
effect(function effectFn2 () {
  obj2.bar
})
```

å…³ç³»å¦‚ä¸‹ï¼š

```
target1
  â””-- foo
  		 â””-- effectFn1
target2
  â””-- bar
  		 â””-- effectFn2
```

é’ˆå¯¹ä»¥ä¸Šçš„åˆ†æï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°è®¾ç½®å“åº”å¼ç³»ç»Ÿï¼š

```js

// å­˜å‚¨å‰¯ä½œç”¨çš„â€œæ¡¶â€
const bucket = new WeakMap()

// åŸå§‹æ•°æ®
const data = { text: 'Hello world.' }
// å¯¹åŸå§‹æ•°æ®è¿›è¡Œä»£ç†
const obj = new Proxy(data, {
  // æ‹¦æˆªè¯»å–æ“ä½œ
  get (target, key) {
    // å¦‚æœä¸å­˜åœ¨å‰¯ä½œç”¨å‡½æ•°ï¼Œç›´æ¥è¿”å›
    if (!activeEffect) {
      return target[key]
    }

    // ä» bucket ä¸­å–å‡º depsMapï¼Œå®ƒæ˜¯ä¸€ä¸ª Map ç±»å‹
    let depsMap = bucket.get(target)

    if (!depsMap) {
      bucket.set(target, (depsMap = new Map()))
    }

    // å†æ ¹æ® key ä» depsMap ä¸­å–å‡º depsï¼Œå®ƒæ˜¯ä¸€ä¸ª Set ç±»å‹
    // é‡Œé¢å­˜å‚¨ç€æ‰€æœ‰ä¸å½“å‰ key ç›¸å½“çš„å‰¯ä½œç”¨å‡½æ•°
    let deps = depsMap.get(key)

    if (!deps) {
      depsMap.set(key, (deps = new Set()))
    }

    // æœ€åå°†å‰¯ä½œç”¨å‡½æ•°å­˜å‚¨è¿› deps é‡Œé¢
    deps.add(activeEffect)

    // è¿”å›å±æ€§å€¼
    return target[key]
  },

  // æ‹¦æˆªè®¾ç½®æ“ä½œ
  set (target, key, value) {
    // è®¾ç½®å±æ€§å€¼
    target[key] = value
    // æ ¹æ® target ä» bucket ä¸­å–å‡ºæ‰€æœ‰çš„ depsMap
    const depsMap = bucket.get(target)

    if (!depsMap) return true

    // æ ¹æ® key ä» depsMap ä¸­å–å‡ºæ‰€æœ‰çš„å‰¯ä½œç”¨å‡½æ•°
    const effects = depsMap.get(key)

    effects && effects.forEach(fn => fn())
    // è¿”å› true è¡¨ç¤ºè®¾ç½®æ“ä½œæˆåŠŸ
    return true
  }
})
```

ä»è¿™æ®µä»£ç ä¸­å¯ä»¥çœ‹å‡ºæ„å»ºæ•°æ®ç»“æ„çš„æ–¹å¼ï¼Œæˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨äº† `WeakMap`ã€`Map` å’Œ `Set`ï¼š

+ `WeapMap` ç”± target -> `Map` æ„æˆï¼›
+ `Map` ç”± key -> `Set` æ„æˆã€‚

å®ƒä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![target-key-effect](../imgs/target-key-effect.png)

å¼„æ¸…æ¥šä»–ä»¬ä¹‹é—´çš„å…³ç³»åï¼Œæˆ‘ä»¬æœ‰å¿…è¦è§£é‡Šä¸€ä¸‹è¿™é‡Œä¸ºä»€ä¹ˆä½¿ç”¨ `WeakMap`ï¼Œæˆ‘ä»¬çœ‹ä¸‹ä»¥ä¸‹ä»£ç ï¼š

```js
const map = new Map()
const weakMap = new WeakMap()

;(function () {
  const foo = { foo: 1 }
  const bar = { bar: 1 }
  
  map.set(foo, 1)
  weakMap.set(bar, 1)
})()

console.log(map)
console.log(weakMap)
```

ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å®šä¹‰äº† map å’Œ weakMap å¸¸é‡ï¼Œå½“ç«‹å³æ‰§è¡Œå‡½æ•°ï¼ˆIIFEï¼‰æ‰§è¡Œå®Œæ¯•åï¼Œfoo ä»ç„¶ä½œä¸º map çš„ key è¢«å¼•ç”¨ç€ï¼Œå› æ­¤åƒåœ¾å›æ”¶å™¨ä¸ä¼šæŠŠå®ƒä»å†…å­˜ä¸­ç§»é™¤ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥é€šè¿‡ `map.keys()` æ¥è·å–åˆ° foo å¯¹è±¡ï¼›è€Œå¯¹äº bar æ¥è¯´ï¼Œç”±äº ` WeakMap` çš„æ˜¯ key æ˜¯å¼±å¼•ç”¨ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šåœ¨è¡¨è¾¾å¼æ‰§è¡Œå®Œæ¯•åç«‹å³å°†å¯¹è±¡ bar ä»å†…å­˜ä¸­ç§»é™¤ï¼Œå¹¶ä¸”æˆ‘ä»¬æ— æ³•è·å– `WeakMap` çš„ key å€¼ï¼Œä¹Ÿå°±æ— æ³•é€šè¿‡ weakMap æ¥è·å– bar å¯¹è±¡ã€‚

å› ä¸º WeakMap çš„ key æ˜¯å¼±å¼•ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å­˜å‚¨ ä¸€äº›åªæœ‰å½“ key æ‰€å¼•ç”¨çš„å¯¹è±¡å­˜åœ¨æ—¶ï¼ˆæ²¡æœ‰è¢«å›æ”¶ï¼‰æ‰æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ä¸Šé¢çš„åœºæ™¯ä¸­ï¼Œå¦‚æœ target å¯¹è±¡æ²¡æœ‰ä»»ä½•å¼•ç”¨äº†ï¼Œè¯´æ˜ç”¨æˆ·ä¸å†éœ€è¦å®ƒäº†ï¼Œè¿™æ—¶åƒåœ¾å›æ”¶å™¨ä¼šå®Œæˆå›æ”¶ä»»åŠ¡ã€‚

è€Œå¦‚æœä½¿ç”¨ `Map` æ¥ä»£æ›¿ `WeakMap` é‚£ä¹ˆå³ä½¿ç”¨æˆ·çš„ä»£ç å¯¹ target æ²¡æœ‰ä»»ä½•å¼•ç”¨ï¼Œè¿™ä¸ª target ä¹Ÿä¸ä¼šè¢«å›æ”¶ï¼Œæœ€åå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡ºã€‚

æœ€åï¼Œæˆ‘ä»¬å¯¹ä¹‹å‰å°è£…çš„ä»£ç ä½œä¸€äº›æå–å¤„ç†ï¼šæŠŠ get æ‹¦æˆªä¸­çš„éƒ¨åˆ†é€»è¾‘å•ç‹¬å°è£…åˆ°ä¸€ä¸ª `track()` å‡½æ•°ä¸­ï¼Œtrack è¡¨ç¤ºè¿½è¸ªçš„æ„æ€ï¼›åŒæ ·æŠŠ set æ‹¦æˆªä¸­çš„éƒ¨åˆ†é€»è¾‘å•ç‹¬å°è£…åˆ°ä¸€ä¸ª `trigger()` å‡½æ•°ä¸­ï¼Œtrigger è¡¨ç¤ºè§¦å‘çš„æ„æ€ã€‚

```js
// å­˜å‚¨å‰¯ä½œç”¨çš„â€œæ¡¶â€
const bucket = new WeakMap()

// åŸå§‹æ•°æ®
const data = { text: 'Hello world.' }
// å¯¹åŸå§‹æ•°æ®è¿›è¡Œä»£ç†
const obj = new Proxy(data, {
  // æ‹¦æˆªè¯»å–æ“ä½œ
  get (target, key) {
    track(target, key)

    // è¿”å›å±æ€§å€¼
    return target[key]
  },

  // æ‹¦æˆªè®¾ç½®æ“ä½œ
  set (target, key, value) {
    // è®¾ç½®å±æ€§å€¼
    target[key] = value
    
    trigger(target, key)

    // è¿”å› true è¡¨ç¤ºè®¾ç½®æ“ä½œæˆåŠŸ
    return true
  }
})

function track (target, key) {
  // å¦‚æœä¸å­˜åœ¨å‰¯ä½œç”¨å‡½æ•°ï¼Œç›´æ¥è¿”å›
  if (!activeEffect) return

  // ä» bucket ä¸­å–å‡º depsMapï¼Œå®ƒæ˜¯ä¸€ä¸ª Map ç±»å‹
  let depsMap = bucket.get(target)

  if (!depsMap) {
    bucket.set(target, (depsMap = new Map()))
  }

  // å†æ ¹æ® key ä» depsMap ä¸­å–å‡º depsï¼Œå®ƒæ˜¯ä¸€ä¸ª Set ç±»å‹
  // é‡Œé¢å­˜å‚¨ç€æ‰€æœ‰ä¸å½“å‰ key ç›¸å½“çš„å‰¯ä½œç”¨å‡½æ•°
  let deps = depsMap.get(key)

  if (!deps) {
    depsMap.set(key, (deps = new Set()))
  }

  // æœ€åå°†å‰¯ä½œç”¨å‡½æ•°å­˜å‚¨è¿› deps é‡Œé¢
  deps.add(activeEffect)
}

function trigger (target, key) {
  // æ ¹æ® target ä» bucket ä¸­å–å‡ºæ‰€æœ‰çš„ depsMap
  const depsMap = bucket.get(target)

  if (!depsMap) return true

  // æ ¹æ® key ä» depsMap ä¸­å–å‡ºæ‰€æœ‰çš„å‰¯ä½œç”¨å‡½æ•°
  const effects = depsMap.get(key)

  effects && effects.forEach(fn => fn())
}
```

å¦‚ä¸Šé¢çš„ä»£ç æ‰€ç¤ºï¼Œåˆ†åˆ«æŠŠé€»è¾‘å°è£…åˆ° `track()` å’Œ `trigger()` ä¸­ï¼Œè¿™èƒ½ä¸ºæˆ‘ä»¬å¸¦æ¥æå¤§çš„çµæ´»æ€§ã€‚

## åˆ†æ”¯åˆ‡æ¢ä¸ cleanup

ä»€ä¹ˆæ˜¯åˆ†æ”¯åˆ‡æ¢ï¼Ÿ

```js
const data = { ok: true, text: 'Hello world.' }

const obj = new Proxy(data, { /* ... */ })

effect(function effectFn () {
  document.body.textContent = obj.ok ? obj.text : 'plain text.'
})
```

åœ¨å‰¯ä½œç”¨å‡½æ•°å†…éƒ¨å­˜åœ¨ä¸€ä¸ªä¸‰å…ƒè¡¨è¾¾å¼ï¼Œæ ¹æ® `obj.ok` çš„ä¸åŒä¼šæ‰§è¡Œä¸åŒåˆ†æ”¯çš„ä»£ç ã€‚å½“ `obj.ok` å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä»£ç æ‰§è¡Œçš„åˆ†æ”¯ä¼šè·Ÿç€å˜åŒ–ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„åˆ†æ”¯åˆ‡æ¢ã€‚

åˆ†æ”¯åˆ‡æ¢å¯èƒ½ä¼šäº§ç”Ÿé—ç•™çš„å‰¯ä½œç”¨å‡½æ•°ã€‚æ‹¿ä¸Šé¢çš„ä»£ç ä¸ºä¾‹ï¼šå½“ `obj.ok` åˆå§‹å€¼ä¸º trueï¼Œé‚£ä¹ˆä¼šè¯»å– `obj.text` çš„å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šæ”¶é›†åˆ° `obj.ok` çš„ effectFn å’Œ `obj.text` çš„ effectFnï¼›

å½“ `obj.ok` è®¾ç½®ä¸º false æ—¶ï¼Œå‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œåï¼Œç”±äº `obj.text` ä¸ä¼šè¢«è¯»å–ï¼Œåªä¼šè§¦å‘ `obj.ok` çš„è¯»å–æ“ä½œï¼Œæ‰€ä»¥ç†æƒ³çš„æƒ…å†µä¸‹ `obj.text` å¯¹åº”çš„ effectFn ä¸åº”è¯¥è¢«æ”¶é›†ã€‚

ä½†æ˜¯æ ¹æ®å‰æ–‡çš„å®ç°ï¼Œæš‚æ—¶è¿˜åšä¸åˆ°è¿™ä¸€ç‚¹ã€‚`obj.text` å¯¹åº”çš„ effectFn è¿˜æ˜¯è¢«æ”¶é›†èµ·æ¥äº†ï¼Œå½“æˆ‘ä»¬æ”¹å˜ `obj.text` çš„å€¼æ—¶ï¼Œä¼šè§¦å‘æ›´æ–°ï¼Œå¯¼è‡´å‰¯ä½œç”¨å‡½æ•°é‡æ–°è¿è¡Œï¼Œå³ä½¿ `document.body.textContent` çš„å€¼ä¸éœ€è¦å˜åŒ–ã€‚è¿™å°±ä¼šå¯¼è‡´æ— ç”¨çš„æ›´æ–°ã€‚

è§£å†³è¿™ä¸ªé—®é¢˜çš„æ€è·¯å¾ˆç®€å•ï¼šæ¯æ¬¡å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæ¸…é™¤å®ƒå…³è”çš„å‰¯ä½œç”¨å‡½æ•°ã€‚å½“å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œä¼šé‡æ–°å†å»ºç«‹å…³è”ï¼Œä½†åœ¨æ–°çš„è”ç³»ä¸­ä¸å†åŒ…å«é—ç•™çš„å‰¯ä½œç”¨å‡½æ•°ã€‚

```js
// effect å‡½æ•°ç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
function effect (fn) {
  // å½“è°ƒç”¨ effect() å‡½æ•°æ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•° fn() èµ‹å€¼ç»™ activeEffect
  const effectFn = () => {
    // å½“ effectFn æ‰§è¡Œæ—¶ï¼Œå°†å…¶è®¾ç½®ä¸ºå½“å‰æ¿€æ´»çš„å‰¯ä½œç”¨å‡½æ•°
    activeEffect = effectFn
    fn()
  }

  // ä½¿ç”¨ effectFn.deps ä¸ºç¼“å­˜æ‰€æœ‰ä¸è¯¥å‰¯ä½œç”¨å‡½æ•°ç›¸å…³è”çš„é›†åˆ
  effectFn.deps = []
  // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
  effectFn()
}
```

é‚£ä¹ˆ `effectFn.deps` ä¸­çš„ä¾èµ–é›†åˆå¦‚ä½•æ”¶é›†å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œåœ¨ `track()` å‡½æ•°ä¸­ï¼š

```js
function track (target, key) {
  // å¦‚æœä¸å­˜åœ¨å‰¯ä½œç”¨å‡½æ•°ï¼Œç›´æ¥è¿”å›
  if (!activeEffect) return

  // ä» bucket ä¸­å–å‡º depsMapï¼Œå®ƒæ˜¯ä¸€ä¸ª Map ç±»å‹
  let depsMap = bucket.get(target)

  if (!depsMap) {
    bucket.set(target, (depsMap = new Map()))
  }

  // å†æ ¹æ® key ä» depsMap ä¸­å–å‡º depsï¼Œå®ƒæ˜¯ä¸€ä¸ª Set ç±»å‹
  // é‡Œé¢å­˜å‚¨ç€æ‰€æœ‰ä¸å½“å‰ key ç›¸å½“çš„å‰¯ä½œç”¨å‡½æ•°
  let deps = depsMap.get(key)

  if (!deps) {
    depsMap.set(key, (deps = new Set()))
  }

  // æœ€åå°†å‰¯ä½œç”¨å‡½æ•°å­˜å‚¨è¿› deps é‡Œé¢
  deps.add(activeEffect)

  // deps å°±æ˜¯ä¸€ä¸ªä¸å½“å‰å‰¯ä½œç”¨å‡½æ•°å­˜åœ¨è”ç³»çš„ä¾èµ–é›†åˆ
  // å°†å…¶æ·»åŠ åˆ° activeEffect.deps ä¸­
  activeEffect.deps.push(deps)
}
```

æœ‰äº†è¿™ä¸ªè”ç³»ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æ¯æ¬¡å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ï¼Œå…ˆæ¸…é™¤ä¹‹å‰çš„è”ç³»ï¼š

```js
// effect å‡½æ•°ç”¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
function effect (fn) {
  // å½“è°ƒç”¨ effect() å‡½æ•°æ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•° fn() èµ‹å€¼ç»™ activeEffect
  const effectFn = () => {
    // è°ƒç”¨ cleanUp() å‡½æ•°å®Œæˆæ¸…é™¤å·¥ä½œ
    cleanUp(effectFn)
    // å½“ effectFn æ‰§è¡Œæ—¶ï¼Œå°†å…¶è®¾ç½®ä¸ºå½“å‰æ¿€æ´»çš„å‰¯ä½œç”¨å‡½æ•°
    activeEffect = effectFn
    fn()
  }

  // ä½¿ç”¨ effectFn.deps ä¸ºç¼“å­˜æ‰€æœ‰ä¸è¯¥å‰¯ä½œç”¨å‡½æ•°ç›¸å…³è”çš„é›†åˆ
  effectFn.deps = []
  // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
  effectFn()
}

function cleanUp (effectFn) {
  effectFn.deps.forEach(deps => {
    // å°† effectFn ä»ä¾èµ–é›†åˆä¸­ç§»é™¤
    deps.delete(effectFn)
  })

  // æœ€åéœ€è¦é‡ç½® effectFn.deps æ•°ç»„
  effectFn.deps.length = 0
}
```

ç„¶åæˆ‘ä»¬éœ€è¦åœ¨ `trigger()` é‡Œé¢å¯¹ `Set` çš„ forEach è¿›è¡Œå¤„ç†ï¼Œé˜²æ­¢ä»£ç è¿›å…¥æ­»å¾ªç¯ï¼š

```js
function trigger (target, key) {
  // æ ¹æ® target ä» bucket ä¸­å–å‡ºæ‰€æœ‰çš„ depsMap
  const depsMap = bucket.get(target)

  if (!depsMap) return true

  // æ ¹æ® key ä» depsMap ä¸­å–å‡ºæ‰€æœ‰çš„å‰¯ä½œç”¨å‡½æ•°
  const effects = depsMap.get(key)

  // effects && effects.forEach(fn => fn())

  // ç”¨ä¸€ä¸ªæ–°çš„ Set æ¥å®Œæˆ forEach æ“ä½œï¼Œé˜²æ­¢æ·»åŠ æ—¶è¿›å…¥æ­»å¾ªç¯
  const effectsToRun = new Set(effects)
  effectsToRun.forEach(effectFn => effectFn())
}
```

æœ€åæˆ‘ä»¬çš„æ£€éªŒä¸€ä¸‹ä»£ç ï¼š

```js
effect(
  // å‰¯ä½œç”¨å‡½æ•°
  () => {
    console.log('run')
    document.querySelector('#root').textContent = obj.ok ? obj.text : 'plain text.'
  }
)

setTimeout(() => {
  obj.ok = false
  setTimeout(() => {
    obj.text = 'Hello again.'
  }, 1000)
}, 1000)
```

æ§åˆ¶å°ä¸€å…±è¾“å‡ºä¸¤æ¬¡ runï¼Œä¸€æ¬¡æ˜¯ `obj.ok` åˆå§‹å€¼ä¸º trueæ—¶ï¼Œå¦ä¸€æ¬¡ä¸º `obj.ok` çš„å€¼è®¾ç½®ä¸º false æ—¶ã€‚å½“ `obj.text` çš„å€¼æ”¹å˜æ—¶ï¼Œå‰¯ä½œç”¨ä¸å†æ‰§è¡Œï¼Œè¯´æ˜æˆ‘ä»¬ä¸Šé¢çš„æ”¹åŠ¨æ˜¯ç¬¦åˆéœ€æ±‚çš„ã€‚

## åµŒå¥—çš„ effect ä¸ effect æ ˆ

effect æ˜¯å¯ä»¥å‘ç”ŸåµŒå¥—çš„ï¼Œä¾‹å¦‚ï¼š

```js
effect(function effectFn1 () {
  effect(function effectFn2 () {
    // ...
  })
})
```

åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼ŒeffectFn1 ä¸­åµŒå¥—äº† effectFn2ï¼ŒeffectFn1 çš„æ‰§è¡Œä¼šå¯¼è‡´ effectFn2 æ‰§è¡Œã€‚

é‚£ä¹ˆä»€ä¹ˆåœºæ™¯ä¼šå‡ºç°åµŒå¥—çš„ effect å‘¢ï¼Ÿæ‹¿ Vue.js æ¥è¯´ï¼Œå®é™…ä¸Š Vue.js çš„æ¸²æŸ“å‡½æ•°å°±æ˜¯åœ¨ä¸€ä¸ª effect ä¸­æ‰§è¡Œçš„ï¼š

```js
// Foo ç»„ä»¶
const Foo = {
  render () {
    return // ...
  }
}

effect(() => {
  Foo.render()
})
```

å½“ç»„ä»¶å‘ç”ŸåµŒå¥—æ—¶ï¼Œå°±å‘ç”Ÿäº† effect åµŒå¥—ï¼š

```js
// Bar ç»„ä»¶
const Bar = {
  render () {
    return // ...
  }
}
// Foo ç»„ä»¶
const Foo = {
  render () {
    return <Bar /> // jsx è¯­æ³•
  }
}
```

æ­¤æ—¶å°±å‘ç”Ÿäº† effect åµŒå¥—ï¼š

```js
effect(() => {
  Foo.render()
  
  effect(() => {
    Bar.render()
  })
})
```

ä¸Šé¢è¿™ä¾‹å­è¯´æ˜äº†ä¸ºä»€ä¹ˆ effect è¦è®¾è®¡æˆå¯åµŒå¥—çš„ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ææ¸…æ¥šï¼Œå¦‚æœ effect ä¸æ”¯æŒåµŒå¥—ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

æŒ‰ç…§å‰æ–‡çš„å®ç°ï¼Œæˆ‘ä»¬çš„è®¾è®¡æ˜¯ä¸æ”¯æŒåµŒå¥—çš„ï¼Œæˆ‘ä»¬çœ‹ä¸ªä¾‹å­ï¼š

```js
// åŸå§‹æ•°æ®
const data = { foo: true, bar: true }

// ä»£ç†å¯¹è±¡
const obj = new Proxy(data, { /* ... */ })

// å…¨å±€å˜é‡
let temp1
let temp2

// åµŒå¥—
effect(function effectFn1 () {
  console.log('effectFn1 æ‰§è¡Œ')
  
  effect(function effectFn2 () {
    console.log('effectFn2 æ‰§è¡Œ')
    
    temp2 = obj.var
  })
  
  temp1 = obj.foo
})
```

åœ¨ç†æƒ³çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›å‰¯ä½œç”¨å‡½æ•°ä¸å¯¹è±¡å±æ€§ä¹‹é—´çš„å…³ç³»æ˜¯è¿™æ ·çš„ï¼š

```
data
  â””-- foo
  		 â””-- effectFn1
  â””-- bar
  		 â””-- effectFn2
```

å½“æˆ‘ä»¬ä¿®æ”¹ data.foo æ—¶ä¼šè§¦å‘ effectFn1 æ‰§è¡Œï¼Œç”±äº effectFn2 æ˜¯åµŒå¥—åœ¨ effectFn1 é‡Œé¢çš„ï¼Œæ‰€ä»¥ä¼šé—´æ¥è§¦å‘ effectFn2 æ‰§è¡Œï¼›è€Œå½“ä¿®æ”¹ data.bar æ—¶ï¼Œåªä¼šè§¦å‘  effectFn2 æ‰§è¡Œã€‚

ç„¶è€Œï¼Œç»“æœå¹¶éå¦‚æ­¤ï¼Œæˆ‘ä»¬å°è¯•ä¿®æ”¹ obj.foo çš„å€¼ï¼Œä¼šå‘ç°è¾“å‡ºï¼š

```
'effectFn1 æ‰§è¡Œ'
'effectFn2 æ‰§è¡Œ'
'effectFn2 æ‰§è¡Œ'
```

ä¸€å…±æ‰“å°äº†ä¸‰æ¬¡ï¼Œå…¶ä¸­å‰é¢ä¸¤æ¬¡æ˜¯åœ¨åˆå§‹æ‰§è¡Œçš„æ‰“å°ç»“æœï¼Œè¿™ä¸¤æ­¥çš„ç»“æœæ˜¯æ­£å¸¸çš„ï¼›é—®é¢˜å‡ºåœ¨ç¬¬ä¸‰æ­¥ï¼Œæˆ‘ä»¬ä¿®æ”¹äº† obj.foo çš„å€¼ï¼Œç†åº”æ˜¯ effectFn1 æ‰§è¡Œï¼Œä½†ç»“æœæ˜¯ effectFn2 é‡æ–°æ‰§è¡Œäº†ï¼Œè¿™æ˜¾ç„¶ä¸ç¬¦åˆé¢„æœŸã€‚

é—®é¢˜å‡ºåœ¨å“ªé‡Œå‘¢ï¼Ÿå…¶å®é—®é¢˜å‡ºåœ¨æˆ‘ä»¬å®ç°çš„ `effect()` å‡½æ•°å’Œ `activeEffect` ä¸Šã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå…¨å±€å˜é‡æ¥å­˜å‚¨é€šè¿‡ `effect()` å‡½æ•°æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°ï¼Œæ„å‘³ç€åŒä¸€æ—¶åˆ» `activeEffect` å­˜å‚¨çš„å‰¯ä½œç”¨å‡½æ•°åªèƒ½æœ‰ä¸€ä¸ªã€‚

å½“å‰¯ä½œç”¨å‡½æ•°å‘ç”ŸåµŒå¥—æ—¶ï¼Œå†…å±‚å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œä¼šè¦†ç›– activeEffect çš„å€¼ï¼Œå¹¶ä¸”æ°¸è¿œä¸ä¼šæ¢å¤åŸæ¥çš„å€¼ã€‚è¿™æ—¶å¦‚æœå†æœ‰å“åº”å¼æ•°æ®è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œå³ä½¿è¿™ä¸ªå“åº”å¼æ•°æ®æ˜¯åœ¨å¤–å±‚å‰¯ä½œç”¨å‡½æ•°ä¸­è¯»å–çš„ï¼Œå®ƒæ”¶é›†åˆ°çš„å€¼ä¹Ÿåªä¼šæ˜¯å†…å±‚å‡½æ•°çš„å‰¯ä½œç”¨å‡½æ•°ã€‚è¿™å°±æ˜¯é—®é¢˜æ‰€åœ¨ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°æ ˆ `effectStack` æ¥ç¼“å­˜å¤–å±‚å‡½æ•°çš„å‰¯ä½œç”¨å‡½æ•°ï¼š

```js
let activeEffect
const effectStack = []

function effect (fn) {
  const effectFn = () => {
    cleanUp(effectFn)
    
    activeEffect = effectFn
    
    // åœ¨å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œä¹‹å‰ï¼Œå°†å½“å‰çš„å‰¯ä½œç”¨å‡½æ•°å‹å…¥æ ˆ
    effectStack.push(effectFn)
    
    // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
    fn()
    
    // å°†å¯èƒ½çš„å†…å±‚åµŒå¥—ä¸­å…¥æ ˆçš„å‰¯ä½œç”¨å‡½æ•°å¼¹å‡º
    effectStack.pop()
    
    // æ¢å¤ä¹‹å‰çš„å‰¯ä½œç”¨å‡½æ•°
    activeEffect = effectStack.at(-1)
  }
  
  effectFn.deps = []
  
  effectFn()
}
```

æˆ‘ä»¬è§£é‡Šä¸€ä¸‹è¿™æ®µä»£ç ï¼š

```js
effect(function effectFn1 () {
  effect(function effectFn2 () {
    // ...
  })
})

// ç¬¬ä¸€æ¬¡ effect() æ‰§è¡Œ
// effectFn === effectFn1
// é‚£ä¹ˆ effectStack.push(effectFn) åï¼ŒeffectStack å°±å˜æˆäº† [effectFn1]
// ä¹‹å fn() æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æ•´ä¸ª effectFn1() æ‰§è¡Œï¼Œ
// effectFn1() çš„æ‰§è¡Œï¼Œå¯¼è‡´ effect() å†æ¬¡æ‰§è¡Œ
// æ­¤æ—¶ effectFn === effectFn2
// é‚£ä¹ˆ effectStack.push(effectFn) åï¼ŒeffectStack å°±å˜æˆäº† [effectFn1, effectFn2]
// fn() æ‰§è¡Œåï¼Œä¼šå›åˆ° effectFn1 çš„å‰¯ä½œç”¨å‡½æ•°ä¸Šé¢
// æ­¤æ—¶ effectStack.pop() å effectStack å°±å˜æˆäº† [effectFn1]
// æˆ‘ä»¬ä» effectStack ä¸­å–å‡ºæœ€åä¸€é¡¹ç»™ activeEffect
```

å¦‚æ­¤ä¸€æ¥ï¼Œå“åº”å¼æ•°æ®å°±åªä¼šæ”¶é›†ç›´æ¥è¯»å–å…¶å€¼çš„å‰¯ä½œç”¨å‡½æ•°ä½œä¸ºä¾èµ–ï¼Œä»è€Œé¿å…äº†å‘ç”Ÿäº†é”™ä¹±ã€‚

## é¿å…æ— é™é€’å½’å¾ªç¯

æˆ‘ä»¬çœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š

```js
const data = { foo: 1 }
const obj = new Proxy(data, { /* ... */ })

effect(() => {
  obj.foo = obj.foo + 1
})
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ³¨å†Œçš„å‰¯ä½œç”¨å‡½æ•°ä¸­åªæœ‰ä¸€ä¸ª obj.foo è‡ªå¢æ“ä½œï¼Œè¿™ä¼šå¯¼è‡´æ­»å¾ªç¯ã€‚

ä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ

åœ¨è¿™ä¸ª `obj.foo = obj.foo + 1` çš„è¯­å¥ä¸­ï¼Œå³ä¼šè¯»å– obj.foo çš„å€¼ï¼Œåˆä¼šè®¾ç½® obj.foo çš„å€¼ï¼Œè¿™å°±æ˜¯å¯¼è‡´é—®é¢˜çš„æ ¹æœ¬åŸå› ã€‚

é¦–å…ˆæ˜¯è¯»å– obj.foo çš„å€¼ï¼Œä¼šè§¦å‘ track æ“ä½œï¼Œå°†å½“å‰å‰¯ä½œç”¨å‡½æ•°æ”¶é›†åˆ° bucket ä¸­ï¼Œæ¥ç€é‡æ–°èµ‹å€¼ï¼Œåˆä¼šè§¦å‘ trigger æ“ä½œï¼ŒæŠŠ bucket ä¸­çš„å‰¯ä½œç”¨å‡½æ•°å–å‡ºæ¥å¹¶æ‰§è¡Œã€‚ä½†é—®é¢˜æ˜¯è¯¥å‰¯ä½œç”¨å‡½æ•°æ­£åœ¨æ‰§è¡Œä¸­ï¼Œè¿˜æ²¡æ‰§è¡Œå®Œæ¯•ï¼Œå°±è¦å¼€å§‹ä¸‹ä¸€æ¬¡çš„æ‰§è¡Œã€‚è¿™æ ·ä¼šå¯¼è‡´æ— é™é€’å½’åœ°è°ƒç”¨è‡ªå·±ï¼Œäºæ˜¯å°±äº§ç”Ÿäº†æ ˆæº¢å‡ºã€‚

è¿™ä¸ªé—®é¢˜ä¸éš¾å¤„ç†ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ trigger åŠ¨ä½œå‘ç”Ÿæ—¶å¢åŠ ä¸€ä¸ªå®ˆå«æ¡ä»¶ï¼š**å¦‚æœ trigger è§¦å‘æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ä¸å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ç›¸åŒï¼Œåˆ™ä¸æ‰§è¡Œï¼Œ**å¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š

```js
function trigger (target, key) {
  // æ ¹æ® target ä» bucket ä¸­å–å‡ºæ‰€æœ‰çš„ depsMap
  const depsMap = bucket.get(target)

  if (!depsMap) return true

  // æ ¹æ® key ä» depsMap ä¸­å–å‡ºæ‰€æœ‰çš„å‰¯ä½œç”¨å‡½æ•°
  const effects = depsMap.get(key)

  // effects && effects.forEach(fn => fn())

  // ç”¨ä¸€ä¸ªæ–°çš„ Set æ¥å®Œæˆ forEach æ“ä½œï¼Œé˜²æ­¢æ·»åŠ æ—¶è¿›å…¥æ­»å¾ªç¯
  const effectsToRun = new Set()

  effects && effects.forEach(effectFn => {
    // å¦‚æœ trigger è§¦å‘æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ä¸å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ç›¸åŒï¼Œåˆ™ä¸è§¦å‘
    if (effectFn !== activeEffect) {
      effectsToRun.add(effectFn)
    }
  })
  effectsToRun.forEach(effectFn => effectFn())
}
```

è¿™æ ·æˆ‘ä»¬å°±èƒ½å¤Ÿé¿å…æ— é™é€’å½’è°ƒç”¨ï¼Œä»è€Œé¿å…æ ˆæº¢å‡ºã€‚

## è°ƒåº¦æ‰§è¡Œ

å¯è°ƒåº¦æ€§æ˜¯å“åº”å¼ç³»ç»Ÿéå¸¸é‡è¦çš„ç‰¹æ€§ã€‚ä»€ä¹ˆæ˜¯å¯è°ƒåº¦æ€§å‘¢ï¼Ÿæ‰€è°“å¯è°ƒåº¦ï¼ŒæŒ‡çš„æ˜¯å½“ `trigger()` åŠ¨ä½œè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œæ—¶ï¼Œæœ‰èƒ½åŠ›å†³å®šå‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œçš„æ—¶æœºã€æ¬¡æ•°ä»¥åŠæ–¹å¼ã€‚

ç®€å•çš„æ¥è¯´ï¼Œå¯è°ƒåº¦æ€§å°±æ˜¯è®©ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€æ±‚æ¥å†³å®šä»€ä¹ˆæ—¶å€™æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ã€‚

æˆ‘ä»¬å¯ä»¥ä¸º `effect()` å‡½æ•°è®¾è®¡ä¸€ä¸ªå¯é€‰çš„å‚æ•° optionsï¼Œå…è®¸ç”¨æˆ·æŒ‡å®šè°ƒåº¦å™¨ï¼š

```js
function effect (fn, options = {}) {
  const effectFn = () => {
    cleanUp(effectFn)
    
    activeEffect = effectFn
    
    // åœ¨å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œä¹‹å‰ï¼Œå°†å½“å‰çš„å‰¯ä½œç”¨å‡½æ•°å‹å…¥æ ˆ
    effectStack.push(effectFn)
    
    // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
    fn()
    
    // å°†å¯èƒ½çš„å†…å±‚åµŒå¥—ä¸­å…¥æ ˆçš„å‰¯ä½œç”¨å‡½æ•°å¼¹å‡º
    effectStack.pop()
    
    // æ¢å¤ä¹‹å‰çš„å‰¯ä½œç”¨å‡½æ•°
    activeEffect = effectStack.at(-1)
  }
  
  effectFn.deps = []

  // å°† options æŒ‚è½½åˆ° effectFn ä¸Š
  effectFn.options = options
  
  effectFn()
}
```

ç„¶ååœ¨ `trigger()` å‡½æ•°é‡Œé¢åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æŒ‡å®šäº†è°ƒåº¦å™¨ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å°†å‰¯ä½œç”¨å‡½æ•°ä½œä¸ºè°ƒåº¦å™¨çš„å‚æ•°ï¼Œå¹¶æ‰§è¡Œè°ƒåº¦å™¨ï¼š

```js
function trigger (target, key) {
  // æ ¹æ® target ä» bucket ä¸­å–å‡ºæ‰€æœ‰çš„ depsMap
  const depsMap = bucket.get(target)

  if (!depsMap) return true

  // æ ¹æ® key ä» depsMap ä¸­å–å‡ºæ‰€æœ‰çš„å‰¯ä½œç”¨å‡½æ•°
  const effects = depsMap.get(key)

  // effects && effects.forEach(fn => fn())

  // ç”¨ä¸€ä¸ªæ–°çš„ Set æ¥å®Œæˆ forEach æ“ä½œï¼Œé˜²æ­¢æ·»åŠ æ—¶è¿›å…¥æ­»å¾ªç¯
  const effectsToRun = new Set()

  effects && effects.forEach(effectFn => {
    // å¦‚æœ trigger è§¦å‘æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ä¸å½“å‰æ­£åœ¨æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ç›¸åŒï¼Œåˆ™ä¸è§¦å‘
    if (effectFn !== activeEffect) {
      effectsToRun.add(effectFn)
    }
  })
  effectsToRun.forEach(effectFn => {
    // å¦‚æœè¯¥å‰¯ä½œç”¨å‡½æ•°å­˜åœ¨è°ƒåº¦å™¨ï¼Œåˆ™è°ƒç”¨è¯¥è°ƒåº¦å™¨ï¼Œå¹¶å°†å‰¯ä½œç”¨å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’
    if (effectFn.options.scheduler) {
      effectFn.options.scheduler(effectFn)
    } else {
      // å¦åˆ™ç›´æ¥æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
      effectFn()
    }
  })
}
```

## computed ä¸ lazy

åœ¨æ·±å…¥è®²è§£ computed ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ¥äº†è§£æ‡’æ‰§è¡Œçš„ effectï¼Œå³ lazy çš„ effectã€‚

æˆ‘ä»¬é€šè¿‡ options ä¸­çš„ lazy å±æ€§æ¥å†³å®šæ˜¯å¦ç«‹å³æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼š

```js
function effect (fn, options = {}) {
  const effectFn = () => {
    cleanUp(effectFn)
    
    activeEffect = effectFn
    
    // åœ¨å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œä¹‹å‰ï¼Œå°†å½“å‰çš„å‰¯ä½œç”¨å‡½æ•°å‹å…¥æ ˆ
    effectStack.push(effectFn)
    
    // æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
    fn()
    
    // å°†å¯èƒ½çš„å†…å±‚åµŒå¥—ä¸­å…¥æ ˆçš„å‰¯ä½œç”¨å‡½æ•°å¼¹å‡º
    effectStack.pop()
    
    // æ¢å¤ä¹‹å‰çš„å‰¯ä½œç”¨å‡½æ•°
    activeEffect = effectStack.at(-1)
  }
  
  effectFn.deps = []

  // å°† options æŒ‚è½½åˆ° effectFn ä¸Š
  effectFn.options = options
  
  // åªæœ‰åœ¨é lazy çš„æƒ…å†µä¸‹ï¼Œç«‹å³æ‰§è¡Œ
  if (!options.lazy) {
    effectFn()
  }

  // å°†å‰¯ä½œç”¨å‡½æ•°ä½œä¸ºè¿”å›å€¼è¿”å›
  return effectFn
}
```

è¿™æ ·å­ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç° lazy çš„ effectï¼š

```js
const effectFn = effect(() => {
  console.log(obj.foo)
}, {
  lazy: true
})

// æ‰‹åŠ¨æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
effectFn()
```

å¦‚æœä»…ä»…èƒ½å¤Ÿæ‰‹åŠ¨æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œå…¶æ„ä¹‰å¹¶ä¸å¤§ã€‚ä½†å¦‚æœæˆ‘ä»¬æŠŠä¼ é€’ç»™ `effect()` å‡½æ•°çš„å‡½æ•°çœ‹ä½œä¸€ä¸ª getterï¼Œé‚£ä¹ˆè¿™ä¸ª getter å‡½æ•°å¯ä»¥è¿”å›ä»»ä½•å€¼ï¼Œä¾‹å¦‚ï¼š

```js
const effectFn = effect(
  // getter è¿”å› obj.foo + obj.bar çš„å€¼
  () => obj.foo + obj.bar,
  { lazy: true }
)
```

è¿™æ ·ï¼Œå½“æˆ‘ä»¬æ‰‹åŠ¨æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°æ—¶ï¼Œå°±èƒ½æ‹¿åˆ° `obj.foo + obj.bar` çš„ç»“æœï¼š

```js
const value = effectFn()
```

ä¸ºäº†å®ç°è¿™ä¸€ç›®æ ‡ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ `effect()` å‡½æ•°åšä¸€äº›ä¿®æ”¹ï¼š

```js
function effect (fn, options = {}) {
  const effectFn = () => {
    cleanUp(effectFn)
    
    activeEffect = effectFn
    
    // åœ¨å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œä¹‹å‰ï¼Œå°†å½“å‰çš„å‰¯ä½œç”¨å‡½æ•°å‹å…¥æ ˆ
    effectStack.push(effectFn)
    
    // + æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œå¹¶å°†å…¶è¿”å›å€¼äº¤ç»™ res
    const res = fn()
    
    // å°†å¯èƒ½çš„å†…å±‚åµŒå¥—ä¸­å…¥æ ˆçš„å‰¯ä½œç”¨å‡½æ•°å¼¹å‡º
    effectStack.pop()
    
    // æ¢å¤ä¹‹å‰çš„å‰¯ä½œç”¨å‡½æ•°
    activeEffect = effectStack.at(-1)

    // + è¿”å› res çš„ç»“æœ
    return res
  }
  
  effectFn.deps = []

  // å°† options æŒ‚è½½åˆ° effectFn ä¸Š
  effectFn.options = options
  
  // åªæœ‰åœ¨é lazy çš„æƒ…å†µä¸‹ï¼Œç«‹å³æ‰§è¡Œ
  if (!options.lazy) {
    effectFn()
  }

  // å°†å‰¯ä½œç”¨å‡½æ•°ä½œä¸ºè¿”å›å€¼è¿”å›
  return effectFn
}
```

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤Ÿå®ç°æ‡’æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ‹¿åˆ°å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œç»“æœï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å®ç° `computed` è®¡ç®—å±æ€§äº†ï¼š

```js
function computed (getter) {
  const effectFn = effect(getter, {
    lazy: true
  })
  
  const obj = {
    get value () {
      return effectFn()
    }
  }
  
  return obj
}
```

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `computed()` å‡½æ•°æ¥å‡½æ•°ä¸€ä¸ªè®¡ç®—å±æ€§ï¼š

```js
const data = { foo: 1, bar: 2 }
const obj = new Proxy(data, { /* ... */ })

const sumRes = computed(() => obj.foo + obj.bar)

console.log(sumRes.value) // 3
```

å¯ä»¥çœ‹åˆ°å®ƒèƒ½å¤Ÿæ­£ç¡®åœ°å·¥ä½œã€‚ä¸è¿‡ç°åœ¨æˆ‘ä»¬å®ç°çš„è®¡ç®—å±æ€§åªåšåˆ°äº†æ‡’è®¡ç®—ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªèƒ½å½“ä½ çœŸæ­£è¯»å– `sumRes.value` çš„å€¼æ—¶ï¼Œå®ƒæ‰ä¼šè¿›è¡Œè®¡ç®—å¹¶å¾—åˆ°å€¼ã€‚ä½†è¿˜åšä¸åˆ°å¯¹å€¼è¿›è¡Œç¼“å­˜ï¼Œå³å‡å¦‚æˆ‘ä»¬å¤šæ¬¡è®¿é—® `sumRes.value` çš„å€¼ï¼Œä¼šå¯¼è‡´ effectFn è¿›è¡Œå¤šæ¬¡è®¡ç®—ï¼Œå³ä½¿ obj.foo å’Œ obj.bar çš„å€¼å¹¶æœªå‘ç”Ÿå˜åŒ–ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å€¼è¿›è¡Œç¼“å­˜åŠŸèƒ½ï¼š

```js
function computed (getter) {
  // ç”¨æ¥ç¼“å­˜ä¸Šä¸€æ¬¡è®¡ç®—çš„å€¼
  let value
  // dirty æ ‡å¿—ç”¨æ¥æ ‡è¯†æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—å€¼
  let dirty

  const effectFn = effect(getter, {
    lazy: true
  })
  
  const obj = {
    get value () {
      if (dirty) {
        value = effectFn()
        dirty = false
      }
      return value
    }
  }
  
  return obj
}
```

è¿™æ ·å­è™½ç„¶è§£å†³äº†ç¼“å­˜é—®é¢˜ï¼Œä½†æ˜¯å½“ obj.foo æˆ– obj.bar çš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå†ä¸€æ¬¡è®¿é—® sumRes.value ä¼šå‘ç°ç»“æœå¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚

è¿™æ˜¯å› ä¸ºå½“ç¬¬ä¸€æ¬¡è®¿é—®æ—¶ï¼Œdirty çš„å€¼ä¼šè®¾ç½®ä¸º falseï¼Œæ„å‘³ç€ä¸éœ€è¦è®¡ç®—ã€‚å³ä½¿æˆ‘ä»¬ä¿®äº†å…¶ä¸­ä¾èµ–çš„æŸä¸ªå“åº”å¼æ•°æ®ï¼Œåªè¦ dirty ä¸º falseï¼Œå®ƒä»ç„¶ä¸ä¼šé‡æ–°è®¡ç®—ï¼Œæ‰€ä»¥å¯¼è‡´æˆ‘ä»¬ä¼šå¾—åˆ°é”™è¯¯çš„å€¼ã€‚

è§£å†³çš„åŠæ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬åˆ©ç”¨ä¸Šä¸€èŠ‚çš„è°ƒåº¦å™¨ï¼Œåœ¨ä¾èµ–çš„å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–è€Œè§¦å‘ `trigger()` å‡½æ•°æ‰§è¡Œæ—¶ï¼ŒæŠŠ dirty çš„å€¼æ”¹æˆ true å°±è¡Œï¼š

```js
function computed (getter) {
  // ç”¨æ¥ç¼“å­˜ä¸Šä¸€æ¬¡è®¡ç®—çš„å€¼
  let value
  // dirty æ ‡å¿—ç”¨æ¥æ ‡è¯†æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—å€¼
  let dirty

  const effectFn = effect(getter, {
    lazy: true,
    // åœ¨è°ƒåº¦å™¨ä¸­å°† dirty è®¾ç½®ä¸º true
    shceduler () {
      dirty = true
    }
  })
  
  const obj = {
    get value () {
      if (dirty) {
        value = effectFn()
        dirty = false
      }
      return value
    }
  }
  
  return obj
}
```

è¿™æ ·å­å°±å¯ä»¥å¾—åˆ°é¢„æœŸçš„ç»“æœäº†ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬è®¾è®¡çš„è®¡ç®—å±æ€§å·²ç»è¶‹äºå®Œç¾äº†ï¼Œä½†è¿˜æœ‰ä¸€ä¸ªç¼ºé™·ï¼Œå®ƒä½“ç°åœ¨å½“æˆ‘ä»¬åœ¨å¦å¤–ä¸€ä¸ª effect ä¸­è¯»å–è®¡ç®—å±æ€§çš„å€¼æ—¶ï¼š

```js
const sumRes = computed(() => obj.foo + obj.bar)

effect(() => {
  // åœ¨è¯¥å‰¯ä½œç”¨å‡½æ•°ä¸­è¯»å– sumRes.value
  console.log(sumRes.value)
})

// ä¿®æ”¹ obj.foo çš„å€¼
obj.foo++
```

æˆ‘ä»¬å°è¯•æ‰§è¡Œè¿™æ®µä»£ç ï¼Œä¼šå‘ç°ä¿®æ”¹ obj.foo çš„å€¼å¹¶ä¸ä¼šè§¦å‘å‰¯ä½œç”¨å‡½æ•°çš„æ¸²æŸ“ï¼Œå› æ­¤æˆ‘ä»¬è¯´è¿™æ˜¯ä¸€ä¸ªç¼ºé™·ã€‚

åˆ†æé—®é¢˜çš„åŸå› ï¼Œæˆ‘ä»¬å‘ç°ï¼Œä»æœ¬è´¨ä¸Šçœ‹è¿™å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ effect åµŒå¥—ã€‚ä¸€ä¸ªè®¡ç®—å±æ€§å†…éƒ¨æ‹¥æœ‰è‡ªå·±çš„ effectï¼Œå¹¶ä¸”å®ƒæ˜¯æ‡’æ‰§è¡Œçš„ï¼Œåªæœ‰å½“çœŸæ­£è¯»å–è®¡ç®—å±æ€§çš„å€¼æ—¶æ‰ä¼šæ‰§è¡Œã€‚å¯¹äºè®¡ç®—å±æ€§çš„ getter å‡½æ•°æ¥è¯´ï¼Œå®ƒé‡Œé¢è®¿é—®çš„å“åº”å¼æ•°æ®åªä¼šæŠŠ computed å†…éƒ¨çš„ effect æ”¶é›†ä¸ºä¾èµ–ã€‚è€Œå½“æŠŠè®¡ç®—å±æ€§ç”¨äºå¦å¤–ä¸€ä¸ª effect æ—¶ï¼Œå°±ä¼šå‘ç”Ÿ effect åµŒå¥—ï¼Œå¤–å±‚çš„ effect ä¸ä¼šè¢«å†…å±‚çš„ effect ä¸­çš„å“åº”å¼æ•°æ®æ”¶é›†ã€‚

è§£å†³çš„æ–¹æ³•å¾ˆç®€å•ã€‚å½“è¯»å–è®¡ç®—å±æ€§çš„å€¼æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨è°ƒç”¨ `track()` å‡½æ•°è¿›è¡Œè¿½è¸ªï¼›å½“è®¡ç®—å±æ€§ä¾èµ–çš„å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨è°ƒç”¨ `trigger()` å‡½æ•°è§¦å‘å“åº”ï¼š

```js
function computed (getter) {
  // ç”¨æ¥ç¼“å­˜ä¸Šä¸€æ¬¡è®¡ç®—çš„å€¼
  let value
  // dirty æ ‡å¿—ç”¨æ¥æ ‡è¯†æ˜¯å¦éœ€è¦é‡æ–°è®¡ç®—å€¼
  let dirty

  const effectFn = effect(getter, {
    lazy: true,
    // åœ¨è°ƒåº¦å™¨ä¸­å°† dirty è®¾ç½®ä¸º true
    shceduler () {
      dirty = true
      // å½“è®¡ç®—å±æ€§çš„å“åº”å¼æ•°æ®å˜åŒ–æ—¶ï¼Œæ‰‹åŠ¨è°ƒç”¨ trigger() å‡½æ•°è§¦å‘å“åº”
      trigger(obj, 'value')
    }
  })
  
  const obj = {
    get value () {
      if (dirty) {
        value = effectFn()
        dirty = true
      }
      // å½“è¯»å– value æ—¶ï¼Œæ‰‹åŠ¨è°ƒç”¨ track() å‡½æ•°è¿›è¡Œè¿½è¸ª
      return value
    }
  }
  
  return obj
}
```

## watch çš„å®ç°åŸç†

æ‰€è°“ watchï¼Œå…¶æœ¬è´¨å°±æ˜¯è§‚æµ‹ä¸€ä¸ªå“åº”å¼æ•°æ®ï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶é€šçŸ¥å¹¶æ‰§è¡Œç›¸åº”çš„å›è°ƒå‡½æ•°ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

```js
watch(obj, () => {
  console.log('æ•°æ®å˜äº†')
})

// ä¿®æ”¹å“åº”å¼æ•°æ®çš„å€¼ï¼Œä¼šå¯¼è‡´å›è°ƒå‡½æ•°çš„æ‰§è¡Œ
```

å®é™…ä¸Šï¼Œwatch çš„å®ç°å°±æ˜¯åˆ©ç”¨äº† effect ä»¥åŠ options.scheduler é€‰é¡¹ï¼š

```js
function watch (source, cb) {
  effect(
    // è§¦å‘è¯»å–æ“ä½œï¼Œä»è€Œå»ºç«‹è”ç³»
    () => source.foo,
    {
      scheduler () {
        // å½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè°ƒç”¨å›è°ƒå‡½æ•° cb()
        cb()
      }
    }
  )
}
```

è¿™æ ·å­ï¼Œæˆ‘ä»¬å¼€å§‹çš„ä¾‹å­å°±èƒ½å¤Ÿæ­£å¸¸å·¥ä½œäº†ã€‚ä½†æ˜¯ï¼Œè¿™æ ·å­å®ç°çš„ watchï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ç¡¬ç¼–ç çš„å½¢å¼æ¥å¯¹source.foo è¿›è¡Œè¯»å–æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ç°åœ¨åªèƒ½è§‚æµ‹åˆ° obj.foo çš„å˜åŒ–ã€‚ä¸ºäº†è®© watch å‡½æ•°å…·æœ‰é€šç”¨æ€§ï¼Œæˆ‘ä»¬éœ€è¦å°è£…ä¸€ä¸ªé€šç”¨çš„è¯»å–æ“ä½œï¼š

```js
function watch (source, cb) {
  effect(
    // è°ƒç”¨ traverse() é€’å½’åœ°è¯»å–
    () => traverse(source),
    {
      scheduler () {
        // å½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè°ƒç”¨å›è°ƒå‡½æ•° cb()
        cb()
      }
    }
  )
}

function traverse (value, seen = new Set()) {
  // å¦‚æœè¦è¯»å–çš„æ•°æ®æ˜¯ä¸€ä¸ªåŸå‹ç±»å‹
  // æˆ–è€…å·²ç»è¢«è¯»å–è¿‡äº†ï¼Œé‚£ä¹ˆä»€ä¹ˆéƒ½ä¸åš
  if (typeof value !== 'object' || value === null || seen.has(value)) {
    return
  }

  // å°†æ•°æ®åŠ å…¥ seen ä¸­ï¼Œä»£è¡¨å·²ç»è¯»å–è¿‡äº†ï¼Œé¿å…æ­»å¾ªç¯
  seen.add(value)

  // æš‚æ—¶ä¸è€ƒè™‘æ•°ç»„ç­‰å…¶ä»–ç»“æ„
  // å‡è®¾ value æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ for...in è¯»å–å¯¹è±¡çš„æ¯ä¸€ä¸ªå€¼ï¼Œå¹¶é€’å½’åœ°è°ƒç”¨ traverse è¿›è¡Œå¤„ç†
  for (const key in value) {
    traverse(value[key], seen)
  }

  return value
}
```

è¿™æ ·å­ï¼Œæˆ‘ä»¬å°±èƒ½å®ç°è¯»å–ä¸€ä¸ªå¯¹è±¡ä¸Šçš„ä»»æ„å±æ€§ï¼Œå½“æŸä¸ªå±æ€§å‘ç”Ÿå˜åŒ–æ—¶å°±èƒ½è§¦å‘å›è°ƒå‡½æ•°çš„æ‰§è¡Œäº†ã€‚

watch é™¤äº†å¯ä»¥è§‚æµ‹ä¸€ä¸ªå“åº”å¼æ•°æ®ï¼Œè¿˜å¯ä»¥æ¥æ”¶ä¸€ä¸ª getter å‡½æ•°ï¼š

```js
watch(
  // getter å‡½æ•°
	() => obj.foo,
  // å›è°ƒå‡½æ•°
  () => {
    console.log('obj.foo çš„å€¼å˜åŒ–äº†')
  }
)
```

æˆ‘ä»¬éœ€è¦å¯¹ watch å‡½æ•°åšä¸€äº›ä¿®æ”¹æ¥å®ç°è¿™ä¸ªç‰¹æ€§ï¼š

```js
function watch (source, cb) {
  // å®šä¹‰ä¸€ä¸ªgetter
  let getter

  if (typeof source === 'function') {
    getter = source
  } else {
    getter = () => traverse(source)
  }

  effect(
    // æ‰§è¡Œ getter
    () => getter(),
    {
      scheduler () {
        // å½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè°ƒç”¨å›è°ƒå‡½æ•° cb()
        cb()
      }
    }
  )
}
```

ç°åœ¨çš„å®ç°è¿˜ç¼ºå°‘ä¸€ä¸ªéå¸¸é‡è¦çš„èƒ½åŠ›ï¼Œå³åœ¨å›è°ƒå‡½æ•°ä¸­æ‹¿ä¸åˆ°æ–°å€¼å’Œæ—§å€¼ï¼š

```js
watch(
	() => obj.foo,
  (newValue, oldValue) => {
    console.log(newValue, oldValue)
  }
)
```

é‚£ä¹ˆå¦‚ä½•è·å–æ–°å€¼ä¸æ—§å€¼å‘¢ï¼Ÿè¿™éœ€è¦å……åˆ†åˆ©ç”¨ effect å‡½æ•°çš„ lazy é€‰é¡¹ï¼š

```js
function watch (source, cb) {
  // å®šä¹‰ä¸€ä¸ªgetter
  let getter

  if (typeof source === 'function') {
    getter = source
  } else {
    getter = () => traverse(source)
  }

  // å®šä¹‰æ–°å€¼ä¸æ—§å€¼
  let newValue
  let oldValue

  const effectFn = effect(
    // æ‰§è¡Œ getter
    () => getter(),
    {
      lazy: true,
      scheduler () {
        // åœ¨ scheduler ä¸­é‡æ–°æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œæ‹¿åˆ°æ–°å€¼
        newValue = effectFn()
        // å°†æ—§å€¼ä¸æ–°å€¼ä½œä¸ºå›è°ƒå‡½æ•°çš„å‚æ•°
        cb(newValue, oldValue)
        // å›è°ƒå‡½æ•°æ‰§è¡Œå®Œæ¯•å
        // å°† newValue çš„å€¼å­˜åˆ° oldValue ä¸­ï¼Œä¸‹ä¸€æ¬¡å°±èƒ½æ‹¿åˆ°æ­£ç¡®çš„æ—§å€¼
        oldValue = newValue
      }
    }
  )

  // æ‰‹åŠ¨è°ƒç”¨å‰¯ä½œç”¨å‡½æ•°ï¼Œæ‹¿åˆ°çš„å°±æ˜¯æ—§å€¼
  oldValue = effectFn()
}
```

## ç«‹å³æ‰§è¡Œçš„ watch ä¸å›è°ƒæ‰§è¡Œæ—¶æœº

åœ¨ Vue.js ä¸­å¯ä»¥é€šè¿‡é€‰é¡¹å‚æ•° immediate æ¥æŒ‡å®šå›è°ƒæ˜¯å¦éœ€è¦ç«‹å³æ‰§è¡Œï¼š

```js
watch(obj, () => {
  console.log('å˜åŒ–äº†')
}, {
  // å›è°ƒå‡½æ•°ä¼šåœ¨ watch åˆ›å»ºæ—¶ç«‹å³æ‰§è¡Œä¸€æ¬¡
  immediate: true
})
```

æˆ‘ä»¬ä»”ç»†æ€è€ƒå°±ä¼šå‘ç°ï¼Œå›è°ƒå‡½æ•°çš„ç«‹å³æ‰§è¡Œä¸åç»­æ‰§è¡Œæœ¬è´¨ä¸Šæ²¡æœ‰ä»»ä½•å·®åˆ«ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠ scheduler è°ƒåº¦å‡½æ•°å°è£…ä¸ºä¸€ä¸ªé€šç”¨å‡½æ•°ï¼Œåˆ†åˆ«åœ¨åˆå§‹åŒ–å’Œå˜æ›´æ—¶æ‰§è¡Œå®ƒï¼š

```js
function watch (source, cb, options = {}) {
  // å®šä¹‰ä¸€ä¸ªgetter
  let getter

  if (typeof source === 'function') {
    getter = source
  } else {
    getter = () => traverse(source)
  }

  // å®šä¹‰æ–°å€¼ä¸æ—§å€¼
  let newValue
  let oldValue

  // æå– scheduler è°ƒåº¦å‡½æ•°ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„ job å‡½æ•°
  const job = () => {
    // åœ¨ scheduler ä¸­é‡æ–°æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œæ‹¿åˆ°æ–°å€¼
    newValue = effectFn()
    // å°†æ—§å€¼ä¸æ–°å€¼ä½œä¸ºå›è°ƒå‡½æ•°çš„å‚æ•°
    cb(newValue, oldValue)
    // å›è°ƒå‡½æ•°æ‰§è¡Œå®Œæ¯•å
    // å°† newValue çš„å€¼å­˜åˆ° oldValue ä¸­ï¼Œä¸‹ä¸€æ¬¡å°±èƒ½æ‹¿åˆ°æ­£ç¡®çš„æ—§å€¼
    oldValue = newValue
  }

  const effectFn = effect(
    // æ‰§è¡Œ getter
    () => getter(),
    {
      lazy: true,
      scheduler: job
    }
  )

  if (options.immediate) {
    // å½“ immediate ä¸º true æ—¶ï¼Œç«‹å³æ‰§è¡Œ jobï¼Œä»è€Œè§¦å‘å›è°ƒæ‰§è¡Œ
    job()
  } else {
    // æ‰‹åŠ¨è°ƒç”¨å‰¯ä½œç”¨å‡½æ•°ï¼Œæ‹¿åˆ°çš„å°±æ˜¯æ—§å€¼
    oldValue = effectFn()
  }
}
```

é™¤äº†æŒ‡å®šå›è°ƒå‡½æ•°ç«‹å³æ‰§è¡Œä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡å…¶ä»–é€‰é¡¹å‚æ•°æ¥æŒ‡å®šæ¶è®¾å‡½æ•°çš„æ‰§è¡Œæ—¶æœºï¼Œä¾‹å¦‚åœ¨ Vue.js 3 ä¸­ä½¿ç”¨äº† flush é€‰é¡¹æ¥æŒ‡å®šï¼š

```js
watch(obj, () => {
  console.log('å˜åŒ–äº†')
}, {
  // å›è°ƒå‡½æ•°ä¼šåœ¨ watch åˆ›å»ºæ—¶ç«‹å³æ‰§è¡Œä¸€æ¬¡
  flush: 'pre' // è¿˜å¯ä»¥æ˜¯ 'post' | 'sync'
})
```

flush æœ¬è´¨ä¸Šæ˜¯åœ¨æŒ‡å®šè°ƒåº¦å‡½æ•°çš„æ‰§è¡Œæ—¶æœºã€‚å½“ flush ä¸º 'post' æ—¶ï¼Œä»£è¡¨è°ƒåº¦å‡½æ•°éœ€è¦å°†å‰¯ä½œç”¨å‡½æ•°æ”¾å…¥ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¹¶ç­‰å¾… DOM æ›´æ–°ç»“æŸåå†æ‰§è¡Œï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œæ¨¡æ‹Ÿï¼š

```js
function watch (source, cb, options = {}) {
  // å®šä¹‰ä¸€ä¸ªgetter
  let getter

  if (typeof source === 'function') {
    getter = source
  } else {
    getter = () => traverse(source)
  }

  // å®šä¹‰æ–°å€¼ä¸æ—§å€¼
  let newValue
  let oldValue

  // æå– scheduler è°ƒåº¦å‡½æ•°ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„ job å‡½æ•°
  const job = () => {
    // åœ¨ scheduler ä¸­é‡æ–°æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œæ‹¿åˆ°æ–°å€¼
    newValue = effectFn()
    // å°†æ—§å€¼ä¸æ–°å€¼ä½œä¸ºå›è°ƒå‡½æ•°çš„å‚æ•°
    cb(newValue, oldValue)
    // å›è°ƒå‡½æ•°æ‰§è¡Œå®Œæ¯•å
    // å°† newValue çš„å€¼å­˜åˆ° oldValue ä¸­ï¼Œä¸‹ä¸€æ¬¡å°±èƒ½æ‹¿åˆ°æ­£ç¡®çš„æ—§å€¼
    oldValue = newValue
  }

  const effectFn = effect(
    // æ‰§è¡Œ getter
    () => getter(),
    {
      lazy: true,
      scheduler: () => {
        if (options.flush === 'post') {
          // å¦‚æœ flush æ˜¯ 'post'ï¼Œåˆ™å°†è°ƒåº¦å‡½æ•°æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰§è¡Œ
          Promise.resolve().then(job)
        } else {
          // è¿™ç›¸å½“äº flush æ˜¯ 'sync' çš„è¡Œä¸º
          job()
        }
      }
    }
  )

  if (options.immediate) {
    // å½“ immediate ä¸º true æ—¶ï¼Œç«‹å³æ‰§è¡Œ jobï¼Œä»è€Œè§¦å‘å›è°ƒæ‰§è¡Œ
    job()
  } else {
    // æ‰‹åŠ¨è°ƒç”¨å‰¯ä½œç”¨å‡½æ•°ï¼Œæ‹¿åˆ°çš„å°±æ˜¯æ—§å€¼
    oldValue = effectFn()
  }
}
```

å¯¹äº options.flush çš„å€¼ä¸º 'pre' çš„æƒ…å†µï¼Œæˆ‘ä»¬æš‚æ—¶è¿˜æ²¡åŠæ³•æ¨¡æ‹Ÿï¼Œå› ä¸ºè¿™æ¶‰åŠç»„ä»¶çš„æ›´æ–°æ—¶æœºï¼Œå…¶ä¸­ â€˜preâ€™ å’Œ 'post' åŸæœ¬çš„è¯­ä¹‰æŒ‡çš„å°±æ˜¯ç»„ä»¶æ›´æ–°å‰å’Œæ›´æ–°åï¼Œä¸è¿‡è¿™å¹¶ä¸å½±å“æˆ‘ä»¬ç†è§£å¦‚ä½•æ§åˆ¶å›è°ƒå‡½æ•°çš„æ›´æ–°æ—¶æœºã€‚

## è¿‡æœŸçš„å‰¯ä½œç”¨

æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸‹é¢çš„ä»£ç ï¼š

```js
let finalData

watch(obj, async () => {
  const res = await fetch('/path/to/request')
  
  finalData = res
})

obj.foo++

setTimeout(() => {
  obj.foo++
}, 200)
```

å‡è®¾æˆ‘ä»¬çš„ fetch() ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼ˆæˆ‘ä»¬å°†å®ƒç§°ä¸ºè¯·æ±‚ Aï¼‰éœ€è¦ 1000ms æ‰ä¼šè¿”å›è¯·æ±‚ç»“æœï¼Œè€Œç¬¬äºŒæ¬¡ï¼ˆæˆ‘ä»¬å°†å®ƒç§°ä¸ºè¯·æ±‚ Bï¼‰åªéœ€è¦ 100ms å°±èƒ½å®Œæˆã€‚

é‚£ä¹ˆä¼šé€ æˆä»€ä¹ˆæ ·çš„ç»“æœå‘¢ï¼Ÿ

æœ€ç»ˆæˆ‘ä»¬çš„ finalData ä¼šæ‹¿åˆ°ç¬¬ä¸€æ¬¡è¯·æ±‚ç»“æœï¼Œè¿™å°±å’Œæˆ‘ä»¬é¢„æœŸçš„ä¸ä¸€æ ·ã€‚

è¯·æ±‚ A  æ˜¯å‰¯ä½œç”¨å‡½æ•°æ¯ä¸€æ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å‰¯ä½œç”¨å‡½æ•°ï¼Œè¯·æ±‚ B æ˜¯ç¬¬äºŒæ¬¡æ‰§è¡Œæ‰€äº§ç”Ÿçš„å‰¯ä½œç”¨å‡½æ•°ã€‚ç”±äºè¯·æ±‚ B åå‘ç”Ÿï¼Œæ‰€ä»¥è¯·æ±‚ B åº”è¯¥è§†ä¸º â€œæœ€æ–°çš„â€ï¼Œè€Œè¯·æ±‚ A åº”è¯¥è§†ä¸º â€œè¿‡æœŸçš„â€ï¼Œå…¶äº§ç”Ÿçš„ç»“æœåº”è¯¥æ˜¯æ— æ•ˆçš„ã€‚é€šè¿‡è¿™ç§æ–¹å¼å°±å¯ä»¥é¿å…ç«æ€é—®é¢˜å¯¼è‡´çš„é”™è¯¯ç»“æœã€‚

å½’æ ¹ç»“ä¹‰ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€ä¸ªè®©å‰¯ä½œç”¨è¿‡æœŸçš„æ‰‹æ®µã€‚ä¸ºäº†è®©é—®é¢˜æ›´åŠ æ¸…æ™°ï¼Œæˆ‘ä»¬å…ˆæ‹¿ Vue.js ä¸­çš„ watch å‡½æ•°æ¥å¤ç°åœºæ™¯ï¼Œçœ‹çœ‹ Vue.js æ˜¯å¦‚ä½•å¸®åŠ©å¼€å‘è€…è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Œç„¶åå°è¯•å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚

```js
watch(obj, async (newValue, oldValue, onInvalidate) => {
  // ç”¨äºæ ‡è¯†å‰¯ä½œç”¨å‡½æ•°æ˜¯å¦è¿‡æœŸ
	let expired = false
  
  // è°ƒç”¨ onInvalidate() å‡½æ•°æ³¨å†Œä¸€ä¸ªè¿‡æœŸå›è°ƒ
  onInvalidate(() => {
    // å½“è¿‡æœŸæ—¶ï¼Œå°† expired è®¾ç½®ä¸º true
		expired = true
  })
  
  const res = await fetch('/path/to/request')
  
  // åªæœ‰å½“è¯¥å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œæ²¡æœ‰è¿‡æœŸæ—¶ï¼Œæ‰ä¼šæ‰§è¡ŒåæœŸæ“ä½œã€‚
  if (!expired) {
		finalData = res
  }
})
```

Vue.js æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼ŸonInvalidate çš„åŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œåœ¨ watch å†…éƒ¨æ¯æ¬¡æ£€æµ‹åˆ°å˜æ›´åï¼Œåœ¨å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œä¹‹å‰ï¼Œä¼šå…ˆè°ƒç”¨æˆ‘ä»¬é€šè¿‡ onInvalidate å‡½æ•°æ³¨å†Œçš„è¿‡æœŸå›è°ƒï¼Œä»…æ­¤è€Œå·²ï¼Œå¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š

```js
function watch (source, cb, options = {}) {
  // å®šä¹‰ä¸€ä¸ªgetter
  let getter

  if (typeof source === 'function') {
    getter = source
  } else {
    getter = () => traverse(source)
  }

  // å®šä¹‰æ–°å€¼ä¸æ—§å€¼
  let newValue
  let oldValue

  // cleanup ç”¨æ¥å­˜å‚¨ç”¨æˆ·æ³¨å†Œçš„è¿‡æœŸå›è°ƒ
  let cleanup
  // å®šä¹‰ onInvalidate å‡½æ•°
  const onInvalidate = (fn) => {
    // å°†è¿‡æœŸå›è°ƒå­˜å‚¨åˆ° cleanup ä¸­
    cleanup = fn
  }

  // æå– scheduler è°ƒåº¦å‡½æ•°ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„ job å‡½æ•°
  const job = () => {
    // åœ¨ scheduler ä¸­é‡æ–°æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ï¼Œæ‹¿åˆ°æ–°å€¼
    newValue = effectFn()
    // åœ¨è°ƒç”¨å›è°ƒå‡½æ•° cb() ä¹‹å‰ï¼Œå…ˆè°ƒç”¨è¿‡æœŸå›è°ƒ
    if (cleanup) {
      cleanup()
    }
    // å°†æ—§å€¼ä¸æ–°å€¼ä½œä¸ºå›è°ƒå‡½æ•°çš„å‚æ•°
    // å°† onInvalidate ä½œä¸ºå›è°ƒå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œä»¥ä¾¿ç”¨æˆ·ä½¿ç”¨
    cb(newValue, oldValue, onInvalidate)
    // å›è°ƒå‡½æ•°æ‰§è¡Œå®Œæ¯•å
    // å°† newValue çš„å€¼å­˜åˆ° oldValue ä¸­ï¼Œä¸‹ä¸€æ¬¡å°±èƒ½æ‹¿åˆ°æ­£ç¡®çš„æ—§å€¼
    oldValue = newValue
  }

  const effectFn = effect(
    // æ‰§è¡Œ getter
    () => getter(),
    {
      lazy: true,
      scheduler: () => {
        if (options.flush === 'post') {
          // å¦‚æœ flush æ˜¯ 'post'ï¼Œåˆ™å°†è°ƒåº¦å‡½æ•°æ”¾åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰§è¡Œ
          Promise.resolve().then(job)
        } else {
          // è¿™ç›¸å½“äº flush æ˜¯ 'sync' çš„è¡Œä¸º
          job()
        }
      }
    }
  )

  if (options.immediate) {
    // å½“ immediate ä¸º true æ—¶ï¼Œç«‹å³æ‰§è¡Œ jobï¼Œä»è€Œè§¦å‘å›è°ƒæ‰§è¡Œ
    job()
  } else {
    // æ‰‹åŠ¨è°ƒç”¨å‰¯ä½œç”¨å‡½æ•°ï¼Œæ‹¿åˆ°çš„å°±æ˜¯æ—§å€¼
    oldValue = effectFn()
  }
}
```

## ğŸš€ ç« èŠ‚é“¾æ¥

- ä¸Šä¸€ç« ï¼š[Vue.js 3 çš„è®¾è®¡æ€è·¯](https://github.com/humandetail/VueJS-design-and-implementation/blob/master/notes/2.Vue.js%203%20%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF.md)

- ä¸‹ä¸€ç« : [éåŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ](https://github.com/humandetail/VueJS-design-and-implementation/blob/master/notes/4.%E9%9D%9E%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E6%96%B9%E6%A1%88.md)