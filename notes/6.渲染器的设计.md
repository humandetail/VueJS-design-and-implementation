# æ¸²æŸ“å™¨çš„è®¾è®¡

## æ¸²æŸ“å™¨ä¸å“åº”ç³»ç»Ÿçš„ç»“åˆ

é¡¾åæ€ä¹‰ï¼Œæ¸²æŸ“å™¨æ˜¯ç”¨æ¥æ‰§è¡Œæ¸²æŸ“ä»»åŠ¡çš„ã€‚åœ¨æµè§ˆå™¨å¹³å°ä¸Šï¼Œç”¨å®ƒæ¥æ¸²æŸ“å…¶ä¸­çš„çœŸå®DOMå…ƒç´ ã€‚æ¸²æŸ“å™¨ä¸ä»…èƒ½å¤Ÿæ¸²æŸ“çœŸå® DOM å…ƒç´ ï¼Œå®ƒè¿˜æ˜¯æ¡†æ¶è·¨å¹³å°èƒ½åŠ›çš„å…³é”®ã€‚å› æ­¤ï¼Œåœ¨è®¾è®¡æ¸²æŸ“å™¨çš„æ—¶å€™ä¸€å®šè¦è€ƒè™‘å¥½å¯è‡ªå®šä¹‰çš„èƒ½åŠ›ã€‚

æœ¬èŠ‚ï¼Œæˆ‘ä»¬æš‚æ—¶å°†æ¸²æŸ“å™¨é™å®šåœ¨ DOM å¹³å°ã€‚æ—¢ç„¶æ¸²æŸ“å™¨ç”¨æ¥æ¸²æŸ“çœŸå® DOM å…ƒç´ ï¼Œä¸¥æ ¼åœ°æ¥è¯´ï¼Œä¸‹é¢çš„å‡½æ•°å°±æ˜¯ä¸€ä¸ªåˆæ ¼çš„æ¸²æŸ“å™¨ï¼š

```js
function renderer (domString, container) {
	container.innerHTML = domString
}
```

åˆ©ç”¨å“åº”ç³»ç»Ÿï¼Œæˆ‘ä»¬å¯ä»¥è®©æ•´ä¸ªæ¸²æŸ“è¿‡ç¨‹è‡ªåŠ¨åŒ–ï¼š

```js
const count = ref(1)

effect(() => {
	renderer(`<h1>${count.value}</h1>`, document.getElementById('app'))
})

count.value++
```

æˆ‘ä»¬åˆ©ç”¨å“åº”ç³»ç»Ÿçš„èƒ½åŠ›ï¼Œè‡ªåŠ¨è°ƒç”¨æ¸²æŸ“å™¨å®Œæˆé¡µé¢çš„æ¸²æŸ“å’Œæ›´æ–°ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸æ¸²æŸ“å™¨çš„å…·ä½“å®ç°æ— å…³ï¼Œåœ¨ä¸Šé¢ç»™å‡ºçš„æ¸²æŸ“å™¨çš„å®ç°ä¸­ï¼Œä»…ä»…è®¾ç½®äº†å…ƒç´ çš„ innerHTML å†…å®¹ã€‚

ä»ç°åœ¨å¼€å§‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `@vue/reactivity` åŒ…æä¾›çš„å“åº”å¼ API è¿›è¡Œè®²è§£ã€‚

```html
<script src="https://unpkg.com/@vue/reactivity@3.2.37/dist/reactivity.global.js"></script>
```

```js
function renderer (domString, container) {
  container.innerHTML = domString
}

const { effect, ref } = VueReactivity

const count = ref(1)

effect(() => {
  renderer(`<h1>${count.value}</h1>`, document.getElementById('app'))
})

count.value++
```

## æ¸²æŸ“å™¨çš„åŸºæœ¬æ¦‚å¿µ

é€šè¿‡ï¼Œæˆ‘ä»¬ä½¿ç”¨ renderer æ¥è¡¨è¾¾â€œæ¸²æŸ“å™¨â€ã€‚æ¸²æŸ“å™¨çš„ä½œç”¨æ˜¯æŠŠè™šæ‹Ÿ DOM æ¸²æŸ“ä¸ºç‰¹å®šå¹³å°ä¸Šçš„çœŸå®å…ƒç´ ã€‚

è™šæ‹Ÿ DOM é€šå®µç”¨ virtual DOM æ¥è¡¨ç¤ºï¼Œæœ‰æ—¶ä¼šç®€å†™æˆ vdomã€‚è™šæ‹Ÿ DOM å’Œ çœŸå® DOM çš„ç»“æ„ä¸€æ ·ï¼Œéƒ½æ˜¯ç”±ä¸€ä¸ªä¸ªèŠ‚ç‚¹ç»„æˆçš„æ ‘å½¢ç»“æ„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ç»å¸¸èƒ½å¬åˆ°â€œè™šæ‹ŸèŠ‚ç‚¹â€è¿™æ ·çš„è¯ï¼Œå³ virtual nodeï¼Œæœ‰æ—¶ä¼šç®€å†™æˆ vnodeã€‚

è™šæ‹Ÿ DOM æ˜¯æ ‘å½¢ç»“æ„ï¼Œè¿™æ£µæ ‘ä¸­çš„ä»»ä½•ä¸€ä¸ª vnode èŠ‚ç‚¹éƒ½å¯ä»¥æ˜¯ä¸€æ£µå­æ ‘ï¼Œå› æ­¤ vnode å’Œ vdom æœ‰æ—¶å¯ä»¥æ›¿æ¢ä½¿ç”¨ã€‚ä¸ºäº†é¿å…é€ æˆå›°æ‰°ï¼Œæˆ‘ä»¬å°†ç»Ÿä¸€ä½¿ç”¨ vnodeã€‚

æ¸²æŸ“å™¨æŠŠè™šæ‹Ÿ DOM èŠ‚ç‚¹æ¸²æŸ“ä¸ºçœŸå® DOM åˆ‡ç‚¹çš„è¿‡ç¨‹å«ä½œ**æŒ‚è½½**ï¼Œé€šè¿‡ç”¨ mount æ¥è¡¨ç¤ºã€‚å¦å¤–ï¼Œæ¸²æŸ“å™¨é€šå¸¸éœ€è¦æ¥æ”¶ä¸€ä¸ªæŒ‚è½½ç‚¹ä½œä¸ºå‚æ•°ï¼Œç”¨äºæŒ‡å®šå…·ä½“çš„æŒ‚è½½ä½ç½®ï¼Œè¿™é‡Œçš„â€œæŒ‚è½½ç‚¹â€å…¶å®å°±æ˜¯ä¸€ä¸ª DOM å…ƒç´ ï¼Œé€šå¸¸ä½¿ç”¨ container æ¥è¡¨ç¤ºã€‚ä¸¾ä¸ªä¾‹å­ï¼š

```js
function createRenderer () {
  function render (vnode, container) {
    // ...
  }
  
  return render
}
```

ä¸ºä»€ä¹ˆéœ€è¦ä¸€ä¸ª createRenderer å‡½æ•°å‘¢ï¼Ÿæ¸²æŸ“å™¨ä¸æ¸²æŸ“æ˜¯ä¸åŒçš„ï¼Œæ¸²æŸ“å™¨æ˜¯æ›´åŠ å®½æ³›çš„æ¦‚å¿µï¼Œå®ƒä¸ä»…åŒ…å«äº†æ¸²æŸ“ï¼Œè¿˜å¯ä»¥ç”¨æ¥æ¿€æ´»å·²æœ‰çš„ DOM å…ƒç´ ï¼Œè¿™ä¸ªè¿‡ç¨‹é€šå¸¸å‘ç”Ÿåœ¨åŒç»“æ„æ¸²æŸ“çš„æƒ…å†µä¸‹ï¼š

```js
function createRenderer () {
  function render (vnode, container) {
    // ...
  }
  
  function hydrate (vnode, container) {
    // ...
  }
  
  return {
    render,
    hydrate
  }
}
```

è¿™ä¸ªä¾‹å­è¯´æ˜ï¼Œæ¸²æŸ“å™¨çš„å†…å®¹éå¸¸å¹¿æ³›ï¼Œè€Œç”¨æ¥æŠŠ vnode æ¸²æŸ“ä¸ºçœŸå® DOM çš„ render å‡½æ•°åªæ˜¯å…¶ä¸­ä¸€éƒ¨åˆ†ã€‚å®é™…ä¸Šï¼Œåœ¨ Vue.js 3 ä¸­ï¼Œç”šè‡³è¿åˆ›å»ºåº”ç”¨çš„ createApp å‡½æ•°ä¹Ÿæ˜¯æ¸²æŸ“å™¨çš„ä¸€éƒ¨åˆ†ã€‚

æœ‰äº†æ¸²æŸ“å™¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨å®ƒæ¥æ‰§è¡Œæ¸²æŸ“ä»»åŠ¡äº†ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š

```js
const renderer = createRenderer()
// é¦–æ¬¡æ¸²æŸ“
renderer.render(vnode, document.querySelector('#app'))
```

å½“é¦–æ¬¡è°ƒç”¨ renderer.render å‡½æ•°æ—¶ï¼Œåªéœ€è¦åˆ›å»ºæ–°çš„ DOM å…ƒç´ å³å¯ï¼Œè¿™ä¸ªè¿‡ç¨‹åªæ¶‰åŠ**æŒ‚è½½**ã€‚

è€Œå½“å¤šæ¬¡åœ¨åŒä¸€ä¸ª container ä¸Šè°ƒç”¨äº† renderer.render å‡½æ•°è¿›è¡Œæ¸²æŸ“æ—¶ï¼Œæ¸²æŸ“å™¨é™¤äº†è¦æ‰§è¡ŒæŒ‚è½½åŠ¨ä½œå¤–ï¼Œè¿˜è¦æ‰§è¡Œæ›´æ–°åŠ¨ä½œï¼š

```js
const renderer = createRenderer()
// é¦–æ¬¡æ¸²æŸ“
renderer.render(oldVnode, document.querySelector('#app'))
// ç¬¬äºŒæ¬¡æ¸²æŸ“
renderer.render(newVnode, document.querySelector('#app'))
```

ç”±äºé¦–æ¬¡æ¸²æŸ“æ—¶å·²ç»æŠŠ oldVnode æ¸²æŸ“åˆ° container å†…äº†ï¼Œæ‰€ä»¥å½“å†æ¬¡è°ƒç”¨ renderer.render å‡½æ•°å¹¶å°è¯•æ¸²æŸ“ newVnode æ—¶ï¼Œå°±ä¸èƒ½ç®€å•åœ°æ‰§è¡ŒæŒ‚è½½åŠ¨ä½œäº†ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¸²æŸ“å™¨ä¼šä½¿ç”¨ newVnode ä¸ä¸Šä¸€æ¬¡æ¸²æŸ“çš„ oldVnode è¿›è¡Œæ¯”è¾ƒï¼Œè¯•å›¾æ‰¾åˆ°å¹¶æ›´æ–°å˜æ›´ç‚¹ã€‚è¿™ä¸ªè¿‡ç¨‹å«ä½œ**æ‰“è¡¥ä¸ï¼ˆæˆ–æ›´æ–°ï¼‰**ï¼Œé€šå¸¸ä½¿ç”¨ patch è¡¨ç¤ºã€‚

å®é™…ä¸Šï¼ŒæŒ‚è½½åŠ¨ä½œä¹Ÿå¯ä»¥çœ‹ä½œä¸€ç§ç‰¹æ®Šçš„æ‰“è¡¥ä¸ï¼Œå®ƒçš„ç‰¹æ®Šä¹‹å¤„åœ¨äºæ—§çš„ vnode æ˜¯ä¸å­˜åœ¨çš„ã€‚æˆ‘ä»¬çœ‹ä¸‹ç¤ºä¾‹ï¼š

```js
function createRenderer () {
  function render (vnode, container) {
    if (vnode) {
      // æ–° vnode å­˜åœ¨ï¼Œå°†å…¶ä¸æ—§ vnode ä¸€èµ·ä¼ é€’ç»™ patch å‡½æ•°ï¼Œè¿›è¡Œæ›´æ–°
      patch(container._vnode, vnode, container)
    } else {
      if (container._vnode) {
        // æ—§ vnode å­˜åœ¨ï¼Œä¸”æ–° vnode ä¸å­˜åœ¨ï¼Œè¯´æ˜æ˜¯å¸è½½ï¼ˆunmountï¼‰æ“ä½œ
        // åªéœ€è¦å°† container å†…çš„ DOM æ¸…ç©ºå³å¯
        container.innerHTML = ''
      }
    }

    // æŠŠ vnode å­˜å‚¨åˆ° container._vnode ä¸‹ï¼Œå³åç»­æ¸²æŸ“ä¸­çš„æ—§ vnode
    container._vnode = vnode
  }

  return {
    render
  }
}

```

ä¸Šé¢è¿™æ®µä»£ç ç»™å‡ºäº† render() å‡½æ•°çš„åŸºæœ¬å®ç°ã€‚æˆ‘ä»¬å¯ä»¥é…åˆä¸‹é¢çš„ä»£ç åˆ†æå…¶æ‰§è¡Œæµç¨‹ï¼Œä»è€Œæ›´å¥½åœ°ç†è§£ render() å‡½æ•°çš„å®ç°æ€è·¯ã€‚å‡è®¾æˆ‘ä»¬è¿ç»­ä¸‰æ¬¡è°ƒç”¨ renderer.render() å‡½æ•°æ¥æ‰§è¡Œæ¸²æŸ“ï¼š

```js
const renderer = createRenderer()

// é¦–æ¬¡æ¸²æŸ“
renderer.render(vnode1, document.querySelector('#app'))
// ç¬¬äºŒæ¬¡æ¸²æŸ“
renderer.render(vnode2, document.querySelector('#app'))
// ç¬¬ä¸‰æ¬¡æ¸²æŸ“
renderer.render(null, document.querySelector('#app'))
```

+ åœ¨é¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œæ¸²æŸ“å™¨ä¼šå°† vnode1 æ¸²æŸ“ä¸ºçœŸå® DOMã€‚æ¸²æŸ“å®Œæˆåï¼Œvnode1 ä¼šå­˜åœ¨åˆ°å®¹å™¨å…ƒç´ çš„ `container._vnode` ä¸­ï¼Œå®ƒä¼šåœ¨åç»­æ¸²æŸ“ä¸­ä½œä¸ºæ—§ vnode ä½¿ç”¨ï¼›
+ ç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶ï¼Œæ—§ vnode å­˜åœ¨ï¼Œæ­¤æ—¶æ¸²æŸ“å™¨ä¼šæŠŠ vnode2 ä½œä¸ºæ–° vnode, å¹¶å°†æ–°æ—§ vnode ä¸€åŒä¼ é€’ç»™ `patch()` å‡½æ•°è¿›è¡Œæ›´æ–°æ“ä½œï¼›
+ ç¬¬ä¸‰æ¬¡æ¸²æŸ“æ—¶ï¼Œæ–° vnode çš„å€¼ä¸º nullï¼Œå³ä»€ä¹ˆéƒ½ä¸éœ€è¦æ¸²æŸ“ã€‚ä½†æ­¤æ—¶å®¹å™¨ä¸­æ¸²æŸ“çš„æ˜¯ vnode2 æ‰€æè¿°çš„å†…å®¹ï¼Œæ‰€ä»¥æ¸²æŸ“å™¨éœ€è¦æ¸…ç©ºå®¹å™¨ã€‚æˆ‘ä»¬æš‚æ—¶ä½¿ç”¨ `container.innerHTML = ''` æ¥å®ç°æ¸…ç©ºæ“ä½œã€‚

å¦å¤–ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°äº† `patch()` å‡½æ•°çš„ç­¾åï¼š

```js
patch(container._vnode, vnode, container)
```

è™½ç„¶æˆ‘ä»¬å¹¶æ²¡æœ‰ç»™å‡º `patch()` å‡½æ•°çš„å…·ä½“å®ç°ï¼Œä½†ä»ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä»ç„¶å¯ä»¥çª¥æ¢ `patch()` å‡½æ•°çš„éƒ¨åˆ†ç»†èŠ‚ã€‚å®é™…ä¸Šï¼Œ`patch()` å‡½æ•°æ˜¯æ•´ä¸ªæ¸²æŸ“å™¨çš„æ ¸å¿ƒå…¥å£ï¼Œå®ƒæ‰¿è½½äº†æœ€é‡è¦çš„æ¸²æŸ“é€»è¾‘ï¼Œæˆ‘ä»¬ä¼šèŠ±è´¹å¤§é‡ç¯‡å¹…æ¥è¯¦ç»†è®²è§£å®ƒï¼Œä½†è¿™é‡Œä»ç„¶æœ‰å¿…è¦å¯¹å®ƒåšä¸€äº›åˆæ­¥çš„è§£é‡Šã€‚

`patch()` å‡½æ•°è‡³å°‘æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼š

```js
function (oldVnode, newVnode, container) {
  // ...
}
```

å®ƒä¸ä»…å¯ä»¥ç”¨æ¥å®Œæˆæ›´æ–°ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ‰§è¡ŒæŒ‚è½½ã€‚

## è‡ªå®šä¹‰æ¸²æŸ“å™¨

æœ¬èŠ‚ï¼Œæˆ‘ä»¬å°†ä»¥æµè§ˆå™¨ä½œä¸ºæ¸²æŸ“çš„ç›®æ ‡å¹³å°ï¼Œç¼–å†™ä¸€ä¸ªæ¸²æŸ“å˜å˜ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œçœ‹çœ‹å“ªäº›å†…å®¹æ˜¯å¯ä»¥æŠ½è±¡çš„ï¼Œç„¶åé€šè¿‡æŠ½è±¡ï¼Œå°†æµè§ˆå™¨ç‰¹å®šçš„ API æŠ½ç¦»ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿å¾—æ¸²æŸ“å™¨çš„æ ¸å¿ƒä¸ä¾èµ–äºæµè§ˆå™¨ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å†ä¸ºé‚£äº›è¢«æŠ½ç¦»çš„ API æä¾›å¯é…ç½®çš„æ¥å£ï¼Œä»è€Œå®ç°è·¨å¹³å°çš„èƒ½åŠ›ã€‚

æˆ‘ä»¬å…ˆä»æ¸²æŸ“ä¸€ä¸ªæ™®é€šçš„ `<h1>` æ ‡ç­¾å¼€å§‹ï¼š

```js
const vnode = {
  type: 'h1',
  children: 'hello'
}
```

ä½¿ç”¨ä¸Šé¢çš„ vnode æ¥æè¿°ä¸€ä¸ª `<h1>` æ ‡ç­¾ï¼Œtype æè¿°ä¸€ä¸ª vnode çš„ç±»å‹ã€‚å½“ type ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å€¼æ—¶ï¼Œå¯ä»¥è®¤ä¸ºå®ƒæè¿°çš„æ˜¯æ™®é€šæ ‡ç­¾ï¼Œå¹¶ä½¿ç”¨è¯¥ type å±æ€§çš„å€¼ä½œä¸ºæ ‡ç­¾çš„åç§°ã€‚å¯¹äºè¿™æ ·ä¸€ä¸ª vnodeï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `render()` å‡½æ•°æ¸²æŸ“å®ƒï¼š

```js
const vnode = {
  type: 'h1',
  children: 'hello'
}

const renderer = createRenderer()

renderer.render(vnode, document.querySelector('#app'))
```

ä¸ºäº†å®Œæˆæ¸²æŸ“å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦è¡¥å…… `patch()` å‡½æ•°ï¼Œæˆ‘ä»¬å°† `patch()` å‡½æ•°ä¹Ÿç¼–å†™åœ¨ `createRenderer()` å‡½æ•°å†…ã€‚åœ¨åç»­çš„è®²è§£ä¸­ï¼Œå¦‚æ— ç‰¹æ®Šå£°æ˜ï¼Œæˆ‘ä»¬ç¼–å†™çš„å‡½æ•°éƒ½å®šä¹‰åœ¨ `createRenderer()` å‡½æ•°å†…ï¼š

```js
function createRenderer () {
  function render (vnode, container) {
    if (vnode) {
      // æ–° vnode å­˜åœ¨ï¼Œå°†å…¶ä¸æ—§ vnode ä¸€èµ·ä¼ é€’ç»™ patch å‡½æ•°ï¼Œè¿›è¡Œæ›´æ–°
      patch(container._vnode, vnode, container)
    } else {
      if (container._vnode) {
        // æ—§ vnode å­˜åœ¨ï¼Œä¸”æ–° vnode ä¸å­˜åœ¨ï¼Œè¯´æ˜æ˜¯å¸è½½ï¼ˆunmountï¼‰æ“ä½œ
        // åªéœ€è¦å°† container å†…çš„ DOM æ¸…ç©ºå³å¯
        container.innerHTML = ''
      }
    }

    // æŠŠ vnode å­˜å‚¨åˆ° container._vnode ä¸‹ï¼Œå³åç»­æ¸²æŸ“ä¸­çš„æ—§ vnode
    container._vnode = vnode
  }

  function patch (n1, n2, container) {
    // å¦‚æœ n1 ä¸å­˜åœ¨ï¼Œæ„å‘³ç€æŒ‚è½½ï¼Œåˆ™è°ƒç”¨ mountElement å‡½æ•°å®ŒæˆæŒ‚è½½
    if (!n1) {
      mountElement(n2, container)
    } else {
      // n1 å­˜åœ¨ï¼Œæ„å‘³ç€æ›´æ–°ï¼Œæš‚æ—¶çœç•¥
    }
  }

  return {
    render
  }
}
```

`mountElement()` å‡½æ•°çš„å®ç°å¦‚ä¸‹ï¼š

```js
function mountElement (vnode, container) {
  // åˆ›å»º DOM å…ƒç´ 
  const el = document.createElement(vnode.type)

  // å¤„ç†å­èŠ‚ç‚¹ï¼Œå¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
  if (typeof vnode.children === 'string') {
    el.textContent = vnode.children
  }

  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  container.appendChild(el)
}
```

æŒ‚è½½ä¸€ä¸ªæ™®é€šæ ‡ç­¾å…ƒç´ çš„å·¥ä½œå·²ç»å®Œæˆã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†æä¸‹è¿™æ®µä»£ç å­˜åœ¨çš„é—®é¢˜ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®¾è®¡ä¸€ä¸ªä¸ä¾èµ–äºç‰¹å®šå¹³å°çš„é€šç”¨æ¸²æŸ“å™¨ï¼Œä½†å¾ˆæ˜æ˜¾ï¼Œ`mountElement()` å‡½æ•°å†…è°ƒç”¨äº†å¤§é‡ä¾èµ–äºæµè§ˆå™¨çš„ APIã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠ½ç¦»è¿™äº› APIï¼Œåšæ³•ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠè¿™äº›æ“ä½œ DOM çš„ API ä½œä¸ºé…ç½®é¡¹ï¼Œè¯¥é…ç½®é¡¹å¯ä»¥ä½œä¸º `createRenderer()` å‡½æ•°çš„å‚æ•°ï¼š

```js
// åœ¨åˆ›å»º renderer æ—¶ä¼ å…¥é…ç½®é¡¹
const renderer = createRenderer({
  // ç”¨äºåˆ›å»ºå…ƒç´ 
  createElement(tag) {
    return document.createElement(tag)
  },
  // ç”¨äºè®¾ç½®å…ƒç´ çš„æ–‡æœ¬èŠ‚ç‚¹
  setElementText (el, text) {
    el.textContent = text
  },
  // ç”¨äºåœ¨ç»™å®šçš„ parent ä¸‹æ·»åŠ æŒ‡å®šå…ƒç´ 
  insert (el, parent, anchor = null) {
    parent.insertBefore(el, anchor)
  }
})
```

åœ¨æ ·ï¼Œåœ¨ `mountElement()` ç­‰å‡½æ•°å†…å°±å¯ä»¥é€šè¿‡é…ç½®é¡¹æ¥å–å¾—æ“ä½œ DOM çš„ API äº†ï¼š

```js
function createRenderer (options) {
  // é€šè¿‡ options å–å¾—æ“ä½œ DOM çš„ API
  const {
    createElement,
    insert,
    setElementText
  } = options

  function render (vnode, container) {
    // ...
  }

  function patch (n1, n2, container) {
    // ...
  }

  function mountElement (vnode, container) {
    // ...
  }

  return {
    render
  }
}
```

æ¥ç€ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä»é…ç½®é¡¹ä¸­å–å¾—çš„ API æ¥æ”¹é€  `mountElement()` å‡½æ•°ï¼š

```js
function mountElement (vnode, container) {
  // åˆ›å»º DOM å…ƒç´ 
  const el = createElement(vnode.type)

  // å¤„ç†å­èŠ‚ç‚¹ï¼Œå¦‚æœå­èŠ‚ç‚¹æ˜¯å­—ç¬¦ä¸²ï¼Œä»£è¡¨å…ƒç´ å…·æœ‰æ–‡æœ¬èŠ‚ç‚¹
  if (typeof vnode.children === 'string') {
    setElementText(el, vnode.children)
  }

  // å°†å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
  insert(el, container)
}
```

## ğŸš€ ç« èŠ‚é“¾æ¥

- ä¸Šä¸€ç« ï¼š[åŸå§‹å€¼çš„å“åº”å¼æ–¹æ¡ˆ](https://github.com/humandetail/VueJS-design-and-implementation/blob/master/notes/5.%E5%8E%9F%E5%A7%8B%E5%80%BC%E7%9A%84%E5%93%8D%E5%BA%94%E6%96%B9%E6%A1%88.md)

- ä¸‹ä¸€ç« : [æŒ‚è½½ä¸æ›´æ–°](https://github.com/humandetail/VueJS-design-and-implementation/blob/master/notes/7.%E6%8C%82%E8%BD%BD%E4%B8%8E%E6%9B%B4%E6%96%B0.md)