# ç»„ä»¶çš„å®ç°åŸç†

æœ‰äº†ç»„ä»¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†ä¸€ä¸ªå¤§çš„é¡µé¢æ‹†åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸€ä¸ªéƒ¨åˆ†éƒ½å¯ä»¥ä½œä¸ºå•ç‹¬çš„ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶å…±åŒç»„æˆå®Œæ•´çš„é¡µé¢ã€‚ç»„ä»¶åŒ–çš„å®ç°åŒæ ·éœ€è¦æ¸²æŸ“å™¨çš„æ”¯æŒã€‚

## æ¸²æŸ“ç»„ä»¶

ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œä¸€ä¸ªæœ‰çŠ¶æ€ç»„ä»¶å°±æ˜¯ä¸€ä¸ªé€‰é¡¹å¯¹è±¡ï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼š

```js
const MyComponent = {
  name: 'MyComponent',
  data () {
    return { foo: 1 }
  }
}
```

ä½†æ˜¯ï¼Œå¦‚æœä»æ¸²æŸ“å™¨çš„å†…éƒ¨å®ç°æ¥çœ‹ï¼Œä¸€ä¸ªç»„ä»¶åˆ™ä¸€ä¸ªç‰¹æ®Šç±»å‹çš„è™šæ‹Ÿ DOM èŠ‚ç‚¹ã€‚ä¾‹å¦‚ï¼š

```js
// æ™®é€šæ ‡ç­¾
const vnode = {
  type: 'div',
  // ...
}

// ç‰‡æ®µ
const vnode = {
  type: VNODE_TYPES.Fragment,
  // ...
}

// æ–‡æœ¬èŠ‚ç‚¹
const vnode = {
  type: VNODE_TYPES.Text,
  // ...
}
```

æ¸²æŸ“å™¨çš„ `patch()` å‡½æ•°è¯æ˜äº†ä¸Šè¿°å†…å®¹ï¼Œä»¥ä¸‹æ˜¯æˆ‘ä»¬ä¹‹å‰å®ç°çš„ `patch()` å‡½æ•°çš„ä»£ç ï¼š

```js
function patch (n1, n2, container, anchor) {
  // ...
  if (typeof type === 'string') {
    // ...
  } else if (type === VNODE_TYPES.Text) {
    // ...
  } else if (type === VNODE_TYPES.Comment) {
    // ...
  } else if (type === VNODE_TYPES.Fragment) {
    // ...
  }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæ¸²æŸ“å™¨ä¼šä½¿ç”¨è™šæ‹ŸèŠ‚ç‚¹çš„ type å±æ€§æ¥åŒºåˆ†å…¶ç±»å‹ã€‚å¯¹äºä¸åŒç±»å‹çš„èŠ‚ç‚¹ï¼Œéœ€è¦é‡‡ç”¨ä¸åŒçš„æ–¹å¼æ¥å¤„ç†ã€‚

å®é™…ä¸Šï¼Œå¯¹äºç»„ä»¶æ¥è¯´ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚ä¸ºäº†ä½¿ç”¨è™šæ‹ŸèŠ‚ç‚¹æ¥æè¿°ç»„ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è™šæ‹ŸèŠ‚ç‚¹çš„ `vnode.type` å±æ€§è¿›è¡Œå¤„ç†ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼Œ`vnode.type` å¦‚æœæ˜¯ä¸€ä¸ªå¯¹è±¡çš„æƒ…å†µï¼Œåˆ™è®¤ä¸ºè¯¥è™šæ‹ŸèŠ‚ç‚¹æ˜¯åœ¨æè¿°ä¸€ä¸ªç»„ä»¶ï¼Œå¹¶è°ƒç”¨ `mountComponent()` å’Œ `patchComponent()` å‡½æ•°æ¥å®Œæˆç»„ä»¶çš„æŒ‚è½½å’Œæ›´æ–°ã€‚

```js
function patch (n1, n2, container, anchor) {
  // ...
  if (typeof type === 'string') {
    // ...
  } else if (typeof type === 'object') {
    // å¦‚æœ n2.type æ˜¯å¯¹è±¡ï¼Œåˆ™å®ƒæè¿°çš„æ˜¯ç»„ä»¶
    if (!n1) {
      // æŒ‚è½½ç»„ä»¶
      mountComponent(n2, container, anchor)
    } else {
      // æ›´æ–°ç»„ä»¶
      patchComponent(n1, n2, anchor)
    }
  } else if (type === VNODE_TYPES.Text) {
    // ...
  } else if (type === VNODE_TYPES.Comment) {
    // ...
  } else if (type === VNODE_TYPES.Fragment) {
    // ...
  }
}
```

æ¸²æŸ“å™¨æœ‰èƒ½åŠ›å¤„ç†ç»„ä»¶åï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬è¦åšçš„æ˜¯ï¼Œè®¾è®¡ç»„ä»¶åœ¨ç”¨æˆ·å±‚é¢çš„æ¥å£ã€‚è¿™åŒ…æ‹¬ï¼šç”¨æˆ·åº”è¯¥å¦‚ä½•ç¼–å†™ç»„ä»¶ï¼Ÿç»„ä»¶çš„é€‰é¡¹å¯¹è±¡å¿…é¡»åŒ…å«å“ªäº›å†…å®¹ï¼Ÿä»¥åŠç»„ä»¶æ‹¥æœ‰å“ªäº›èƒ½åŠ›ï¼Ÿç­‰ç­‰ã€‚

å®é™…ä¸Šï¼Œç»„ä»¶æœ¬èº«æ˜¯å¯¹é¡µé¢å†…å®¹çš„å°è£…ï¼Œå®ƒç”¨æ¥æè¿°é¡µé¢å†…å®¹çš„ä¸€éƒ¨åˆ†ã€‚å› æ­¤ï¼Œä¸€ä¸ªç»„ä»¶å¿…é¡»åŒ…å«ä¸€ä¸ªæ¸²æŸ“å‡½æ•°ï¼Œå³ `render()` å‡½æ•°ï¼Œå¹¶ä¸”æ¸²æŸ“å‡½æ•°çš„è¿”å›å€¼åº”è¯¥æ˜¯è™šæ‹Ÿ DOMã€‚æ¢å¥è¯è¯´ï¼Œç»„ä»¶çš„æ¸²æŸ“å‡½æ•°å°±æ˜¯ç”¨æ¥æè¿°ç»„ä»¶æ‰€æ¸²æŸ“å†…å®¹çš„æ¥å£ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š

```js
const MyComponent = {
  name: 'MyComponent',
  
  render () {
    return {
      type: 'div',
      children: 'æˆ‘æ˜¯æ–‡æœ¬å†…å®¹'
    }
  }
}
```

è¿™æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„ç»„ä»¶ç¤ºä¾‹ã€‚æœ‰äº†åŸºæœ¬çš„ç»„ä»¶ç»“æ„ä¹‹åï¼Œæ¸²æŸ“å™¨å°±å¯ä»¥å®Œæˆç»„ä»¶çš„æ¸²æŸ“ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š

```js
const CompVNode = {
  type: MyComponent
}
// è°ƒç”¨æ¸²æŸ“å™¨æ¥æ¸²æŸ“ç»„ä»¶
renderer.render(CompVNode, document.querySelector('#app'))
```

æ¸²æŸ“å™¨ä¸­çœŸæ­£å®Œæˆç»„ä»¶æ¸²æŸ“ä»»åŠ¡çš„æ˜¯ `mountComponent()` å‡½æ•°ï¼Œå…¶å…·ä½“å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š

```js
function mountComponent (vnode, container, anchor) {
  // é€šè¿‡ vnode è·å–ç»„ä»¶çš„é€‰é¡¹å¯¹è±¡ï¼Œå³ vnode.type
  const componentOptions = vnode.type
  // è·å–ç»„ä»¶çš„æ¸²æŸ“å‡½æ•°
  const { render } = componentOptions
  // æ‰§è¡Œæ¸²æŸ“å‡½æ•°ï¼Œè·å–ç»„ä»¶è¦æ¸²æŸ“çš„å†…å®¹
  const subTree = render()
  // æœ€åè°ƒç”¨ patch() å‡½æ•°æ¥æŒ‚è½½ç»„ä»¶æ‰€æè¿°çš„å†…å®¹
  patch(null, subTree, container, anchor)
}
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®ç°äº†æœ€åŸºæœ¬çš„ç»„ä»¶åŒ–æ–¹æ¡ˆã€‚

## ç»„ä»¶çŠ¶æ€ä¸è‡ªæ›´æ–°

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°è¯•ä¸ºç»„ä»¶è®¾è®¡è‡ªèº«çš„çŠ¶æ€ï¼š

```js
const MyComponent = {
  name: 'MyComponent',
  // ç”¨ data() å‡½æ•°æ¥å®šä¹‰ç»„ä»¶è‡ªèº«çš„çŠ¶æ€
  data () {
    return {
      foo: 'Hello world.'
    }
  },
  render () {
    return {
      type: 'div',
      children: `foo çš„å€¼æ˜¯ï¼š${this.foo}` // åœ¨æ¸²æŸ“å‡½æ•°å†…ä½¿ç”¨ç»„ä»¶çŠ¶æ€
    }
  }
}
```

æˆ‘ä»¬çº¦å®šç”¨æˆ·å¿…é¡»ä½¿ç”¨ `data()` å‡½æ•°æ¥å®šä¹‰ç»„ä»¶çš„è‡ªèº«çŠ¶æ€ï¼ŒåŒæ—¶å¯ä»¥åœ¨æ¸²æŸ“å‡½æ•°ä¸­é€šè¿‡ this è®¿é—®ç”± `data()` å‡½æ•°è¿”å›çš„çŠ¶æ€æ•°æ®ã€‚

ä¸‹é¢çš„ä»£ç å®ç°äº†ç»„ä»¶è‡ªèº«çŠ¶æ€çš„åˆå§‹åŒ–ï¼š

```js
function mountComponent (vnode, container, anchor) {
  const componentOptions = vnode.type
  const { data, render } = componentOptions

  // è°ƒç”¨ data() å‡½æ•°å¾—åˆ°åŸå§‹æ•°ç»„ï¼Œå¹¶è°ƒç”¨ reactive() å‡½æ•°å°†å…¶åŒ…è£…æˆå“åº”å¼æ•°ç»„
  const state = reactive(data())

  // è°ƒç”¨ render() å‡½æ•°æ—¶ï¼Œå°†å…¶ this è®¾ç½®ä¸º stateï¼Œ
  // ä»è€Œ render() å‡½æ•°å†…éƒ¨å¯ä»¥é€šè¿‡ this è®¿é—®ç»„ä»¶è‡ªèº«çŠ¶æ€æ•°æ®
  const subTree = render.call(state, state)
  // æœ€åè°ƒç”¨ patch() å‡½æ•°æ¥æŒ‚è½½ç»„ä»¶æ‰€æè¿°çš„å†…å®¹
  patch(null, subTree, container, anchor)
}
```

å¦‚æ­¤ï¼Œæˆ‘ä»¬å°±å®ç°äº†å¯¹ç»„ä»¶è‡ªèº«çŠ¶æ€çš„æ”¯æŒï¼Œä»¥åŠåœ¨æ¸²æŸ“å‡½æ•°å†…è®¿é—®ç»„ä»¶è‡ªèº«çŠ¶æ€çš„èƒ½åŠ›ã€‚

å½“ç»„ä»¶è‡ªèº«çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æœ‰èƒ½åŠ›è§¦å‘ç»„ä»¶æ›´æ–°ï¼Œå³**ç»„ä»¶çš„è‡ªæ›´æ–°ã€‚**ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å°†æ•´ä¸ªæ¸²æŸ“ä»»ä½•åŒ…è£…åˆ°ä¸€ä¸ª `effect()` ä¸­ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š

```js
function mountComponent (vnode, container, anchor) {
  const componentOptions = vnode.type
  const { data, render } = componentOptions

  // è°ƒç”¨ data() å‡½æ•°å¾—åˆ°åŸå§‹æ•°ç»„ï¼Œå¹¶è°ƒç”¨ reactive() å‡½æ•°å°†å…¶åŒ…è£…æˆå“åº”å¼æ•°ç»„
  const state = reactive(data())

  effect(() => {
    // è°ƒç”¨ render() å‡½æ•°æ—¶ï¼Œå°†å…¶ this è®¾ç½®ä¸º stateï¼Œ
    // ä»è€Œ render() å‡½æ•°å†…éƒ¨å¯ä»¥é€šè¿‡ this è®¿é—®ç»„ä»¶è‡ªèº«çŠ¶æ€æ•°æ®
    const subTree = render.call(state, state)
    // æœ€åè°ƒç”¨ patch() å‡½æ•°æ¥æŒ‚è½½ç»„ä»¶æ‰€æè¿°çš„å†…å®¹
    patch(null, subTree, container, anchor)
  })
}
```

è¿™æ ·ï¼Œä¸€æ—¦ç»„ä»¶è‡ªèº«çš„å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œç»„ä»¶å°±ä¼šè‡ªåŠ¨é‡æ–°æ‰§è¡Œæ¸²æŸ“å‡½æ•°ï¼Œä»è€Œå®Œæˆæ›´æ–°ã€‚

ä½†æ˜¯ï¼Œç”±äº `effect()` çš„æ‰§è¡Œæ˜¯åŒæ­¥çš„ï¼Œå› æ­¤å½“å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¸ä¹‹å…³è”çš„å‰¯ä½œç”¨å‡½æ•°ä¼šåŒæ­¥æ‰§è¡Œï¼Œå¦‚æœå¤šæ¬¡ä¿®æ”¹ï¼Œå°†ä¼šå¯¼è‡´æ¸²æŸ“å‡½æ•°æ‰§è¡Œå¤šæ¬¡ï¼Œè¿™å®é™…ä¸Šæ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªè°ƒåº¦å™¨æ¥é¿å…å¤šæ¬¡æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š

```js
// ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—ï¼Œç”¨ä¸€ä¸ª Set æ•°æ®ç»“æ„æ¥è¡¨ç¤ºï¼Œè¿™æ ·å°±å¯ä»¥è‡ªåŠ¨å¯¹ä»»åŠ¡è¿›è¡Œå»é‡
const queue = new Set()
// æ ‡è¯†ï¼Œä»£è¡¨æ˜¯å¦æ­£åœ¨åˆ·æ–°ä»»åŠ¡é˜Ÿåˆ—
let isFlushing = false
const p = Promise.resolve()

// è°ƒåº¦å™¨çš„ä¸»è¦å‡½æ•°ï¼Œç”¨æ¥å°†ä¸€ä¸ªä»»åŠ¡æ·»åŠ åˆ°ç¼“å†²é˜Ÿåˆ—ä¸­ï¼Œå¹¶å¼€å§‹åˆ·æ–°é˜Ÿåˆ—
function queueJob (job) {
  // å°†ä»»åŠ¡åŠ åˆ°é˜Ÿåˆ—ä¸­
  queue.add(job)

  // å¦‚æœè¿˜æ²¡æœ‰å¼€å§‹åˆ·æ–°é˜Ÿåˆ—ï¼Œåˆ™åˆ·æ–°
  if (!isFlushing) {
    // å°†æ ‡è¯†è®¾ç½®ä¸º true ä»¥é¿å…é‡å¤åˆ·æ–°
    isFlushing = true

    // åœ¨å¾®ä»»åŠ¡ä¸­åˆ·æ–°ç¼“å†²é˜Ÿåˆ—
    p.then(() => {
      try {
        // æ‰§è¡Œä»»åŠ¡
        queue.forEach(job => job())
      } finally {
        // é‡ç½®çŠ¶æ€
        isFlushing = false
        queue.length = 0
      }
    })
  }
}
```

ä¸Šé¢æ˜¯è°ƒåº¦å™¨çš„æœ€å°å®ç°ï¼Œæœ¬è´¨ä¸Šåˆ©ç”¨äº†å¾®ä»»åŠ¡çš„å¼‚æ­¥æ‰§è¡Œæœºåˆ¶ï¼Œå®ç°å¯¹å‰¯ä½œç”¨å‡½æ•°çš„ç¼“å†²ã€‚æœ‰äº† `queueJob()` å‡½æ•°ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨åˆ›å»ºæ¸²æŸ“å‰¯ä½œç”¨æ—¶ä½¿ç”¨å®ƒï¼š

```js
function mountComponent (vnode, container, anchor) {
  // ...

  effect(() => {
    // ...
  }, {
    // æŒ‡å®šè¯¥å‰¯ä½œç”¨å‡½æ•°çš„è°ƒåº¦å™¨ä¸º queueJob å³å¯
    scheduler: queueJob
  })
}
```

è¿™æ ·ï¼Œå½“å“åº”å¼æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‰¯ä½œç”¨å‡½æ•°ä¸ä¼šç«‹å³åŒæ­¥æ‰§è¡Œï¼Œè€Œæ˜¯ä¼šè¢« `queueJob()` å‡½æ•°è°ƒåº¦ï¼Œæœ€ååœ¨ä¸€ä¸ªå¾®ä»»åŠ¡ä¸­æ‰§è¡Œã€‚

ä¸è¿‡ï¼Œä¸Šé¢çš„è¿™æ®µä»£ç å­˜åœ¨ç€ç¼ºé™·ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨ `effect()` ä¸­è°ƒç”¨ `patch()` å‡½æ•°å®Œæˆæ¸²æŸ“æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°é—®é¢˜ nullã€‚è¿™æ„å‘³ç€ï¼Œæ¯æ¬¡æ›´æ–°å‘ç”Ÿæ—¶éƒ½ä¼šè¿›è¡Œå…¨æ–°çš„æŒ‚è½½ï¼Œè€Œä¸ä¼šæ‰“è¡¥ä¸ï¼Œè¿™æ˜¯ä¸æ­£ç¡®çš„ã€‚

æ­£ç¡®çš„åšæ³•æ˜¯ï¼šæ¯æ¬¡æ›´æ–°æ—¶ï¼Œéƒ½æ‹¿æ–°çš„ subTree ä¸ä¸Šä¸€ç»„ç»„ä»¶æ‰€æ¸²æŸ“çš„ subTree è¿›è¡Œæ‰“è¡¥ä¸ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ç»„ä»¶å®ä¾‹ï¼Œç”¨å®ƒæ¥ç»´æŠ¤ç»„ä»¶æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€ï¼Œè¿™æ ·æ¸²æŸ“å™¨æ‰èƒ½å¤Ÿåœ¨æ­£ç¡®çš„æ—¶æœºæ‰§è¡Œåˆé€‚çš„æ“ä½œã€‚

## ç»„ä»¶å®ä¾‹ä¸ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ

ç»„ä»¶å®ä¾‹æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªçŠ¶æ€é›†åˆï¼ˆæˆ–ä¸€ä¸ªå¯¹è±¡ï¼‰ï¼Œå®ƒç»´æŠ¤ç€ç»„ä»¶è¿è¡Œè¿‡ç¨‹ä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä¾‹å¦‚æ³¨å†Œåˆ°ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ã€ç»„ä»¶æ¸²æŸ“çš„å­æ ‘ï¼ˆsubTreeï¼‰ã€ç»„ä»¶æ˜¯å¦å·²ç»è¢«æŒ‚è½½ã€ç»„ä»¶è‡ªèº«çš„çŠ¶æ€ï¼ˆstateï¼‰ï¼Œç­‰ç­‰ã€‚

ä¸ºäº†è§£å†³ä¹‹å‰å…³äºç»„ä»¶æ›´æ–°çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥ç»„ä»¶å®ä¾‹çš„æ¦‚å¿µï¼Œä»¥åŠä¸ä¹‹ç›¸å…³çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¦‚ä»¥ä¸‹çš„ä»£ç æ‰€ç¤ºï¼š

```js
function mountComponent (vnode, container, anchor) {
  const componentOptions = vnode.type
  const { data, render } = componentOptions

  const state = reactive(data())

  // å®šä¹‰ç»„ä»¶å®ä¾‹ï¼Œä¸€ä¸ªç»„ä»¶å®ä¾‹æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒåŒ…å«ä¸ç»„ä»¶æœ‰å…³çš„çŠ¶æ€ä¿¡æ¯
  const instance = {
    // ç»„ä»¶è‡ªèº«çš„çŠ¶æ€æ•°æ®ï¼Œå³ data
    state,
    // ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç»„ä»¶æ˜¯å¦å·²ç»è¢«æŒ‚è½½
    isMounted: false,
    // ç»„ä»¶æ‰€æ¸²æŸ“çš„å†…å®¹ï¼Œå³å­æ ‘ subTree
    subTree: null
  }

  // å°†ç»„ä»¶å®ä¾‹è®¾ç½®åˆ° vnode ä¸Šï¼Œç”¨äºåç»­æ›´æ–°
  vnode.component = instance

  effect(() => {
    const subTree = render.call(state, state)

    // æ£€æµ‹ç»„ä»¶æ˜¯å¦å·²ç»è¢«æŒ‚è½½
    if (!instance.isMounted) {
      // åˆæ¬¡æŒ‚è½½ï¼Œè°ƒç”¨ patch() å‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ null
      patch(null, subTree, container, anchor)
      // é‡ç‚¹ï¼šå°†ç»„ä»¶å®ä¾‹ä¸Šçš„ isMounted æ ‡è®°ä¸º trueï¼Œè¿™æ ·å½“æ›´æ–°å‘ç”Ÿæ—¶å°±ä¸ä¼šå†æ¬¡è¿›è¡ŒæŒ‚è½½æ“ä½œ
      // è€Œæ˜¯æ‰§è¡Œæ›´æ–°æ“ä½œ
      instance.isMounted = true
    } else {
      // å½“ isMounted ä¸º true æ—¶ï¼Œè¯´æ˜ç»„ä»¶å·²ç»è¢«æŒ‚è½½äº†ï¼Œåªéœ€è¦å®Œæˆè‡ªæ›´æ–°å³å¯ï¼Œ
      // æ‰€ä»¥åœ¨è°ƒç”¨ patch() å‡½æ•°æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç»„ä»¶ä¸Šä¸€æ¬¡æ¸²æŸ“çš„å­æ ‘ï¼Œ
      // æ„æ€æ˜¯ï¼šä½¿ç”¨æ–°çš„å­æ ‘ä¸ä¸Šä¸€æ¬¡æ¸²æŸ“çš„å­æ ‘è¿›è¡Œæ‰“è¡¥ä¸æ“ä½œ
      patch(vnode.subTree, subTree, container, anchor)
    }

    // æ›´æ–°ç»„ä»¶å®ä¾‹çš„å­æ ‘
    vnode.subTree = subTree
  }, {
    scheduler: queueJob
  })
}
```

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡æ¥è¡¨ç¤ºç»„ä»¶å®ä¾‹ï¼Œè¯¥å¯¹è±¡æœ‰ä¸‰ä¸ªå±æ€§ï¼š

+ stateï¼šç»„ä»¶è‡ªèº«çš„çŠ¶æ€æ•°æ®ï¼Œå³ dataï¼›
+ isMountedï¼šè¡¨ç¤ºç»„ä»¶æ˜¯å¦è¢«æŒ‚è½½ï¼›
+ subTreeï¼šå­˜å‚¨ç»„ä»¶çš„æ¸²æŸ“å‡½æ•°è¿”å›çš„è™šæ‹Ÿ DOMï¼Œå³ç»„ä»¶çš„å­æ ‘ï¼ˆsubTreeï¼‰ã€‚

å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™ï¼Œä»»æ„åœ°åœ¨ç»„ä»¶å®ä¾‹ instance ä¸Šæ·»åŠ éœ€è¦çš„å±æ€§ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åº”è¯¥å°½å¯èƒ½åœ°ä¿æŒç»„ä»¶å®ä¾‹è½»é‡ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨ã€‚

æˆ‘ä»¬å·²ç»åŒºåˆ†äº†ç»„ä»¶çš„æŒ‚è½½å’Œæ›´æ–°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨ç»„ä»¶å¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼š

```js
function mountComponent (vnode, container, anchor) {
  const componentOptions = vnode.type
  const {
    data,
    render,
    beforeCreate,
    created,
    beforeMount,
    mounted,
    beforeUpdate,
    updated
  } = componentOptions

  // åœ¨è¿™é‡Œè°ƒç”¨ beforeCreate() é’©å­
  beforeCreate && beforeCreate()

  const state = reactive(data())

  const instance = 
    state,
    isMounted: false,
    subTree: null
  }

  vnode.component = instance

  // åœ¨è¿™é‡Œè°ƒç”¨ created() é’©å­
  created && created.call(state)

  effect(() => {
    const subTree = render.call(state, state)

    if (!instance.isMounted) {
      // åœ¨è¿™é‡Œè°ƒç”¨ beforeMount() é’©å­
      beforeMount && beforeMount.call(state)

      patch(null, subTree, container, anchor)
      instance.isMounted = true

      // åœ¨è¿™é‡Œè°ƒç”¨ mounted() é’©å­
      mounted && mounted.call(state)
    } else {
      // åœ¨è¿™é‡Œè°ƒç”¨ beforeUpdate() é’©å­
      beforeUpdate && beforeUpdate.call(state)

      patch(vnode.subTree, subTree, container, anchor)

      // åœ¨è¿™é‡Œè°ƒç”¨ updated() é’©å­
      updated && updated.call(state)
    }

    vnode.subTree = subTree
  }, {
    scheduler: queueJob
  })
}
```

è¿™ä¹Ÿå°±æ˜¯ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„å®ç°åŸç†ã€‚ä½†å®é™…ä¸Šï¼Œç”±äºå¯èƒ½å­˜åœ¨å¤šä¸ªåŒæ ·çš„ç»„ä»¶ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œä¾‹å¦‚æ¥è‡ª mixins ä¸­çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬é€šå¸¸éœ€è¦å°†ç»„ä»¶ç”Ÿå‘½å‘¨æœŸé’©å­åºåˆ—åŒ–æˆä¸€ä¸ªæ•°ç»„ï¼Œä½†æ ¸å¿ƒåŸç†ä¸å˜ã€‚

## props ä¸ç»„ä»¶çš„è¢«åŠ¨æ›´æ–°

åœ¨è™šæ‹Ÿ DOM å±‚é¢ï¼Œç»„ä»¶çš„ props ä¸æ™®é€š HTML æ ‡ç­¾çš„å±æ€§å·®åˆ«ä¸å¤§ã€‚å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹æ¨¡æ¿ï¼š

```HTML
<MyComponent title="A Big Title" :other="val" />
```

è¿™æ®µæ¨¡æ¿å¯¹åº”çš„è™šæ‹Ÿ DOM æ˜¯ï¼š

```js
const vnode = {
	type: MyComponent,
  props: {
    title: 'A Big Title',
    other: this.val
  }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæ¨¡æ¿ä¸è™šæ‹Ÿ DOM å‡ ä¹æ˜¯â€œåŒæ„â€çš„ã€‚å¦å¤–ï¼Œåœ¨ç¼–å†™ç»„ä»¶æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ˜¾å¼åœ°æŒ‡å®šç»„ä»¶ä¼šæ¥æ”¶å“ªäº› props æ•°æ®ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š

```js
const MyComponent = {
  name: 'MyComponent',
  // ç»„ä»¶æ¥æ”¶åä¸º title çš„ propsï¼Œå¹¶ä¸”è¯¥ props çš„ç±»å‹ä¸º String
  props: {
    title: String
  },
  
  render () {
    return {
      type: 'div',
      children: `count is: ${this.title}` // è®¿é—® props æ•°æ®
    }
  }
}
```

æ‰€ä»¥ï¼Œå¯¹äºä¸€ä¸ªç»„ä»¶æ¥è¯´ï¼Œæœ‰ä¸¤éƒ¨åˆ†å…³äº props çš„å†…å®¹æˆ‘ä»¬éœ€è¦å…³å¿ƒï¼š

+ ä¸ºç»„ä»¶ä¼ é€’çš„ props æ•°æ®ï¼Œå³ç»„ä»¶çš„ `vnode.props` å¯¹è±¡ï¼›
+ ç»„ä»¶é€‰é¡¹å¯¹è±¡ä¸­å®šä¹‰çš„ props é€‰é¡¹ï¼Œå³ `MyComponent.props` å¯¹è±¡ã€‚

æˆ‘ä»¬éœ€è¦ç»“åˆè¿™ä¸¤ä¸ªé€‰é¡¹æ¥è§£æå‡ºç»„ä»¶åœ¨æ¸²æŸ“æ—¶éœ€è¦ç”¨åˆ°çš„ props æ•°æ®ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š

```js
function mountComponent (vnode, container, anchor) {
  const componentOptions = vnode.type
  const {
    data,
    render,
    beforeCreate,
    created,
    beforeMount,
    mounted,
    beforeUpdate,
    updated,
    props: propsOption
  } = componentOptions

  beforeCreate && beforeCreate()

  const state = reactive(data())
  // è°ƒç”¨ resolveProps() å‡½æ•°è§£æå‡ºæœ€ç»ˆçš„ props æ•°æ®ä¸ attrs æ•°æ®
  const [props, attrs] = resolveProps(propsOption, vnode.props)

  const instance = {
    state,
    // å°† props æ•°æ®åŒ…è£…ä¸ºæµ…å“åº”å¹¶å®šä¹‰åˆ°ç»„ä»¶å®ä¾‹ä¸Š
    props: shallowReactive(props),
    isMounted: false,
    subTree: null
  }

  vnode.component = instance

	// ...
}

function resolveProps (options, propsData) {
  const props = {}
  const attrs = {}

  for (const key in propsData) {
    if (key in options) {
      props[key] = propsData[key]
    } else {
      attrs[key] = propsData[key]
    }
  }

  return [props, attrs]
}
```

è¿™é‡Œéœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š

1. åœ¨ Vue.js 3 ä¸­ï¼Œæ²¡æœ‰å®šä¹‰åœ¨ `MyComponent.props` é€‰é¡¹ä¸­çš„ props æ•°æ®å°†å­˜å‚¨åˆ° attrs å¯¹è±¡ä¸­ï¼›
2. ä¸Šè¿°å®ç°ä¸­æ²¡æœ‰åŒ…å«é»˜è®¤å€¼ã€ç±»å‹æ ¡éªŒç­‰å†…å®¹çš„å¤„ç†ã€‚å®é™…ä¸Šï¼Œè¿™äº›å†…å®¹ä¹Ÿæ˜¯å›´ç»• `MyComponent.props` ä»¥åŠ `vnode.props` è¿™ä¸¤ä¸ªå¯¹è±¡å±•å¼€çš„ï¼Œå®ç°èµ·æ¥å¹¶ä¸å¤æ‚ã€‚

å¤„ç†å®Œ props æ•°æ®åï¼Œæˆ‘ä»¬å†æ¥è®¨è®ºå…³äº props æ•°æ®å˜åŒ–çš„é—®é¢˜ã€‚props æœ¬è´¨ä¸Šæ˜¯çˆ¶ç»„ä»¶çš„æ•°æ®ï¼Œå½“ props å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè§¦å‘çˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚å‡è®¾çˆ¶ç»„ä»¶çš„æ¨¡æ¿å¦‚ä¸‹ï¼š

```vue
<template>
	<MyComponent :title="title" />
</template>
```

å…¶ä¸­ï¼Œå“åº”å¼æ•°æ® title çš„åˆå§‹å€¼ä¸ºå­—ç¬¦ä¸² `'A Big Title'`ï¼Œå› æ­¤ï¼Œé¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œçˆ¶ç»„ä»¶çš„è™šæ‹Ÿ DOM ä¸ºï¼š

```js
// çˆ¶ç»„ä»¶è¦æ¸²æŸ“çš„å†…å®¹
const vnode = {
  type: MyComponent,
  props: {
    title: 'A Big Title'
  }
}
```

å½“å“åº”å¼æ•°æ® title å‘ç”Ÿå˜åŒ–æ—¶ï¼Œçˆ¶ç»„ä»¶çš„æ¸²æŸ“å‡½æ•°ä¼šé‡æ–°æ‰§è¡Œã€‚å‡è®¾ title å˜æˆäº† `'A Small Title'`ï¼Œé‚£ä¹ˆäº§ç”Ÿçš„æ–°è™šæ‹Ÿ DOM ä¸ºï¼š

```js
// çˆ¶ç»„ä»¶è¦æ¸²æŸ“çš„å†…å®¹
const vnode = {
  type: MyComponent,
  props: {
    title: 'A Small Title'
  }
}
```

æ¥ç€ï¼Œçˆ¶ç»„ä»¶ä¼šè¿›è¡Œæ›´æ–°ã€‚åœ¨æ›´æ–°çš„è¿‡ç¨‹ä¸­ï¼Œæ¸²æŸ“å™¨å‘ç°çˆ¶ç»„ä»¶çš„ subTree åŒ…å«ç»„ä»¶ç±»å‹çš„è™šæ‹ŸèŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨ `patchComponent()` å‡½æ•°å®Œæˆå­ç»„ä»¶çš„æ›´æ–°ï¼š

```js
function patch (n1, n2, container, anchor) {
  // ...
  if (typeof type === 'string') {
    // ...
  } else if (typeof type === 'object') {
    // å¦‚æœ n2.type æ˜¯å¯¹è±¡ï¼Œåˆ™å®ƒæè¿°çš„æ˜¯ç»„ä»¶
    if (!n1) {
      // æŒ‚è½½ç»„ä»¶
      mountComponent(n2, container, anchor)
    } else {
      // æ›´æ–°ç»„ä»¶
      patchComponent(n1, n2, anchor)
    }
  } else if (type === VNODE_TYPES.Text) {
    // ...
  } else if (type === VNODE_TYPES.Comment) {
    // ...
  } else if (type === VNODE_TYPES.Fragment) {
    // ...
  }
}
```

å…¶ä¸­ï¼Œ`patchComponent()` å‡½æ•°ç”¨æ¥å®Œæˆå­ç»„ä»¶çš„æ›´æ–°ã€‚æˆ‘ä»¬æŠŠç”±çˆ¶ç»„ä»¶è‡ªæ›´æ–°æ‰€å¼•èµ·çš„å­ç»„ä»¶æ›´æ–°å«**å­ç»„ä»¶çš„è¢«åŠ¨æ›´æ–°ã€‚**

å½“å­ç»„ä»¶å‘ç”Ÿè¢«åŠ¨æ›´æ–°æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯ï¼š

+ æ£€æµ‹å­ç»„ä»¶æ˜¯å¦çœŸçš„éœ€è¦æ›´æ–°ï¼Œå› ä¸ºå­ç»„ä»¶çš„ props å¯èƒ½æ˜¯ä¸å˜çš„ï¼›
+ å¦‚æœéœ€è¦æ›´æ–°ï¼Œåˆ™æ›´æ–°å­ç»„ä»¶çš„ propsã€slots ç­‰å†…å®¹ã€‚

`patchComponent()` å‡½æ•°çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š

```js
function patchComponent (n1, n2, container) {
  // è·å–ç»„ä»¶å®ä¾‹ï¼Œå³ n1.componentï¼ŒåŒæ—¶è®©æ–°çš„ç»„ä»¶è™šæ‹ŸèŠ‚ç‚¹ä¹ŸæŒ‡å‘ç»„ä»¶å®ä¾‹
  const instance = (n2.component = n1.component)
  // è·å–å½“å‰çš„ props æ•°æ®
  const { props } = instance
  // è°ƒç”¨ hasPropsChanged() æ£€æµ‹å­ç»„ä»¶ä¼ é€’çš„ props æ˜¯å¦å‘ç”Ÿå˜åŒ–
  if (hasPropsChanged(n1.props, n2.props)) {
    // è°ƒç”¨ resolveProps å‡½æ•°é‡æ–°è·å– props
    const [nextProps] = resolveProps(n2.type.props, n2.props)
    // æ›´æ–° props
    for (const k in nextProps) {
      props[k] = nextProps[k]
    }
    // åˆ é™¤ä¸å­˜åœ¨çš„ props
    for (const k in props) {
      if (!k in nextProps) delete props[k]
    }
  }
}

function hasPropsChanged (prevProps, nextProps) {
  const nextKeys = Object.keys(nextProps)
  // å¦‚æœæ–°æ—§ props çš„æ•°é‡å˜äº†ï¼Œåˆ™è¯´æ˜æœ‰å˜åŒ–
  if (nextKeys.length !== Object.keys(prevProps).length) {
    return true
  }

  for (let i = 0; i < nextKeys.length; i++) {
    const key = nextKeys[i]
    // åªæœ‰ä¸ç›¸ç­‰çš„ propsï¼Œåˆ™è¯´æ˜æœ‰å˜åŒ–
    if (nextProps[key] !== prevProps[key]) return true
  }

  return false
}
```

ä¸Šé¢æ˜¯ç»„ä»¶è¢«åŠ¨æ›´æ–°çš„æœ€å°å®ç°ï¼Œæœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ï¼š

1. éœ€è¦å°†ç»„ä»¶å®ä¾‹æ·»åŠ åˆ°æ–°çš„ç»„ä»¶ vnode å¯¹è±¡ä¸Šï¼Œå³ `n2.component = n1.component`ï¼Œå¦åˆ™ä¸‹æ¬¡æ›´æ–°æ—¶å°†æ— æ³•å–å¾—å®ä¾‹ï¼›
2. `instance.props` å¯¹è±¡æœ¬èº«æ˜¯æµ…å“åº”çš„ã€‚å› æ­¤ï¼Œåœ¨æ›´æ–°ç»„ä»¶çš„ props æ—¶ï¼Œåªéœ€è¦è®¾ç½® `instance.props` å¯¹è±¡ä¸‹çš„å±æ€§å€¼å³å¯è§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚

åœ¨ä¸Šé¢çš„å®ç°ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰å¤„ç† attrs å’Œ slots çš„æ›´æ–°ã€‚attrs çš„æ›´æ–°æœ¬è´¨ä¸Šä¸æ›´æ–° props çš„åŸç†ç›¸ä¼¼ã€‚è€Œå¯¹äº slotsï¼Œæˆ‘ä»¬ä¼šåœ¨åç»­è¿›è¡Œè®²è§£ã€‚

å®é™…ä¸Šï¼Œè¦å®Œå–„åœ°å®ç° Vue.js ä¸­çš„ props æœºåˆ¶ï¼Œéœ€è¦ç¼–å†™å¤§é‡è¾¹ç•Œä»£ç ã€‚ä½†æœ¬è´¨ä¸Šæ¥è¯´ï¼Œå…¶åŸç†éƒ½æ˜¯æ ¹æ®ç»„ä»¶çš„ props é€‰é¡¹å®šä¹‰ä»¥åŠä¸ºç»„ä»¶ä¼ é€’çš„ props æ¥å¤„ç†çš„ã€‚

ç”±äº props æ•°æ®ä¸ç»„ä»¶è‡ªèº«çš„çŠ¶æ€æ•°æ®éƒ½éœ€è¦æš´éœ²åˆ°æ¸²æŸ“å‡½æ•°ä¸­ï¼Œå¹¶ä½¿å¾—æ¸²æŸ“å‡½æ•°èƒ½å¤Ÿé€šè¿‡ this è®¿é—®å®ƒä»¬ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°è£…ä¸€ä¸ªæ¸²æŸ“ä¸Šä¸‹æ–‡å¯¹è±¡ï¼š

```js
function mountComponent (vnode, container, anchor) {
  // ...

  const instance = {
    state,
    props: shallowReactive(props),
    isMounted: false,
    subTree: null
  }

  vnode.component = instance

  // åˆ›å»ºæ¸²æŸ“ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œæœ¬è´¨ä¸Šæ˜¯ç»„ä»¶å®ä¾‹çš„ä»£ç†
  const renderContext = new Proxy(instance, {
    get (t, k, r) {
      const { state, props } = t
      // å…ˆå°è¯•è¯»å–è‡ªèº«çŠ¶æ€æ•°æ®
      if (state && k in state) {
        return state[k]
      } else if (k in props) { // å¦‚æœç»„ä»¶è‡ªèº«æ²¡æœ‰è¯¥æ•°æ®ï¼Œåˆ™å°è¯•ä» props ä¸­è¯»å–
        return props[k]
      } else {
        console.error('ä¸å­˜åœ¨')
      }
    },

    set (t, k, v, r) {
      const { state, props } = t
      if (state && k in state) {
        state[k] = v
      } else if (k in props) {
        props[k] = v
      } else {
        console.error('ä¸å­˜åœ¨')
      }
    }
  })

  // åœ¨è¿™é‡Œè°ƒç”¨ created() é’©å­
  // ç”Ÿå‘½å‘¨æœŸå‡½æ•°è°ƒç”¨æ—¶éœ€è¦ç»‘å®šæ¸²æŸ“ä¸Šä¸‹æ–‡
  created && created.call(renderContext)

  // ...
}
```

å®é™…ä¸Šï¼Œé™¤äº†ç»„ä»¶è‡ªèº«çš„æ•°æ®ä»¥åŠ props æ•°æ®ä¹‹å¤–ï¼Œå®Œæ•´çš„ç»„ä»¶è¿˜åŒ…å« methodsã€computed ç­‰é€‰é¡¹ä¸­å®šä¹‰çš„æ•°æ®å’Œæ–¹æ³•ï¼Œè¿™äº›å†…å®¹éƒ½åº”è¯¥åœ¨æ¸²æŸ“ä¸Šä¸‹æ–‡ä¸­å¤„ç†ã€‚

## setup å‡½æ•°çš„ä½œç”¨ä¸å®ç°

ç»„ä»¶çš„ `setup()` å‡½æ•°æ˜¯ Vue.js 3 æ–°å¢çš„ç»„ä»¶é€‰é¡¹ï¼Œå®ƒæœ‰åˆ«äº Vue.js 2 ä¸­å­˜åœ¨çš„å…¶ä»–ç»„ä»¶é€‰é¡¹ã€‚è¿™æ˜¯å› ä¸º `setup()` å‡½æ•°ä¸»è¦ç”¨äºé…åˆç»„åˆå¼ APIï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªåœ°æ–¹ï¼Œç”¨äºå»ºç«‹ç»„åˆé€»è¾‘ã€åˆ›å»ºå“åº”å¼æ•°æ®ã€åˆ›å»ºé€šç”¨å‡½æ•°ã€æ³¨å†Œç”Ÿå‘½å‘¨æœŸé’©å­ç­‰èƒ½åŠ›ã€‚åœ¨ç»„ä»¶çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼Œ`setup()` å‡½æ•°åªä¼šåœ¨è¢«æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œå®ƒçš„è¿”å›å€¼å¯ä»¥æœ‰ä¸¤ç§æƒ…å†µï¼š

1. è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†ä½œä¸ºç»„ä»¶çš„ `render()` å‡½æ•°ï¼š

   ```js
   const Comp = {
     setup () {
       return () => {
         return { type: 'div', children: 'hello' }
       }
     }
   }
   ```

   è¿™ç§æ–¹å¼å¸¸ç”¨äºç»„ä»¶ä¸æ˜¯ä»¥æ¨¡æ¿æ¥è¡¨è¾¾å…¶æ¸²æŸ“å†…å®¹çš„æƒ…å†µã€‚å¦‚æœç»„ä»¶ä»¥æ¨¡æ¿æ¥è¡¨è¾¾å…¶æ¸²æŸ“çš„å†…å®¹ï¼Œé‚£ä¹ˆ `setup()` å‡½æ•°ä¸å¯ä»¥å†è¿”å›å‡½æ•°ï¼Œå¦åˆ™ä¼šä¸æ¨¡æ¿ç¼–è¯‘ç”Ÿæˆçš„æ¸²æŸ“å‡½æ•°äº§ç”Ÿå†²çªã€‚

2. è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«çš„æ•°æ®å°†æš´éœ²ç»™æ¨¡æ¿ä½¿ç”¨ï¼š

   ```js
   const Comp = {
     setup () {
       const count = ref(0)
       return {
         count
       }
     },
     render () {
       return {
         type: 'div',
         children: `count is: ${this.count}`
       }
     }
   }
   ```

   å¯ä»¥çœ‹åˆ°ï¼Œ`setup()` å‡½æ•°æš´éœ²çš„æ•°æ®å¯ä»¥åœ¨æ¸²æŸ“å‡½æ•°ä¸­é€šè¿‡ this æ¥è®¿é—®ã€‚

å¦å¤–ï¼Œ`setup()` å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ props æ•°æ®å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé€šå¸¸ç§°ä¸º `setupContext`ï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼š

```js
const Comp = {
  setup (props, setupContext) {
    props.foo // è®¿é—®ä¼ å…¥çš„ props æ•°æ®
    // setupContext ä¸­åŒ…å«ä¸ç»„ä»¶æ¥å£ç›¸å…³çš„é‡è¦æ•°æ®
    const { slots, emit, attrs, expose } = setupContext
    // ...
  }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `setup()` å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å–å¾—å¤–éƒ¨ä¸ºç»„ä»¶ä¼ é€’çš„ props æ•°æ®å¯¹è±¡ã€‚åŒæ—¶ï¼Œ`setup()` å‡½æ•°è¿˜æ¥æ”¶ç¬¬äºŒä¸ªå‚æ•° setupContext å¯¹è±¡ï¼Œå…¶ä¸­ä¿å­˜ç€ä¸ç»„ä»¶æ¥å£ç›¸å…³çš„æ•°æ®å’Œæ–¹æ³•ï¼š

+ slotsï¼šç»„ä»¶æ¥æ”¶åˆ°çš„æ’æ§½ï¼›
+ emitï¼šä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥å‘å°„è‡ªå®šä¹‰äº‹ä»¶ï¼›
+ attrsï¼šé‚£äº›æ²¡æœ‰æ˜¾å¼åœ°å£°æ˜ä¸º props çš„å±æ€§ï¼›
+ exposeï¼šä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæ˜¾å¼åœ°å¯¹å¤–æš´éœ²ç»„ä»¶æ•°æ®ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸å»ºè®®å°† `setup()` ä¸ Vue.js 2 ä¸­å…¶ä»–ç»„ä»¶é€‰é¡¹æ··åˆä½¿ç”¨ã€‚ä¾‹å¦‚ï¼šdataã€watchã€methods ç­‰é€‰é¡¹ï¼Œæˆ‘ä»¬ç§°ä¸ºä¹‹â€œä¼ ç»Ÿâ€ç»„ä»¶é€‰é¡¹ã€‚è¿™æ˜¯å› ä¸ºåœ¨ Vue.js 3 çš„åœºæ™¯ä¸‹ï¼Œæ›´åŠ æå€¡ç»„åˆå¼ APIï¼Œ`setup()` å‡½æ•°å°±æ˜¯ä¸ºç»„åˆå¼ API è€Œç”Ÿçš„ã€‚æ··ç”¨ç»„åˆå¼ API ä¸â€œä¼ ç»Ÿâ€é€‰é¡¹å¹¶ä¸æ˜¯æ˜æ™ºçš„é€‰æ‹©ï¼Œå› ä¸ºè¿™æ ·ä¼šå¸¦æ¥è¯­ä¹‰å’Œç†è§£ä¸Šçš„è´Ÿæ‹…ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å›´ç»•ä¸Šè¿°çš„è¿™äº›èƒ½åŠ›æ¥å°è¯•å®ç° `setup` ç»„ä»¶é€‰é¡¹ï¼š

```js
function mountComponent (vnode, container, anchor) {
  const componentOptions = vnode.type
  const {
    data,
    render,
    beforeCreate,
    created,
    beforeMount,
    mounted,
    beforeUpdate,
    updated,
    props: propsOption,
    setup // å–å‡º setup() å‡½æ•°
  } = componentOptions

  beforeCreate && beforeCreate()

  const state = data ? reactive(data()) : null
  const [props, attrs] = resolveProps(propsOption, vnode.props)

  const instance = {
    state,
    props: shallowReactive(props),
    isMounted: false,
    subTree: null
  }

  // setupContextï¼Œç”±äºæˆ‘ä»¬è¿˜æ²¡æœ‰è®²è§£ emit å’Œ slotsï¼Œæ‰€ä»¥æš‚æ—¶åªéœ€è¦ attrs
  const setupContext = { attrs }

  // è°ƒç”¨ setup() å‡½æ•°ï¼Œå°†åªè¯»çš„ props ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ï¼Œé¿å…ç”¨æˆ·æ„å¤–åœ°ä¿®æ”¹ props çš„å€¼ï¼Œ
  // å°† setupContext ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ é€’
  const setupResult = setup(shallowReadonly(instance.props), setupContext)
  // setupState ç”¨æ¥å­˜å‚¨ç”± setup() è¿”å›çš„æ•°æ®
  let setupState = null

  if (typeof setupResult === 'function') {
    // æŠ¥å‘Šå†²çª
    if (render) console.error('setup å‡½æ•°è¿”å›æ¸²æŸ“å‡½æ•°ï¼Œrender é€‰é¡¹å°†è¢«å¿½ç•¥')
    // å°† setupResult ä½œä¸ºæ¸²æŸ“å‡½æ•°
    render = setupResult
  } else {
    // å¦‚æœè¿”å›çš„ä¸æ˜¯å‡½æ•°ï¼Œåˆ™ä½œä¸ºæ•°æ®çŠ¶æ€èµ‹å€¼ç»™ setupState
    setupState = setupResult
  }

  vnode.component = instance

  const renderContext = new Proxy(instance, {
    get (t, k, r) {
      const { state, props } = t
      if (state && k in state) {
        return state[k]
      } else if (k in props) {
        return props[k]
      } else if (setupState && k in setupState) {
        // æ¸²æŸ“ä¸Šä¸‹æ–‡éœ€è¦å¢åŠ å¯¹ setupState çš„æ”¯æŒ
        return setupState[k]
      } else {
        console.error('ä¸å­˜åœ¨')
      }
    },

    set (t, k, v, r) {
      const { state, props } = t
      if (state && k in state) {
        state[k] = v
      } else if (k in props) {
        props[k] = v
      } else if (k in setupState) {
        // æ¸²æŸ“ä¸Šä¸‹æ–‡éœ€è¦å¢åŠ å¯¹ setupState çš„æ”¯æŒ
        setupState[k] = v
      } else {
        console.error('ä¸å­˜åœ¨')
      }
    }
  })
	// ...
}
```

ä¸Šé¢æ˜¯ `setup()` å‡½æ•°çš„æœ€å°å®ç°ï¼Œè¿™é‡Œæœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š

+ setupContext æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”±äºæˆ‘ä»¬è¿˜æ²¡æœ‰è®²è§£å…³äº emit å’Œ slots çš„å†…å®¹ï¼Œå› æ­¤ setupContext æš‚æ—¶åªåŒ…å« attrsï¼›
+ æˆ‘ä»¬é€šè¿‡æ£€æµ‹ `setup()` å‡½æ•°çš„è¿”å›å€¼ç±»å‹æ¥å†³å®šåº”è¯¥å¦‚ä½•å¤„ç†å®ƒã€‚å¦‚æœå®ƒçš„è¿”å›å€¼ä¸ºå‡½æ•°ï¼Œåˆ™ç›´æ¥å°†å…¶ä½œä¸ºç»„ä»¶çš„æ¸²æŸ“å‡½æ•°ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸ºäº†é¿å…äº§ç”Ÿæ­§ä¹‰ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥ç»„ä»¶é€‰é¡¹ä¸­æ˜¯å¦å·²ç»å­˜åœ¨ render é€‰é¡¹ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™éœ€è¦æ‰“å°è­¦å‘Šä¿¡æ¯ï¼›
+ æ¸²æŸ“ä¸Šä¸‹æ–‡ renderContext åº”è¯¥æ­£ç¡®åœ°å¤„ç† setupStateï¼Œå› ä¸º `setup()` å‡½æ•°è¿”å›çš„æ•°æ®çŠ¶æ€ä¹Ÿåº”è¯¥æš´éœ²åˆ°æ¸²æŸ“ç¯å¢ƒã€‚

## ç»„ä»¶äº‹ä»¶ä¸ emit çš„å®ç°

emit ç”¨æ¥å‘å°„ç»„ä»¶çš„è‡ªå®šä¹‰äº‹ä»¶ï¼š

```js
const myComponent = {
  name: 'MyComponent',
  setup (props, { emit }) {
    emit('change', 1, 2)
    
    return () => {
      return // ...
    }
  }
}
```

å½“ä½¿ç”¨è¯¥ç»„ä»¶æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘å¬ç”± `emit()` å‡½æ•°å‘å°„çš„è‡ªå®šä¹‰äº‹ä»¶ï¼š

```html
<MyComponent @change="handler" />
```

ä¸Šé¢è¿™æ®µæ¨¡æ¿å¯¹åº”çš„è™šæ‹Ÿ DOM ä¸ºï¼š

```js
const CompVNode = {
  type: MyComponent,
  props: {
    onChange: handler
  }
}
```

å¯ä»¥çœ‹åˆ°ï¼Œè‡ªå®šä¹‰äº‹ä»¶ change è¢«ç¼–è¯‘æˆåä¸º onChange çš„å±æ€§ï¼Œå¹¶å­˜å‚¨åœ¨ props æ•°æ®å¯¹è±¡ä¸­ã€‚è¿™å®é™…ä¸Šæ˜¯ä¸€ç§çº¦å®šã€‚

åœ¨å…·ä½“çš„å®ç°ä¸Šï¼Œå‘å°„è‡ªå®šä¹‰äº‹ä»¶çš„æœ¬è´¨å°±æ˜¯æ ¹æ®äº‹ä»¶åç§°å» props æ•°æ®å¯¹è±¡ä¸­å¯»æ‰¾å¯¹åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°å¹¶æ‰§è¡Œï¼š

```js
function mountComponent (vnode, container, anchor) {
  // ...
  const instance = {
    state,
    props: shallowReactive(props),
    isMounted: false,
    subTree: null
  }

  // å®šä¹‰ emit() å‡½æ•°
  function emit (event, ...payload) {
    // æ ¹æ®çº¦å®šå¯¹äº‹ä»¶åç§°è¿›è¡Œå¤„ç†ï¼Œä¾‹å¦‚ change --> onChange
    // event[0] => 'change'[0] => 'c'
    const eventName = `on${event[0].toUpperCase() + event.slice(1)}`
    // æ ¹æ®å¤„ç†åçš„äº‹ä»¶åç§°å» props ä¸­å¯»æ‰¾å¯¹åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°
    const handler = instance.props[eventName]
    if (handler) {
      handler(...payload)
    } else {
      console.error('äº‹ä»¶ä¸å­˜åœ¨')
    }
  }

  // setupContext
  const setupContext = { attrs, emit }

  // ...
}
```

è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦é¢å¤–æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨è®²è§£ props æ—¶æåˆ°ï¼Œä»»ä½•æ²¡æœ‰æ˜¾å¼åœ°å£°æ˜ä¸º props çš„å±æ€§éƒ½ä¼šå­˜å‚¨åˆ° attrs ä¸­ã€‚æ¢å¥è¯è¯´ï¼Œä»»ä½•äº‹ä»¶ç±»å‹çš„ propsï¼Œå³ `onXxxx` ç±»çš„å±æ€§ï¼Œéƒ½ä¸ä¼šå‡ºç°åœ¨ props ä¸­ã€‚è¿™å¯¼è‡´æˆ‘ä»¬æ— æ³•æ ¹æ®äº‹ä»¶åç§°åœ¨ `instance.props` ä¸­æ‰¾åˆ°å¯¹åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è§£æ props æ—¶å¯¹äº‹ä»¶ç±»å‹çš„ props åšç‰¹æ®Šå¤„ç†ï¼š

```js
function resolveProps (options, propsData) {
  const props = {}
  const attrs = {}

  for (const key in propsData) {
    // æ— è®ºæ˜¯æ˜¾å¼å£°æ˜ï¼Œè¿˜æ˜¯ä»¥ on å¼€å¤´çš„ propï¼Œéƒ½å°†å…¶æ·»åŠ åˆ° props æ•°æ®ä¸­
    if (key in options || key.startsWith('on')) {
      props[key] = propsData[key]
    } else {
      attrs[key] = propsData[key]
    }
  }

  return [props, attrs]
}
```

## æ’æ§½çš„å·¥ä½œåŸç†ä¸å®ç°

é¡¾åæ€ä¹‰ï¼Œç»„ä»¶çš„æ’æ§½æŒ‡ç»„ä»¶ä¼šé¢„ç•™ä¸€ä¸ªæ§½ä½ï¼Œè¯¥æ§½ä½å…·ä½“è¦æ¸²æŸ“çš„å†…å®¹ç”±ç”¨æˆ·æ’å…¥ï¼Œå¦‚ä¸‹é¢ç»™å‡ºçš„ MyComponent ç»„ä»¶çš„æ¨¡æ¿æ‰€ç¤ºï¼š

```vue
<template>
	<header>
  	<slot name="header" />
  </header>
	<div>
  	<slot name="content" />
  </header>
	<footer>
  	<slot name="footer" />
  </header>
</template>
```

å½“åœ¨çˆ¶ç»„ä»¶ä¸­ä½¿ç”¨ `<MyComponent>` ç»„ä»¶æ—¶ï¼Œå¯ä»¥æ ¹æ®æ’æ§½çš„åå­—æ¥æ’å…¥è‡ªå®šä¹‰çš„å†…å®¹ï¼š

```vue
<template>
	<template #header>
  	<h1>æˆ‘æ˜¯æ ‡é¢˜</h1>
  </template>
	<template #content>
  	<section>æˆ‘æ˜¯å†…å®¹</section>
  </template>
	<template #footer>
  	<p>æˆ‘æ˜¯æ³¨è„š</p>
  </template>
</template>
```

ä¸Šé¢è¿™æ®µçˆ¶ç»„ä»¶çš„æ¨¡æ¿ä¼šè¢«ç¼–è¯‘æˆå¦‚ä¸‹æ¸²æŸ“å‡½æ•°ï¼š

```js
// çˆ¶ç»„ä»¶çš„æ¸²æŸ“å‡½æ•°
function render () {
  return {
    type: MyComponent,
    // ç»„ä»¶çš„ children ä¼šè¢«ç¼–è¯‘æˆä¸€ä¸ªå¯¹è±¡
    children: {
      header () {
        return { type: 'h1', children: 'æˆ‘æ˜¯æ ‡é¢˜' }
      },
      content () {
        return { type: 'section', children: 'æˆ‘æ˜¯å†…å®¹' }
      },
      footer () {
        return { type: 'p', children: 'æˆ‘æ˜¯æ³¨è„š' }
      }
    }
  }
}
```

è€Œç»„ä»¶ MyComponent çš„æ¨¡æ¿åˆ™ä¼šç¼–è¯‘æˆå¦‚ä¸‹çš„æ¸²æŸ“å‡½æ•°ï¼š

```js
// MyComponent ç»„ä»¶æ¨¡æ¿çš„æ¸²æŸ“å‡½æ•°
function render () {
  return [
    {
      type: 'header',
      children: [this.$slots.header()]
    },
    {
      type: 'content',
      children: [this.$slots.content()]
    },
    {
      type: 'footer',
      children: [this.$slots.footer()]
    }
  ]
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæ¸²æŸ“æ’æ§½å†…å®¹çš„è¿‡ç¨‹ï¼Œå°±æ˜¯è°ƒç”¨æ’æ§½å‡½æ•°å¹¶æ¸²æŸ“ç”±å…¶è¿”å›çš„å†…å®¹çš„è¿‡ç¨‹ã€‚è¿™ä¸ React ä¸­çš„ render props çš„æ¦‚å¿µéå¸¸ç›¸ä¼¼ã€‚

åœ¨è¿è¡Œæ—¶çš„å®ç°ä¸Šï¼Œæ’æ§½åˆ™ä¾èµ–äº setupContent ä¸­çš„ slots å¯¹è±¡ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š

```js
function mountComponent (vnode, container, anchor) {
  // ...
  // ç›´æ¥ä½¿ç”¨ç¼–è¯‘å¥½çš„ vnode.children å¯¹è±¡ä½œä¸º slots å¯¹è±¡å³å¯
  const slots = vnode.children || {}

  // setupContext
  const setupContext = { attrs, emit, slots }
  // ...
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæœ€åŸºæœ¬çš„ slots çš„å®ç°éå¸¸ç®€å•ã€‚ä¸ºäº†åœ¨ `render()` å‡½æ•°å†…å’Œç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°å†…èƒ½å¤Ÿé€šè¿‡ `this.$slots` æ¥è®¿é—®æ’æ§½å†…å®¹ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ renderContext ä¸­ç‰¹æ®Šå¯¹å¾… $slots å±æ€§ï¼š

```js
function mountComponent (vnode, container, anchor) {
  // ...

  // ç›´æ¥ä½¿ç”¨ç¼–è¯‘å¥½çš„ vnode.children å¯¹è±¡ä½œä¸º slots å¯¹è±¡å³å¯
  const slots = vnode.children || {}

  const instance = {
    state,
    props: shallowReactive(props),
    isMounted: false,
    subTree: null,
    // å°†æ’æ§½æ·»åŠ åˆ°ç»„ä»¶å®ä¾‹ä¸Š
    slots
  }

  // ...

  // setupContext
  const setupContext = { attrs, emit, slots }

  // ...

  // åˆ›å»ºæ¸²æŸ“ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œæœ¬è´¨ä¸Šæ˜¯ç»„ä»¶å®ä¾‹çš„ä»£ç†
  const renderContext = new Proxy(instance, {
    get (t, k, r) {
      const { state, props, slots } = t

      // å½“ k å€¼ä¸º $slots æ—¶ï¼Œç›´æ¥è¿”å› slots
      if (k === '$slots') return slots

      // ...
    },

    set (t, k, v, r) {
      // ...
    }
  })

  // ...
}
```

## æ³¨å†Œç”Ÿå‘½å‘¨æœŸ

åœ¨ Vue.js 3 ä¸­ï¼Œæœ‰ä¸€éƒ¨åˆ†ç»„ä»¶å¼ API æ˜¯ç”¨æ¥æ³¨å†Œç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°çš„ï¼Œä¾‹å¦‚ï¼š`onMounted()`ã€`onUpdated()` ç­‰ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š

```js
import { onMounted } from 'vue'

const MyComponent = {
  setup () {
    onMounted(() => {
      console.log('mounted 1')
    })
    // å¯ä»¥æ³¨å†Œå¤šä¸ª
    onMounted(() => {
      console.log('mounted 2')
    })
  }
}
```

è¿™é‡Œçš„ç–‘é—®åœ¨çƒåœºï¼Œåœ¨ A ç»„ä»¶çš„ `setup()` å‡½æ•°ä¸­è°ƒç”¨ `onMounted()` å‡½æ•°ä¼šå°†è¯¥é’©å­æ³¨å†Œåˆ° A ç»„ä»¶ä¸Šï¼›è€Œåœ¨ B ç»„ä»¶çš„ `setup()` å‡½æ•°ä¸­è°ƒç”¨ `onMounted()` å‡½æ•°ä¼šå°†è¯¥é’©å­æ³¨å†Œåˆ° B ç»„ä»¶ä¸Šï¼Œè¿™æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ

å®é™…ä¸Šï¼Œæˆ‘ä»¬éœ€è¦ç»´æŠ¤ä¸€ä¸ªå˜é‡ currentInstanceï¼Œç”¨å®ƒæ¥å­˜å‚¨å½“å‰ç»„ä»¶å®ä¾‹ï¼Œæ¯å½“åˆå§‹åŒ–ç»„ä»¶å¹¶æ‰§è¡Œç»„ä»¶çš„ `setup()` å‡½æ•°ä¹‹å‰ï¼Œå…ˆå°† currentInstance è®¾ç½®ä¸ºå½“å‰ç»„ä»¶å®ä¾‹ï¼Œå†æ‰§è¡Œç»„ä»¶çš„ `setup()` å‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ currentInstance æ¥è·å–å½“å‰æ­£åœ¨è¢«åˆå§‹åŒ–çš„ç»„ä»¶å®ä¾‹ï¼Œä»è€Œå°†é‚£äº›é€šè¿‡ `onMounted()` å‡½æ•°æ³¨å†Œçš„é’©å­å‡½æ•°ä¸ç»„ä»¶å®ä¾‹è¿›è¡Œå…³è”ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç€æ‰‹å®ç°ã€‚é¦–å…ˆéœ€è¦è®¾è®¡ä¸€ä¸ªå½“å‰å®ä¾‹çš„ç»´æŠ¤æ–¹æ³•ï¼š

```js
// å…¨å±€å˜é‡ï¼Œå­˜å‚¨å½“å‰å­˜åœ¨è¢«åˆå§‹åŒ–çš„å®ä¾‹
let currentInstance = null

function setCurrentInstance (instance) {
  currentInstance = instance
}
```

æœ‰äº† currentInstance å˜é‡ï¼Œä»¥åŠç”¨æ¥è®¾ç½®è¯¥å˜é‡çš„ `setCurrentInstance()` å‡½æ•°ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç€æ‰‹ä¿®æ”¹ `mounteComponent()` å‡½æ•°äº†ï¼š

```js
function mountComponent (vnode, container, anchor) {
  // ...

  const instance = {
    state,
    props: shallowReactive(props),
    isMounted: false,
    subTree: null,
    slots,
    // åœ¨ç»„ä»¶å®ä¾‹ä¸­æ·»åŠ  mounted æ•°ç»„ï¼Œç”¨æ¥å­˜å‚¨é€šè¿‡ onMounted() å‡½æ•°æ³¨å†Œçš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°
    mounted: []
  }

  // ...

  // setupContext
  const setupContext = { attrs, emit, slots }

  // åœ¨è°ƒç”¨ setup() å‡½æ•°ä¹‹å‰ï¼Œè®¾ç½®å½“å‰ç»„ä»¶å®ä¾‹
  setCurrentInstance(instance)

  const setupResult = setup(shallowReadonly(instance.props), setupContext)

  // åœ¨è°ƒç”¨ setup() å‡½æ•°ä¹‹åï¼Œé‡ç½®å½“å‰ç»„ä»¶å®ä¾‹
  setCurrentInstance(null)

  let setupState = null

   // ...
}
```

ä¸ºäº†å­˜å‚¨ç”± `onMounted()` å‡½æ•°æ³¨å†Œçš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç»„ä»¶å®ä¾‹ä¸Šæ·»åŠ  `instance.mounted` æ•°ç»„ã€‚ä¹‹æ‰€ä»¥æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ˜¯å› ä¸ºåœ¨ `setup()` å‡½æ•°ä¸­ï¼Œå¯ä»¥å¤šæ¬¡è°ƒç”¨ `onMounted()` æ¥æ³¨å†Œä¸åŒçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œè¿™äº›ç”Ÿå‘½å‘¨æœŸå‡½æ•°éƒ½å°†å­˜å‚¨åœ¨ `instance.mounted` æ•°ç»„ä¸­ã€‚

ç°åœ¨ï¼Œç»„ä»¶å®ä¾‹çš„ç»´æŠ¤å·²ç»æå®šäº†ã€‚æ¥ä¸‹æ¥è€ƒè™‘ `onMounted()` æœ¬èº«çš„å®ç°ï¼š

```js
function onMounted (fn) {
  if (currentInstance) {
    // å°†ç”Ÿå‘½å‘¨æœŸå‡½æ•°æ·»åŠ åˆ° instance.mounted æ•°ç»„ä¸­
    currentInstance.mounted.push(fn)
  } else {
    console.error('onMounted å‡½æ•°åªèƒ½åœ¨ setup ä¸­è°ƒç”¨')
  }
}
```

æœ€åä¸€æ­¥éœ€è¦åšçš„æ˜¯ï¼Œåœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨è¿™äº›æ³¨å†Œåˆ° `instance.mounted` æ•°ç»„ä¸­çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼š

```js
function mountComponent (vnode, container, anchor) {
  // ...

  effect(() => {
    const subTree = render.call(renderContext, state)

    // æ£€æµ‹ç»„ä»¶æ˜¯å¦å·²ç»è¢«æŒ‚è½½
    if (!instance.isMounted) {
      // ...

      // åœ¨è¿™é‡Œè°ƒç”¨ mounted() é’©å­
      mounted && mounted.call(renderContext)
      // éå† instance.mounted æ•°ç»„ï¼Œå¹¶é€ä¸ªæ‰§è¡Œå³å¯
      instance.mounted && instance.mounted.forEach(hook => hook.call(renderContext))
    } else {
      // ...
    }

    // æ›´æ–°ç»„ä»¶å®ä¾‹çš„å­æ ‘
    instance.subTree = subTree
  }, {
    scheduler: queueJob
  })
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨åˆé€‚çš„æ—¶æœºéå† `instance.mounted` æ•°ç»„ï¼Œå¹¶é€ä¸ªæ‰§è¡Œè¯¥æ•°ç»„å†…çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°å³å¯ã€‚

å¯¹äºé™¤ `mounted` ä»¥å¤–çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œå…¶åŸç†åŒä¸Šã€‚

## ğŸš€ ç« èŠ‚é“¾æ¥

- ä¸Šä¸€ç« ï¼š[å¿«é€Ÿ Diff ç®—æ³•](https://github.com/humandetail/VueJS-design-and-implementation/blob/master/notes/10.%E5%BF%AB%E9%80%9F%20Diff%20%E7%AE%97%E6%B3%95.md)

- ä¸‹ä¸€ç« : [å¼‚æ­¥ç»„ä»¶å’Œå‡½æ•°å¼ç»„ä»¶](https://github.com/humandetail/VueJS-design-and-implementation/blob/master/notes/12.%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%E5%92%8C%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6.md)